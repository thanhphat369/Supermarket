<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
      xmlns:ui="jakarta.faces.facelets">

    <ui:composition template="/template.xhtml">

        <ui:define name="title">Order Management</ui:define>

        <ui:define name="content">
            <h1>üìã Order Management</h1>

            <h:messages globalOnly="true" />
            
            <!-- ========== SEARCH AND FILTER ========== -->
            <div class="search-section" style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);">
                <h:form id="searchForm">
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: nowrap;">
                        <div style="flex: 1; min-width: 0; position: relative; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h:inputText id="searchInput" 
                                       value="#{orderMBean.searchKeyword}" 
                                       styleClass="form-control search-input"
                                       style="width: 100%; padding: 14px 50px 14px 14px; border: none; border-radius: 12px; font-size: 15px; outline: none; background: transparent;">
                                <f:passThroughAttribute name="placeholder" value="üîç T√¨m ki·∫øm theo ID ƒë∆°n, t√™n kh√°ch h√†ng..." />
                                <f:ajax event="keyup" delay="300" listener="#{orderMBean.performSearch()}" render="orderListPanel paginationInfo" />
                            </h:inputText>
                            <h:commandButton value="‚úï" 
                                           actionListener="#{orderMBean.clearSearch()}"
                                           rendered="#{not empty orderMBean.searchKeyword}"
                                           styleClass="btn-clear-search"
                                           style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; padding: 0; background: #f0f0f0; border: none; color: #999; font-size: 16px; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s; font-weight: bold;"
                                           title="X√≥a t√¨m ki·∫øm"
                                           onmouseover="this.style.background='#e0e0e0'; this.style.color='#666';"
                                           onmouseout="this.style.background='#f0f0f0'; this.style.color='#999';">
                                <f:ajax render="searchForm orderListPanel paginationInfo" />
                            </h:commandButton>
                        </div>
                        <h:selectOneMenu value="#{orderMBean.statusFilter}" 
                                       styleClass="form-select" 
                                       style="min-width: 150px; padding: 14px; border-radius: 12px; border: none; background: white; font-size: 15px; outline: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; flex-shrink: 0;">
                            <f:selectItem itemValue="all" itemLabel="üìã T·∫•t c·∫£" />
                            <f:selectItem itemValue="pending" itemLabel="‚è≥ Pending" />
                            <f:selectItem itemValue="processing" itemLabel="üîÑ Processing" />
                            <f:selectItem itemValue="completed" itemLabel="‚úÖ Completed" />
                            <f:selectItem itemValue="cancelled" itemLabel="‚ùå Cancelled" />
                            <f:ajax event="change" listener="#{orderMBean.performSearch()}" render="orderListPanel paginationInfo" />
                        </h:selectOneMenu>
                        <h:commandButton value="üîç T√¨m ki·∫øm" 
                                       actionListener="#{orderMBean.performSearch()}"
                                       styleClass="btn-search-modern"
                                       style="padding: 14px 28px; font-size: 15px; font-weight: 600; border-radius: 12px; border: none; background: white; color: #667eea; box-shadow: 0 4px 12px rgba(255,255,255,0.3); transition: all 0.3s; cursor: pointer; white-space: nowrap; flex-shrink: 0;"
                                       onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(255,255,255,0.4)';"
                                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255,255,255,0.3)';">
                            <f:ajax render="orderListPanel paginationInfo" />
                        </h:commandButton>
                        <h:commandButton value="‚úï X√≥a" 
                                       actionListener="#{orderMBean.clearSearch()}"
                                       styleClass="btn-search-modern"
                                       rendered="#{not empty orderMBean.searchKeyword or (not empty orderMBean.statusFilter and orderMBean.statusFilter != 'all')}"
                                       style="padding: 14px 28px; font-size: 15px; font-weight: 600; border-radius: 12px; border: none; background: rgba(255,255,255,0.9); color: #dc3545; box-shadow: 0 4px 12px rgba(255,255,255,0.3); transition: all 0.3s; cursor: pointer; white-space: nowrap; flex-shrink: 0;"
                                       onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(255,255,255,0.4)';"
                                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255,255,255,0.3)';">
                            <f:ajax render="searchForm orderListPanel paginationInfo" />
                        </h:commandButton>
                    </div>
                    <h:outputText value="üìä T√¨m th·∫•y: #{orderMBean.totalItems} ƒë∆°n h√†ng" 
                                rendered="#{not empty orderMBean.searchKeyword or (not empty orderMBean.statusFilter and orderMBean.statusFilter != 'all')}"
                                style="display: block; margin-top: 12px; color: white; font-size: 14px; font-weight: 500; text-align: center; padding: 8px; background: rgba(255,255,255,0.2); border-radius: 8px;" />
                </h:form>
            </div>

            <!-- ========== ORDER LIST ========== -->
            <h:form id="orderForm">
                <!-- Bulk Actions Bar -->
                <h:panelGroup id="bulkActionsBar" layout="block" 
                              rendered="#{orderMBean.hasSelected()}"
                              style="margin-bottom: 15px; padding: 15px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-weight: 600; color: #856404;">
                            üìã ƒê√£ ch·ªçn: <strong>#{orderMBean.selectedCount}</strong> ƒë∆°n h√†ng
                        </span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                            <h:commandButton value="üóëÔ∏è X√≥a ƒë√£ ch·ªçn" 
                                       actionListener="#{orderMBean.deleteSelected()}"
                                       styleClass="btn btn-danger"
                                       style="padding: 10px 20px; font-weight: 600; border-radius: 6px; border: none; background: #dc3545; color: white; cursor: pointer; transition: all 0.3s;"
                                       onmouseover="this.style.background='#c82333'; this.style.transform='translateY(-2px)';"
                                       onmouseout="this.style.background='#dc3545'; this.style.transform='translateY(0)';"
                                       onclick="return confirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a #{orderMBean.selectedCount} ƒë∆°n h√†ng ƒë√£ ch·ªçn? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!');">
                            <f:ajax render="orderListPanel bulkActionsBar orderDetailsSection paginationInfo :messages" />
                        </h:commandButton>
                        <h:commandButton value="‚úï B·ªè ch·ªçn t·∫•t c·∫£" 
                                       actionListener="#{orderMBean.deselectAll()}"
                                       styleClass="btn btn-secondary"
                                       style="padding: 10px 20px; font-weight: 600; border-radius: 6px; border: none; background: #6c757d; color: white; cursor: pointer; transition: all 0.3s;"
                                       onmouseover="this.style.background='#5a6268'; this.style.transform='translateY(-2px)';"
                                       onmouseout="this.style.background='#6c757d'; this.style.transform='translateY(0)';">
                            <f:ajax render="orderListPanel bulkActionsBar :messages" />
                        </h:commandButton>
                    </div>
                </h:panelGroup>
                
                <!-- Select All / Deselect All Buttons -->
                <div style="margin-bottom: 10px; display: flex; gap: 8px; align-items: center;">
                    <h:commandButton value="‚òëÔ∏è Ch·ªçn t·∫•t c·∫£ trang n√†y" 
                                   actionListener="#{orderMBean.selectAll()}"
                                   styleClass="btn btn-sm btn-outline-primary"
                                   style="padding: 8px 16px; font-size: 13px; border-radius: 6px; border: 1px solid #007bff; background: white; color: #007bff; cursor: pointer; transition: all 0.3s;"
                                   onmouseover="this.style.background='#007bff'; this.style.color='white';"
                                   onmouseout="this.style.background='white'; this.style.color='#007bff';">
                        <f:ajax render="orderListPanel bulkActionsBar" />
                    </h:commandButton>
                    <h:commandButton value="‚òê B·ªè ch·ªçn t·∫•t c·∫£" 
                                   actionListener="#{orderMBean.deselectAll()}"
                                   styleClass="btn btn-sm btn-outline-secondary"
                                   style="padding: 8px 16px; font-size: 13px; border-radius: 6px; border: 1px solid #6c757d; background: white; color: #6c757d; cursor: pointer; transition: all 0.3s;"
                                   onmouseover="this.style.background='#6c757d'; this.style.color='white';"
                                   onmouseout="this.style.background='white'; this.style.color='#6c757d';">
                        <f:ajax render="orderListPanel bulkActionsBar" />
                    </h:commandButton>
                </div>
                
                <h:panelGroup id="orderListPanel" layout="block">
                    <h:outputText value="No orders found" 
                                 rendered="#{empty orderMBean.pagedItems}" 
                                 style="display: block; text-align: center; padding: 20px; color: #999; font-style: italic; background: #f5f5f5; border-radius: 8px; margin: 20px 0;" />
                    <h:dataTable value="#{orderMBean.pagedItems}" var="o" styleClass="table table-striped table-hover table-full-width table-margin-top"
                                 border="0"
                                 rendered="#{not empty orderMBean.pagedItems}">
                    <h:column>
                        <f:facet name="header">‚òëÔ∏è</f:facet>
                        <h:selectBooleanCheckbox value="#{orderMBean.selectionMap[o.orderID]}" 
                                                style="cursor: pointer; width: 18px; height: 18px;"
                                                valueChangeListener="#{orderMBean.toggleSelection}">
                            <f:attribute name="orderId" value="#{o.orderID}" />
                            <f:ajax event="valueChange" render="orderListPanel bulkActionsBar" />
                        </h:selectBooleanCheckbox>
                    </h:column>
                    <h:column>
                        <f:facet name="header">ID</f:facet>
                        #{o.orderID}
                    </h:column>
                    <h:column>
                        <f:facet name="header">Order Date</f:facet>
                        #{orderMBean.formatDate(o.orderDate)}
                    </h:column>
                    <h:column>
                        <f:facet name="header">Customer</f:facet>
                        #{o.userID != null ? (o.userID.fullName != null ? o.userID.fullName : o.userID.userName) : '-'}
                    </h:column>
                    <h:column>
                        <f:facet name="header">Total</f:facet>
                        #{orderMBean.formatAmount(o.totalAmount)}
                    </h:column>
                    <h:column>
                        <f:facet name="header">üí≥ Payment</f:facet>
                        <span style="padding: 4px 10px; border-radius: 12px; font-weight: 600; font-size: 12px; background: #{orderMBean.isCOD(o) ? '#fef3c7' : '#dbeafe'}; color: #{orderMBean.isCOD(o) ? '#92400e' : '#1e40af'};">
                            #{orderMBean.getPaymentMethodDisplay(o)}
                        </span>
                    </h:column>
                    <h:column>
                        <f:facet name="header">üìä Status</f:facet>
                        <h:outputText value="#{o.status}" 
                                     style="color: #{orderMBean.getStatusColor(o.status)}; font-weight: bold;" />
                    </h:column>
                    <h:column>
                        <f:facet name="header">üöö Shipper</f:facet>
                        <h:outputText value="#{orderMBean.getShipperForOrder(o) != null ? (orderMBean.getShipperForOrder(o).fullName != null ? orderMBean.getShipperForOrder(o).fullName : orderMBean.getShipperForOrder(o).userName) : 'Not Assigned'}" 
                                     style="color: #{orderMBean.getShipperForOrder(o) != null ? '#28a745' : '#999'}; font-weight: #{orderMBean.getShipperForOrder(o) != null ? 'bold' : 'normal'};" />
                    </h:column>
                    <h:column>
                        <f:facet name="header">üí∞ COD Status</f:facet>
                        <ui:fragment rendered="#{orderMBean.isCOD(o)}">
                            <ui:fragment rendered="#{orderMBean.isPaymentSubmitted(o)}">
                                <span style="padding: 4px 10px; border-radius: 12px; font-weight: 600; font-size: 12px; background: #d1fae5; color: #065f46;">
                                    ‚úÖ ƒê√£ n·ªôp
                                </span>
                            </ui:fragment>
                            <ui:fragment rendered="#{!orderMBean.isPaymentSubmitted(o) and o.status == 'completed'}">
                                <span style="padding: 4px 10px; border-radius: 12px; font-weight: 600; font-size: 12px; background: #fee2e2; color: #991b1b;">
                                    ‚ö†Ô∏è Ch∆∞a n·ªôp
                                </span>
                            </ui:fragment>
                            <ui:fragment rendered="#{o.status != 'completed'}">
                                <span style="padding: 4px 10px; border-radius: 12px; font-weight: 600; font-size: 12px; background: #f3f4f6; color: #6b7280;">
                                    ‚è≥ Ch·ªù giao
                                </span>
                            </ui:fragment>
                        </ui:fragment>
                        <ui:fragment rendered="#{!orderMBean.isCOD(o)}">
                            <span style="color: #9ca3af; font-size: 12px;">-</span>
                        </ui:fragment>
                    </h:column>
                    <h:column>
                        <f:facet name="header">‚ö° Actions</f:facet>
                        <div style="display: flex; gap: 6px; align-items: center; flex-wrap: nowrap;">
                            <h:commandButton value="üìã" 
                                           actionListener="#{orderMBean.viewDetails(o)}" 
                                           styleClass="btn btn-sm"
                                           style="padding: 6px 10px; font-size: 14px; border-radius: 6px; background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; cursor: pointer; transition: all 0.2s;"
                                           title="View Details"
                                           onmouseover="this.style.background='#bbdefb'; this.style.transform='scale(1.05)';"
                                           onmouseout="this.style.background='#e3f2fd'; this.style.transform='scale(1)';">
                                <f:ajax execute="@this" render="orderForm:orderDetailsSection :messages" />
                            </h:commandButton>
                            <h:selectOneMenu value="#{o.status}" 
                                           styleClass="form-select" 
                                           style="min-width: 110px; font-size: 12px; padding: 6px 8px; border-radius: 6px; border: 1px solid #ddd; background: white; cursor: pointer;">
                                <f:selectItem itemValue="pending" itemLabel="‚è≥ Pending" />
                                <f:selectItem itemValue="processing" itemLabel="üîÑ Processing" />
                                <f:selectItem itemValue="completed" itemLabel="‚úÖ Completed" />
                                <f:selectItem itemValue="cancelled" itemLabel="‚ùå Cancelled" />
                                <f:ajax event="change" listener="#{orderMBean.updateStatus(o)}" render="orderListPanel orderDetailsSection :messages" />
                            </h:selectOneMenu>
                            <h:commandButton value="üóëÔ∏è" 
                                           actionListener="#{orderMBean.delete(o)}" 
                                           styleClass="btn btn-sm"
                                           style="padding: 6px 10px; font-size: 14px; border-radius: 6px; background: #fee2e2; color: #dc3545; border: 1px solid #fecaca; cursor: pointer; transition: all 0.2s;"
                                           title="Delete Order"
                                           onclick="return confirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë∆°n h√†ng ##{o.orderID}? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!');"
                                           onmouseover="this.style.background='#fecaca'; this.style.transform='scale(1.05)';"
                                           onmouseout="this.style.background='#fee2e2'; this.style.transform='scale(1)';">
                                <f:ajax render="orderListPanel bulkActionsBar orderDetailsSection paginationInfo :messages" />
                            </h:commandButton>
                        </div>
                        <div style="margin-top: 4px; font-size: 11px; color: #6b7280;">
                            <ui:fragment rendered="#{orderMBean.getShipperForOrder(o) != null}">
                                üöö #{orderMBean.getShipperForOrder(o).fullName != null ? orderMBean.getShipperForOrder(o).fullName : orderMBean.getShipperForOrder(o).userName}
                            </ui:fragment>
                            <ui:fragment rendered="#{orderMBean.getShipperForOrder(o) == null}">
                                <span style="color: #9ca3af;">Not Assigned</span>
                            </ui:fragment>
                        </div>
                    </h:column>
                    </h:dataTable>
                    
                    <!-- ===== PH√ÇN TRANG ===== -->
                    <h:panelGroup id="paginationInfo" layout="block" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: block; width: 100%;">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                            <h:outputText value="Page #{orderMBean.currentPage} / #{orderMBean.totalPages} (Total: #{orderMBean.totalItems} orders)" 
                                         styleClass="pagination-info" 
                                         style="font-weight: 500; color: #333; font-size: 14px;" />
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <h:commandButton value="‚èÆÔ∏è First" actionListener="#{orderMBean.firstPage()}" 
                                               styleClass="btn btn-secondary" 
                                               disabled="#{orderMBean.currentPage == 1 or orderMBean.totalPages le 1}"
                                               style="min-width: 100px;">
                                    <f:ajax render="orderListPanel paginationInfo" />
                                </h:commandButton>
                                <h:commandButton value="‚óÄÔ∏è Prev" actionListener="#{orderMBean.previousPage()}" 
                                               styleClass="btn btn-secondary" 
                                               disabled="#{orderMBean.currentPage == 1 or orderMBean.totalPages le 1}"
                                               style="min-width: 80px;">
                                    <f:ajax render="orderListPanel paginationInfo" />
                                </h:commandButton>
                                <h:commandButton value="Next ‚ñ∂Ô∏è" actionListener="#{orderMBean.nextPage()}" 
                                               styleClass="btn btn-secondary" 
                                               disabled="#{orderMBean.currentPage == orderMBean.totalPages or orderMBean.totalPages le 1}"
                                               style="min-width: 80px;">
                                    <f:ajax render="orderListPanel paginationInfo" />
                                </h:commandButton>
                                <h:commandButton value="Last ‚è≠Ô∏è" actionListener="#{orderMBean.lastPage()}" 
                                               styleClass="btn btn-secondary" 
                                               disabled="#{orderMBean.currentPage == orderMBean.totalPages or orderMBean.totalPages le 1}"
                                               style="min-width: 100px;">
                                    <f:ajax render="orderListPanel paginationInfo" />
                                </h:commandButton>
                            </div>
                        </div>
                    </h:panelGroup>
                </h:panelGroup>

                <!-- ========== ORDER DETAILS ========== -->
                <h:panelGroup id="orderDetailsSection" layout="block" 
                              style="margin-top: 30px; #{orderMBean.selected == null ? 'display: none;' : 'display: block;'}">
                    <h:panelGroup rendered="#{orderMBean.selected != null}" layout="block">
                        <div class="form-section" style="background: #fff; border: 2px solid #3f72af;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2 style="margin: 0; color: #3f72af;">üìã Order Details ##{orderMBean.selected.orderID}</h2>
                                <h:commandButton value="‚úñ Close" actionListener="#{orderMBean.closeDetails}" styleClass="btn btn-secondary">
                                    <f:ajax render="orderForm:orderDetailsSection :messages" />
                                </h:commandButton>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <p><strong>Customer:</strong> #{orderMBean.selected.userID != null ? (orderMBean.selected.userID.fullName != null ? orderMBean.selected.userID.fullName : orderMBean.selected.userID.userName) : '-'}</p>
                            <p><strong>Order Date:</strong> #{orderMBean.formatDate(orderMBean.selected.orderDate)}</p>
                            
                            <!-- Order Summary with Shipping Fee -->
                            <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #ddd;">
                                <h4 style="margin: 0 0 12px 0; color: #3f72af;">üí∞ Order Summary</h4>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span><strong>Subtotal:</strong></span>
                                    <span>#{orderMBean.formatAmount(orderMBean.getSubtotal(orderMBean.selected))}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                                    <span><strong>üöö Shipping Fee:</strong></span>
                                    <span style="font-weight: 600; color: #3f72af;">
                                        #{orderMBean.formatAmount(orderMBean.selected.shippingFee != null ? orderMBean.selected.shippingFee : 0)}
                                    </span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-top: 12px; padding-top: 12px; border-top: 2px solid #3f72af; font-size: 18px; font-weight: bold; color: #3f72af;">
                                    <span>Total:</span>
                                    <span>#{orderMBean.formatAmount(orderMBean.selected.totalAmount)}</span>
                                </div>
                                <p style="font-size: 12px; color: #666; margin-top: 8px; margin-bottom: 0;">
                                    üí° Shipping fee is the income for the shipper who delivers this order.
                                </p>
                            </div>
                            
                            <p><strong>Status:</strong> 
                                <span style="color: #{orderMBean.getStatusColor(orderMBean.selected.status)}; font-weight: bold;">
                                    #{orderMBean.selected.status != null ? orderMBean.selected.status : '-'}
                                </span>
                            </p>
                            <p><strong>Payment Method:</strong> 
                                <span style="padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 13px; background: #{orderMBean.isCOD(orderMBean.selected) ? '#fef3c7' : '#dbeafe'}; color: #{orderMBean.isCOD(orderMBean.selected) ? '#92400e' : '#1e40af'};">
                                    #{orderMBean.getPaymentMethodDisplay(orderMBean.selected)}
                                </span>
                            </p>
                            <p><strong>Shipper:</strong> 
                                <span style="color: #{orderMBean.getShipperForOrder(orderMBean.selected) != null ? '#28a745' : '#999'}; font-weight: #{orderMBean.getShipperForOrder(orderMBean.selected) != null ? 'bold' : 'normal'};">
                                    #{orderMBean.getShipperForOrder(orderMBean.selected) != null ? (orderMBean.getShipperForOrder(orderMBean.selected).fullName != null ? orderMBean.getShipperForOrder(orderMBean.selected).fullName : orderMBean.getShipperForOrder(orderMBean.selected).userName) : 'Not Assigned'}
                                </span>
                            </p>
                            <!-- KH√ìA: Admin kh√¥ng ƒë∆∞·ª£c g√°n shipper. Shipper ph·∫£i t·ª± nh·∫≠n ƒë∆°n t·ª´ trang qu·∫£n l√Ω c·ªßa h·ªç -->
                        </div>
                        
                        <h3 style="color: #3f72af; margin-bottom: 15px;">Product List:</h3>
                        <h:dataTable value="#{orderMBean.selected.orderDetailsCollection}" var="od" 
                                     styleClass="table table-striped table-hover"
                                     rendered="#{orderMBean.selected.orderDetailsCollection != null and not empty orderMBean.selected.orderDetailsCollection}">
                            <h:column>
                                <f:facet name="header">ID</f:facet>
                                #{od.ODetailID != null ? od.ODetailID : '-'}
                            </h:column>
                            <h:column>
                                <f:facet name="header">Image</f:facet>
                                <div style="display: flex; justify-content: center; align-items: center;">
                                    <img src="#{productMBean.getImageUrlForProduct(od.productID)}"
                                         alt="#{od.productID != null and od.productID.name != null ? od.productID.name : 'Product'}"
                                         style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd; background-color: #f5f5f5;"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                    <div style="display: none; width: 60px; height: 60px; align-items: center; justify-content: center; color: #999; font-size: 24px; background: #f5f5f5; border-radius: 8px; border: 2px solid #ddd;">
                                        üì¶
                                    </div>
                                </div>
                            </h:column>
                            <h:column>
                                <f:facet name="header">Product</f:facet>
                                #{od.productID != null and od.productID.name != null ? od.productID.name : '-'}
                            </h:column>
                            <h:column>
                                <f:facet name="header">Quantity</f:facet>
                                #{od.quantity}
                            </h:column>
                            <h:column>
                                <f:facet name="header">Unit Price</f:facet>
                                #{orderMBean.formatAmount(od.unitPrice)}
                            </h:column>
                            <h:column>
                                <f:facet name="header">Subtotal</f:facet>
                                #{orderMBean.formatAmount(od.quantity * od.unitPrice)}
                            </h:column>
                            <h:column>
                                <f:facet name="header">Shipping Address</f:facet>
                                #{od.shipAddress != null ? od.shipAddress : '-'}
                            </h:column>
                        </h:dataTable>
                        <h:outputText value="No details found" 
                                     rendered="#{orderMBean.selected.orderDetailsCollection == null or empty orderMBean.selected.orderDetailsCollection}" 
                                     style="display: block; text-align: center; padding: 20px; color: #999; font-style: italic;" />
                        </div>
                    </h:panelGroup>
                </h:panelGroup>
            </h:form>

            <br/>
        </ui:define>
    </ui:composition>
    
    <style>
        .btn-clear-search:hover {
            background: #e0e0e0 !important;
            color: #667eea !important;
            transform: translateY(-50%) rotate(90deg) !important;
        }
        
        .btn-search-modern:hover {
            background: #f8f9fa !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255,255,255,0.4) !important;
        }
        
        .search-input:focus {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
    </style>
    
    <script type="text/javascript">
        <![CDATA[
        // Scroll to order details section after AJAX update
        (function() {
            if (typeof jsf !== 'undefined' && jsf.ajax) {
                jsf.ajax.addOnEvent(function(data) {
                    if (data.status === 'success') {
                        var source = data.source;
                        if (source && source.value && source.value.indexOf('Detail') !== -1) {
                            setTimeout(function() {
                                var section = document.getElementById('orderForm:orderDetailsSection');
                                if (section && section.offsetParent !== null) {
                                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }
                            }, 300);
                        }
                    }
                });
            }
        })();
        ]]>
    </script>
</html>

