<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:ui="jakarta.faces.facelets">

    <ui:composition template="/template.xhtml">
        <ui:define name="title">üìã My Orders</ui:define>

        <ui:define name="content">
            <h:messages id="messages" globalOnly="true" />
            
            <div style="padding: 20px;">
                <h1 style="color: #2f5061; margin-bottom: 20px;">üìã My Orders</h1>
                
                <h:panelGroup rendered="#{loginMBean.currentUser == null}">
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
                        <p style="font-size: 18px; color: #64748b; margin-bottom: 20px;">Please login to view your orders</p>
                        <h:link outcome="login" value="üîì Login" 
                                style="display: inline-block; padding: 12px 24px; background-color: #3f72af; color: white; text-decoration: none; border-radius: 6px; font-weight: 500;" />
                    </div>
                </h:panelGroup>
                
                <h:panelGroup rendered="#{loginMBean.currentUser != null}">
                    <h:form id="orderForm">
                        <!-- Search and Filter -->
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <h:inputText value="#{customerOrderMBean.searchKeyword}" 
                                           styleClass="form-control"
                                           style="flex: 1; min-width: 250px;">
                                    <f:passThroughAttribute name="placeholder" value="Search by Order ID or Username..." />
                                    <f:ajax event="keyup" delay="300" listener="#{customerOrderMBean.performSearch()}" render="orderTable paginationInfo" />
                                </h:inputText>
                                
                                <h:selectOneMenu value="#{customerOrderMBean.statusFilter}" styleClass="form-select" style="min-width: 150px;">
                                    <f:selectItem itemValue="all" itemLabel="All Status" />
                                    <f:selectItem itemValue="pending" itemLabel="Pending" />
                                    <f:selectItem itemValue="processing" itemLabel="Processing" />
                                    <f:selectItem itemValue="completed" itemLabel="Completed" />
                                    <f:selectItem itemValue="cancelled" itemLabel="Cancelled" />
                                    <f:ajax event="change" listener="#{customerOrderMBean.performSearch()}" render="orderTable paginationInfo" />
                                </h:selectOneMenu>
                                
                                <h:commandButton value="üîç Search" 
                                               actionListener="#{customerOrderMBean.performSearch()}"
                                               styleClass="btn btn-primary">
                                    <f:ajax render="orderTable paginationInfo" />
                                </h:commandButton>
                                
                                <h:commandButton value="‚úñ Clear" 
                                               actionListener="#{customerOrderMBean.clearSearch()}"
                                               rendered="#{not empty customerOrderMBean.searchKeyword or customerOrderMBean.statusFilter != 'all'}"
                                               styleClass="btn btn-secondary">
                                    <f:ajax render="orderForm" />
                                </h:commandButton>
                            </div>
                        </div>
                        
                        <!-- Orders Table -->
                        <div id="orderTable">
                            <h:outputText value="No orders found" 
                                         rendered="#{empty customerOrderMBean.pagedItems}" 
                                         style="display: block; text-align: center; padding: 40px; color: #999; font-style: italic; background: #f5f5f5; border-radius: 8px; margin: 20px 0;" />
                            
                            <h:dataTable value="#{customerOrderMBean.pagedItems}" var="o" 
                                       styleClass="table table-striped table-hover"
                                       style="width: 100%;"
                                       rendered="#{not empty customerOrderMBean.pagedItems}">
                                <h:column>
                                    <f:facet name="header">Order ID</f:facet>
                                    #<h:outputText value="#{o.orderID}" />
                                </h:column>
                                
                                <h:column>
                                    <f:facet name="header">Order Date</f:facet>
                                    #{customerOrderMBean.formatDate(o.orderDate)}
                                </h:column>
                                
                                <h:column>
                                    <f:facet name="header">Status</f:facet>
                                    <span style="padding: 5px 10px; border-radius: 4px; font-weight: bold; color: white; background-color: #{customerOrderMBean.getStatusColor(o.status)};">
                                        #{o.status}
                                    </span>
                                </h:column>
                                
                                <h:column>
                                    <f:facet name="header">Total Amount</f:facet>
                                    <strong>#{customerOrderMBean.formatAmount(o.totalAmount)}</strong>
                                </h:column>
                                
                                <h:column>
                                    <f:facet name="header">Action</f:facet>
                                    <h:commandButton value="üìã Detail" 
                                                   actionListener="#{customerOrderMBean.viewDetails(o)}"
                                                   styleClass="btn btn-primary btn-sm">
                                        <f:ajax execute="@this" render="orderForm:orderDetailsSection :messages" />
                                    </h:commandButton>
                                </h:column>
                            </h:dataTable>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="paginationInfo" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <h:outputText value="Page #{customerOrderMBean.currentPage} / #{customerOrderMBean.totalPages} (Total: #{customerOrderMBean.totalItems} orders)" 
                                         style="font-weight: 500; color: #333; font-size: 14px;" />
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <h:commandButton value="‚èÆÔ∏è First" actionListener="#{customerOrderMBean.firstPage()}" 
                                               styleClass="btn btn-secondary" 
                                               disabled="#{customerOrderMBean.currentPage == 1 or customerOrderMBean.totalPages le 1}">
                                    <f:ajax render="orderTable paginationInfo" />
                                </h:commandButton>
                                <h:commandButton value="‚óÄÔ∏è Previous" actionListener="#{customerOrderMBean.previousPage()}" 
                                               styleClass="btn btn-secondary" 
                                               disabled="#{customerOrderMBean.currentPage == 1 or customerOrderMBean.totalPages le 1}">
                                    <f:ajax render="orderTable paginationInfo" />
                                </h:commandButton>
                                <h:commandButton value="Next ‚ñ∂Ô∏è" actionListener="#{customerOrderMBean.nextPage()}" 
                                               styleClass="btn btn-secondary" 
                                               disabled="#{customerOrderMBean.currentPage == customerOrderMBean.totalPages or customerOrderMBean.totalPages le 1}">
                                    <f:ajax render="orderTable paginationInfo" />
                                </h:commandButton>
                                <h:commandButton value="Last ‚è≠Ô∏è" actionListener="#{customerOrderMBean.lastPage()}" 
                                               styleClass="btn btn-secondary" 
                                               disabled="#{customerOrderMBean.currentPage == customerOrderMBean.totalPages or customerOrderMBean.totalPages le 1}">
                                    <f:ajax render="orderTable paginationInfo" />
                                </h:commandButton>
                            </div>
                        </div>
                        
                        <!-- Order Details Section -->
                        <h:panelGroup id="orderDetailsSection" layout="block"
                                     style="margin-top: 30px; #{customerOrderMBean.showDetails and customerOrderMBean.selectedOrder != null ? '' : 'display: none;'}">
                            <h:panelGroup rendered="#{customerOrderMBean.showDetails and customerOrderMBean.selectedOrder != null}" layout="block">
                                <div style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow: hidden; border: 1px solid #e0e0e0;">
                                    <!-- Header v·ªõi gradient -->
                                    <div style="background: linear-gradient(135deg, #3f72af 0%, #2b517f 100%); padding: 25px 30px; color: white;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <h2 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                                                    <span style="font-size: 32px;">üìã</span>
                                                    <span>Order Details #<h:outputText value="#{customerOrderMBean.selectedOrder.orderID}" /></span>
                                                </h2>
                                                <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Your order details</p>
                                            </div>
                                            <h:commandButton value="‚úï" actionListener="#{customerOrderMBean.closeDetails}" 
                                                           style="background: rgba(255,255,255,0.2); border: none; color: white; width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer; transition: all 0.3s;"
                                                           onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='rotate(90deg)';"
                                                           onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='rotate(0deg)';">
                                                <f:ajax render="orderForm:orderDetailsSection :messages" />
                                            </h:commandButton>
                                        </div>
                                    </div>
                                
                                    <!-- Order Summary Cards -->
                                    <div style="padding: 25px 30px; background: white;">
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;">
                                            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #2196f3;">
                                                <div style="font-size: 13px; color: #1976d2; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">üìÖ Order Date</div>
                                                <div style="font-size: 18px; font-weight: 700; color: #333;">#{customerOrderMBean.formatDate(customerOrderMBean.selectedOrder.orderDate)}</div>
                                            </div>
                                            <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #ff9800;">
                                                <div style="font-size: 13px; color: #f57c00; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">üìä Status</div>
                                                <div>
                                                    <span style="padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 14px; color: white; background: linear-gradient(135deg, #{customerOrderMBean.getStatusColor(customerOrderMBean.selectedOrder.status)} 0%, #{customerOrderMBean.getStatusColor(customerOrderMBean.selectedOrder.status)}dd 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                                        #{customerOrderMBean.selectedOrder.status}
                                                    </span>
                                                </div>
                                            </div>
                                            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #4caf50;">
                                                <div style="font-size: 13px; color: #2e7d32; font-weight: 600; margin-bottom: 12px; text-transform: uppercase;">üí∞ Order Summary</div>
                                                <div style="margin-bottom: 8px; display: flex; justify-content: space-between; font-size: 14px;">
                                                    <span>Subtotal:</span>
                                                    <span>#{customerOrderMBean.formatAmount(customerOrderMBean.getSubtotal(customerOrderMBean.selectedOrder))}</span>
                                                </div>
                                                <h:panelGroup rendered="#{customerOrderMBean.getShippingFeeDisplay(customerOrderMBean.selectedOrder) > 0}">
                                                    <div style="margin-bottom: 8px; display: flex; justify-content: space-between; font-size: 14px; padding-top: 8px; border-top: 1px solid rgba(46, 125, 50, 0.2);">
                                                        <span>üöö Shipping Fee:</span>
                                                        <span>#{customerOrderMBean.formatAmount(customerOrderMBean.getShippingFeeDisplay(customerOrderMBean.selectedOrder))}</span>
                                                    </div>
                                                </h:panelGroup>
                                                <div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid #4caf50; display: flex; justify-content: space-between; font-size: 22px; font-weight: 700; color: #1b5e20;">
                                                    <span>Total:</span>
                                                    <span>#{customerOrderMBean.formatAmount(customerOrderMBean.selectedOrder.totalAmount)}</span>
                                                </div>
                                            </div>
                                            <div style="background: linear-gradient(135deg, #{customerOrderMBean.isCOD(customerOrderMBean.selectedOrder) ? '#fef3c7 0%, #fde68a 100%' : '#e0e7ff 0%, #c7d2fe 100%'}); padding: 20px; border-radius: 12px; border-left: 4px solid #{customerOrderMBean.isCOD(customerOrderMBean.selectedOrder) ? '#f59e0b' : '#6366f1'};">
                                                <div style="font-size: 13px; color: #{customerOrderMBean.isCOD(customerOrderMBean.selectedOrder) ? '#92400e' : '#4338ca'}; font-weight: 600; margin-bottom: 8px; text-transform: uppercase;">üí≥ Payment Method</div>
                                                <div>
                                                    <span style="padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 14px; color: #{customerOrderMBean.isCOD(customerOrderMBean.selectedOrder) ? '#92400e' : '#4338ca'}; background: rgba(255,255,255,0.8); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                                        #{customerOrderMBean.getPaymentMethodDisplay(customerOrderMBean.selectedOrder)}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                
                                        <!-- Action Buttons for Completed Orders -->
                                        <h:panelGroup rendered="#{customerOrderMBean.selectedOrder.status == 'completed'}" 
                                                     style="margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 16px; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2);">
                                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 18px;">
                                                <span style="font-size: 32px;">‚ú®</span>
                                                <h4 style="margin: 0; color: #2e7d32; font-weight: 700; font-size: 18px;">Order Completed</h4>
                                            </div>
                                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                                <h:commandButton value="üõí Reorder" 
                                                               actionListener="#{customerOrderMBean.reorderOrder()}"
                                                               style="font-weight: 700; padding: 14px 28px; font-size: 15px; border-radius: 10px; border: none; background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); transition: all 0.3s;"
                                                               onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(76, 175, 80, 0.5)';"
                                                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(76, 175, 80, 0.4)';">
                                                    <f:ajax render=":messages" />
                                                </h:commandButton>
                                                <h:link outcome="feedback" 
                                                       value="üí¨ Xem Feedback"
                                                       style="font-weight: 700; padding: 14px 28px; font-size: 15px; border-radius: 10px; border: none; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; text-decoration: none; display: inline-block; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4); transition: all 0.3s;"
                                                       onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(33, 150, 243, 0.5)';"
                                                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(33, 150, 243, 0.4)';" />
                                            </div>
                                        </h:panelGroup>
                                        
                                        <h3 style="color: #2f5061; margin-bottom: 20px; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 24px;">üì¶</span>
                                            <span>Products in Order</span>
                                        </h3>
                                <div style="overflow-x: auto;">
                                    <h:dataTable value="#{customerOrderMBean.getOrderDetails(customerOrderMBean.selectedOrder)}" var="detail" 
                                               styleClass="table"
                                               style="width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                        <h:column>
                                            <f:facet name="header">
                                                <div style="padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); font-weight: 700; color: #333; text-align: center;">Image</div>
                                            </f:facet>
                                            <div style="display: flex; justify-content: center; align-items: center; padding: 15px;">
                                                <div style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid #e0e0e0; transition: all 0.3s;"
                                                     onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.15)';"
                                                     onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';">
                                                    <img src="#{productMBean.getImageUrlForProduct(detail.productID)}"
                                                         alt="#{detail.productID != null and detail.productID.name != null ? detail.productID.name : 'Product'}"
                                                         style="width: 100%; height: 100%; object-fit: cover;"
                                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                                    <div style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center; color: #999; font-size: 32px; background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);">
                                                        üì¶
                                                    </div>
                                                </div>
                                            </div>
                                        </h:column>
                                        <h:column>
                                            <f:facet name="header">
                                                <div style="padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); font-weight: 700; color: #333;">Product</div>
                                            </f:facet>
                                            <div style="padding: 15px;">
                                                <strong style="font-size: 16px; color: #333;">#{detail.productID.name}</strong>
                                            </div>
                                        </h:column>
                                        
                                        <h:column>
                                            <f:facet name="header">
                                                <div style="padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); font-weight: 700; color: #333; text-align: center;">Quantity</div>
                                            </f:facet>
                                            <div style="padding: 15px; text-align: center;">
                                                <span style="display: inline-block; padding: 6px 14px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); color: #1976d2; border-radius: 20px; font-weight: 700; font-size: 14px;">#{detail.quantity}</span>
                                            </div>
                                        </h:column>
                                        
                                        <h:column>
                                            <f:facet name="header">
                                                <div style="padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); font-weight: 700; color: #333; text-align: right;">Unit Price</div>
                                            </f:facet>
                                            <div style="padding: 15px; text-align: right; color: #666; font-weight: 500;">
                                                #{customerOrderMBean.formatAmount(detail.unitPrice)}
                                            </div>
                                        </h:column>
                                        
                                        <h:column>
                                            <f:facet name="header">
                                                <div style="padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); font-weight: 700; color: #333; text-align: right;">Subtotal</div>
                                            </f:facet>
                                            <div style="padding: 15px; text-align: right;">
                                                <strong style="font-size: 16px; color: #2e7d32;">#{customerOrderMBean.formatAmount(detail.unitPrice * detail.quantity)}</strong>
                                            </div>
                                        </h:column>
                                        
                                        <h:column>
                                            <f:facet name="header">
                                                <div style="padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); font-weight: 700; color: #333;">Shipping Address</div>
                                            </f:facet>
                                            <div style="padding: 15px; color: #666; font-size: 14px;">
                                                üìç #{detail.shipAddress}
                                            </div>
                                        </h:column>
                                        
                                        <h:column>
                                            <f:facet name="header">
                                                <div style="padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); font-weight: 700; color: #333; text-align: center;">Rating</div>
                                            </f:facet>
                                            <div style="padding: 15px; text-align: center;">
                                                <h:commandButton value="üí¨ Rate" 
                                                               actionListener="#{feedbackMBean.prepareFeedback(detail.productID)}"
                                                               rendered="#{customerOrderMBean.selectedOrder.status == 'completed'}"
                                                               style="padding: 8px 16px; font-size: 13px; font-weight: 600; border-radius: 8px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); transition: all 0.3s;"
                                                               onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)';"
                                                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)';"
                                                               onclick="setTimeout(showFeedbackSidebar, 300);">
                                                    <f:ajax render="orderForm:feedbackSidebar" 
                                                            onevent="function(data){if(data.status=='success'){setTimeout(showFeedbackSidebar, 100);}}" />
                                                </h:commandButton>
                                            </div>
                                        </h:column>
                                    </h:dataTable>
                                </div>
                                
                                        <h:outputText value="No products found" 
                                                     rendered="#{empty customerOrderMBean.getOrderDetails(customerOrderMBean.selectedOrder)}" 
                                                     style="display: block; text-align: center; padding: 40px; color: #999; font-style: italic; background: #f8f9fa; border-radius: 12px; margin: 20px 0;" />
                                    </div>
                                    
                                    <!-- Feedback Sidebar -->
                                    <h:panelGroup id="feedbackSidebar" layout="block"
                                                 style="position: fixed; top: 0; right: -400px; width: 400px; height: 100vh; background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.15); z-index: 1000; transition: right 0.3s ease-in-out; overflow-y: auto;"
                                                 rendered="#{feedbackMBean.showFeedbackModal}">
                                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; color: white;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <h3 style="margin: 0; font-size: 20px; font-weight: 700;">üí¨ Rate Product</h3>
                                                <h:commandButton value="‚úï" actionListener="#{feedbackMBean.closeFeedbackModal()}"
                                                               style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; transition: all 0.3s;"
                                                               onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='rotate(90deg)';"
                                                               onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='rotate(0deg)';"
                                                               onclick="closeFeedbackSidebar();">
                                                    <f:ajax render="orderForm:feedbackSidebar" />
                                                </h:commandButton>
                                            </div>
                                        </div>
                                        
                                        <div style="padding: 25px;">
                                            <h:panelGroup rendered="#{feedbackMBean.showFeedbackModal and feedbackMBean.productForFeedback != null}">
                                                <!-- Product Info -->
                                                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 2px solid #e0e0e0;">
                                                    <div style="display: flex; gap: 15px; align-items: center;">
                                                        <div style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid #e0e0e0;">
                                                            <img src="#{productMBean.getImageUrlForProduct(feedbackMBean.productForFeedback)}"
                                                                 alt="#{feedbackMBean.productForFeedback.name}"
                                                                 style="max-width: 100%; max-height: 100%; object-fit: cover;"
                                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                                            <div style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center; color: #999; font-size: 32px; background: #f5f5f5;">
                                                                üì¶
                                                            </div>
                                                        </div>
                                                        <div style="flex: 1;">
                                                            <h4 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700; color: #333;">#{feedbackMBean.productForFeedback.name}</h4>
                                                            <div style="font-size: 16px; font-weight: 600; color: #2e7d32;">
                                                                üí∞ #{productMBean.formatAmount(feedbackMBean.productForFeedback.unitPrice)}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Feedback Form -->
                                                <h:form id="feedbackFormSidebar">
                                                    <div style="margin-bottom: 20px;">
                                                        <h:outputLabel value="‚≠ê Rating (1-5 stars):" 
                                                                     for="rating" 
                                                                     style="font-weight: 700; display: block; margin-bottom: 10px; color: #333; font-size: 15px;" />
                                                        <h:selectOneMenu id="rating" value="#{feedbackMBean.rating}" required="true"
                                                                       requiredMessage="Please select a rating"
                                                                       styleClass="form-select"
                                                                       style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 15px;">
                                                            <f:selectItem itemLabel="-- Select Rating --" itemValue="" />
                                                            <f:selectItem itemValue="1" itemLabel="‚≠ê (1 star)" />
                                                            <f:selectItem itemValue="2" itemLabel="‚≠ê‚≠ê (2 stars)" />
                                                            <f:selectItem itemValue="3" itemLabel="‚≠ê‚≠ê‚≠ê (3 stars)" />
                                                            <f:selectItem itemValue="4" itemLabel="‚≠ê‚≠ê‚≠ê‚≠ê (4 stars)" />
                                                            <f:selectItem itemValue="5" itemLabel="‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 stars)" />
                                                        </h:selectOneMenu>
                                                        <h:message for="rating" styleClass="field-error" style="color: #dc3545; font-size: 13px; margin-top: 5px; display: block;" />
                                                    </div>
                                                    
                                                    <div style="margin-bottom: 25px;">
                                                        <h:outputLabel value="üí¨ Comment:" 
                                                                     for="content" 
                                                                     style="font-weight: 700; display: block; margin-bottom: 10px; color: #333; font-size: 15px;" />
                                                        <h:inputTextarea id="content" 
                                                                       value="#{feedbackMBean.content}" 
                                                                       required="true"
                                                                       requiredMessage="Please enter your comment"
                                                                       styleClass="form-control"
                                                                       rows="6"
                                                                       style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px; resize: vertical;">
                                                            <f:passThroughAttribute name="placeholder" value="Share your experience about this product..." />
                                                        </h:inputTextarea>
                                                        <h:message for="content" styleClass="field-error" style="color: #dc3545; font-size: 13px; margin-top: 5px; display: block;" />
                                                    </div>
                                                    
                                                    <div style="display: flex; gap: 12px;">
                                                        <h:commandButton value="‚úñ Cancel" 
                                                                       actionListener="#{feedbackMBean.closeFeedbackModal()}"
                                                                       style="flex: 1; padding: 14px; font-size: 15px; font-weight: 600; border-radius: 10px; border: 2px solid #ddd; background: white; color: #666; cursor: pointer; transition: all 0.3s;"
                                                                       onmouseover="this.style.background='#f8f9fa'; this.style.borderColor='#999';"
                                                                       onmouseout="this.style.background='white'; this.style.borderColor='#ddd';"
                                                                       onclick="closeFeedbackSidebar();">
                                                            <f:ajax render="orderForm:feedbackSidebar" />
                                                        </h:commandButton>
                                                        <h:commandButton value="üí¨ Submit Review" 
                                                                       actionListener="#{feedbackMBean.submitFeedback()}"
                                                                       style="flex: 1; padding: 14px; font-size: 15px; font-weight: 700; border-radius: 10px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s;"
                                                                       onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.5)';"
                                                                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)';"
                                                                       onclick="setTimeout(function(){if(document.getElementById('orderForm:feedbackSidebar')) closeFeedbackSidebar();}, 500);">
                                                            <f:ajax execute="@form" render="orderForm:feedbackSidebar orderForm:orderDetailsSection :messages" />
                                                        </h:commandButton>
                                                    </div>
                                                </h:form>
                                            </h:panelGroup>
                                        </div>
                                    </h:panelGroup>
                                    
                                    <!-- Overlay khi sidebar m·ªü -->
                                    <div id="feedbackOverlay" 
                                         style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; transition: opacity 0.3s;"
                                         onclick="closeFeedbackSidebar();">
                                    </div>
                                </div>
                            </h:panelGroup>
                        </h:panelGroup>
                        
                        <!-- Feedback Modal (Old - keeping for compatibility) -->
                        <ui:fragment id="feedbackModalSection" rendered="false">
                            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                                    <h2 style="color: #2f5061; margin-bottom: 20px;">üí¨ Add Feedback</h2>
                                    <p><strong>Product:</strong> #{feedbackMBean.productForFeedback.name}</p>
                                    
                                    <h:form id="feedbackFormOld">
                                        <div style="margin-bottom: 15px;">
                                            <h:outputLabel value="Rating (1-5 stars):" for="rating" style="font-weight: bold; display: block; margin-bottom: 5px;" />
                                            <h:selectOneMenu id="rating" value="#{feedbackMBean.rating}" required="true"
                                                           requiredMessage="Please select rating"
                                                           styleClass="form-select">
                                                <f:selectItem itemLabel="-- Select Rating --" itemValue="" />
                                                <f:selectItem itemValue="1" itemLabel="‚≠ê (1 star)" />
                                                <f:selectItem itemValue="2" itemLabel="‚≠ê‚≠ê (2 stars)" />
                                                <f:selectItem itemValue="3" itemLabel="‚≠ê‚≠ê‚≠ê (3 stars)" />
                                                <f:selectItem itemValue="4" itemLabel="‚≠ê‚≠ê‚≠ê‚≠ê (4 stars)" />
                                                <f:selectItem itemValue="5" itemLabel="‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 stars)" />
                                            </h:selectOneMenu>
                                            <h:message for="rating" styleClass="field-error" />
                                        </div>
                                        
                                        <div style="margin-bottom: 15px;">
                                            <h:outputLabel value="Comment:" for="content" style="font-weight: bold; display: block; margin-bottom: 5px;" />
                                            <h:inputTextarea id="content" 
                                                           value="#{feedbackMBean.content}" 
                                                           required="true"
                                                           requiredMessage="Please enter your feedback"
                                                           styleClass="form-control"
                                                           rows="5"
                                                           style="width: 100%;">
                                                <f:passThroughAttribute name="placeholder" value="Enter your feedback..." />
                                            </h:inputTextarea>
                                            <h:message for="content" styleClass="field-error" />
                                        </div>
                                        
                                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                            <h:commandButton value="‚úñ Cancel" 
                                                           actionListener="#{feedbackMBean.closeFeedbackModal()}"
                                                           styleClass="btn btn-secondary">
                                                <f:ajax render="orderForm:feedbackModalSection orderForm:orderDetailsSection" />
                                            </h:commandButton>
                                            <h:commandButton value="üí¨ Submit Feedback" 
                                                           actionListener="#{feedbackMBean.submitFeedback()}"
                                                           styleClass="btn btn-primary">
                                                <f:ajax execute="@form" render="orderForm:feedbackModalSection orderForm:orderDetailsSection :messages" />
                                            </h:commandButton>
                                        </div>
                                    </h:form>
                                </div>
                            </div>
                        </ui:fragment>
                    </h:form>
                </h:panelGroup>
            </div>
            
            <!-- JavaScript for Sidebar Control -->
            <h:outputScript>
                <![CDATA[
                    function showFeedbackSidebar() {
                        var sidebar = document.getElementById('orderForm:feedbackSidebar');
                        var overlay = document.getElementById('feedbackOverlay');
                        
                        if (sidebar) {
                            sidebar.style.right = '0px';
                            if (overlay) {
                                overlay.style.display = 'block';
                                setTimeout(function() { overlay.style.opacity = '1'; }, 10);
                            }
                            document.body.style.overflow = 'hidden';
                        }
                    }
                    
                    function closeFeedbackSidebar() {
                        var sidebar = document.getElementById('orderForm:feedbackSidebar');
                        var overlay = document.getElementById('feedbackOverlay');
                        
                        if (sidebar) {
                            sidebar.style.right = '-400px';
                            if (overlay) {
                                overlay.style.opacity = '0';
                                setTimeout(function() { overlay.style.display = 'none'; }, 300);
                            }
                            document.body.style.overflow = '';
                        }
                    }
                    
                    // Update sidebar after AJAX
                    if (typeof jsf !== 'undefined' && jsf.ajax) {
                        jsf.ajax.addOnEvent(function(data) {
                            if (data.status === 'success') {
                                setTimeout(function() {
                                    var sidebar = document.getElementById('orderForm:feedbackSidebar');
                                    if (sidebar && sidebar.offsetParent !== null) {
                                        showFeedbackSidebar();
                                    }
                                }, 200);
                            }
                        });
                    }
                    
                    // Close sidebar on Escape key
                    document.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape') {
                            closeFeedbackSidebar();
                        }
                    });
                ]]>
            </h:outputScript>
            
            <style>
                /* Smooth transitions for sidebar */
                #orderForm\\:feedbackSidebar {
                    transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                }
                
                #feedbackOverlay {
                    transition: opacity 0.3s ease-in-out;
                }
                
                /* Table row hover effect */
                .table tbody tr {
                    transition: all 0.2s ease;
                }
                
                .table tbody tr:hover {
                    background-color: #f8f9fa !important;
                    transform: scale(1.01);
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
            </style>
        </ui:define>
    </ui:composition>
</html>

