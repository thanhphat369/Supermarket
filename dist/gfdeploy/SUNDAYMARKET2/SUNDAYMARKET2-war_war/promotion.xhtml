<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
      xmlns:ui="jakarta.faces.facelets">

    <ui:composition template="/template.xhtml">

        <ui:define name="title">üéÅ Promotion Management</ui:define>

        <ui:define name="content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h1 style="margin: 0;">üéÅ Promotion Management</h1>
                <h:form>
                    <h:commandButton value="‚ûï Add Promotion" actionListener="#{promotionMBean.prepareCreate}" 
                                    styleClass="btn btn-success-modern"
                                    style="padding: 12px 30px; font-size: 15px; font-weight: 600; border-radius: 8px; border: none; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); transition: all 0.3s; cursor: pointer;"
                                    onclick="showModal('promotionFormModal');">
                        <f:ajax render="promotionFormModal promotionTableForm" 
                                onevent="function(data){if(data.status=='success'){showModal('promotionFormModal');}}" />
                    </h:commandButton>
                </h:form>
            </div>

            <h:messages globalOnly="true" />
            
            <!-- ========== SEARCH AND FILTER ========== -->
            <div class="search-section" style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);">
                <h:form id="filterForm">
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: nowrap;">
                        <div style="flex: 1; min-width: 0; position: relative; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h:inputText id="searchInput" 
                                       value="#{promotionMBean.searchKeyword}" 
                                       styleClass="form-control search-input"
                                       style="width: 100%; padding: 14px 50px 14px 14px; border: none; border-radius: 12px; font-size: 15px; outline: none; background: transparent;">
                                <f:passThroughAttribute name="placeholder" value="üîç T√¨m ki·∫øm theo m√£, m√¥ t·∫£..." />
                                <f:ajax event="keyup" delay="300" listener="#{promotionMBean.performSearch()}" render="promotionTableForm" />
                            </h:inputText>
                            <h:commandButton value="‚úï" 
                                           actionListener="#{promotionMBean.clearSearch()}"
                                           rendered="#{not empty promotionMBean.searchKeyword}"
                                           styleClass="btn-clear-search"
                                           style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; padding: 0; background: #f0f0f0; border: none; color: #999; font-size: 16px; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s; font-weight: bold;"
                                           title="X√≥a t√¨m ki·∫øm"
                                           onmouseover="this.style.background='#e0e0e0'; this.style.color='#666';"
                                           onmouseout="this.style.background='#f0f0f0'; this.style.color='#999';">
                                <f:ajax render="filterForm promotionTableForm" />
                            </h:commandButton>
                        </div>
                        <h:selectOneMenu value="#{promotionMBean.statusFilter}" 
                                       styleClass="form-select" 
                                       style="min-width: 150px; padding: 14px; border-radius: 12px; border: none; background: white; font-size: 15px; outline: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; flex-shrink: 0;">
                            <f:selectItem itemValue="all" itemLabel="üìã T·∫•t c·∫£" />
                            <f:selectItem itemValue="active" itemLabel="‚úÖ Active" />
                            <f:selectItem itemValue="inactive" itemLabel="‚ùå Inactive" />
                            <f:selectItem itemValue="expired" itemLabel="üî¥ Expired" />
                            <f:selectItem itemValue="upcoming" itemLabel="‚è≥ Upcoming" />
                            <f:ajax event="change" listener="#{promotionMBean.performSearch()}" render="promotionTableForm" />
                        </h:selectOneMenu>
                        <h:commandButton value="üîç T√¨m ki·∫øm" 
                                       actionListener="#{promotionMBean.performSearch()}"
                                       styleClass="btn-search-modern"
                                       style="padding: 14px 28px; font-size: 15px; font-weight: 600; border-radius: 12px; border: none; background: white; color: #667eea; box-shadow: 0 4px 12px rgba(255,255,255,0.3); transition: all 0.3s; cursor: pointer; white-space: nowrap; flex-shrink: 0;"
                                       onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(255,255,255,0.4)';"
                                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255,255,255,0.3)';">
                            <f:ajax render="promotionTableForm" />
                        </h:commandButton>
                        <h:commandButton value="‚úï X√≥a" 
                                       actionListener="#{promotionMBean.clearSearch()}"
                                       styleClass="btn-search-modern"
                                       rendered="#{not empty promotionMBean.searchKeyword or promotionMBean.statusFilter != 'all'}"
                                       style="padding: 14px 28px; font-size: 15px; font-weight: 600; border-radius: 12px; border: none; background: rgba(255,255,255,0.9); color: #dc3545; box-shadow: 0 4px 12px rgba(255,255,255,0.3); transition: all 0.3s; cursor: pointer; white-space: nowrap; flex-shrink: 0;"
                                       onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(255,255,255,0.4)';"
                                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255,255,255,0.3)';">
                            <f:ajax render="filterForm promotionTableForm" />
                        </h:commandButton>
                    </div>
                    <h:outputText value="üìä T√¨m th·∫•y: #{promotionMBean.totalItems} khuy·∫øn m√£i" 
                                rendered="#{not empty promotionMBean.searchKeyword or promotionMBean.statusFilter != 'all'}"
                                style="display: block; margin-top: 12px; color: white; font-size: 14px; font-weight: 500; text-align: center; padding: 8px; background: rgba(255,255,255,0.2); border-radius: 8px;" />
                </h:form>
            </div>
            
            <!-- ========== MODAL OVERLAY ========== -->
            <h:panelGroup id="promotionFormModal">
                <div id="promotionModalOverlay" 
                     style="display: #{promotionMBean.showForm ? 'block' : 'none'}; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; animation: fadeIn 0.3s ease-out;"
                     onclick="if(event.target === this) { closeModal('promotionFormModal'); }">
                    <div class="form-section" style="background: #ffffff; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); padding: 0; margin: 40px auto; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; position: relative; animation: slideUp 0.3s ease-out;">
                        <div style="position: sticky; top: 0; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px 30px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h2 style="margin: 0; font-size: 24px; font-weight: 600;">
                                <h:outputText value="#{promotionMBean.editMode ? '‚úèÔ∏è Update Promotion' : '‚ûï Add New Promotion'}" />
                            </h2>
                            <h:form>
                                <h:commandButton value="‚úï" actionListener="#{promotionMBean.cancel()}" 
                                                style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; transition: all 0.3s;"
                                                title="Close"
                                                onclick="closeModal('promotionFormModal');">
                                    <f:ajax render="promotionFormModal promotionTableForm" 
                                            onevent="function(data){if(data.status=='success'){closeModal('promotionFormModal');}}" />
                                </h:commandButton>
                            </h:form>
                        </div>
                        <div style="padding: 30px;">
                            <h:form styleClass="fu-form" id="promotionForm">
                                <!-- Form nh·∫≠p th√¥ng tin promotion -->
                                <h:panelGrid columns="2" columnClasses="label,value" cellpadding="12">
                                    <h:outputLabel value="Promotion Code *:" for="code" />
                                    <h:inputText id="code" value="#{promotionMBean.selected.code}" required="true" styleClass="form-control">
                                        <f:passThroughAttribute name="placeholder" value="E.g: SALE50, NEWYEAR2024" />
                                    </h:inputText>

                                    <h:outputLabel value="Description:" for="description" />
                                    <h:inputTextarea id="description" value="#{promotionMBean.selected.description}" styleClass="form-control" rows="3">
                                        <f:passThroughAttribute name="placeholder" value="Description about this promotion" />
                                    </h:inputTextarea>

                                    <h:outputLabel value="Discount Type *:" for="discountType" />
                                    <h:selectOneMenu id="discountType" value="#{promotionMBean.selected.discountType}" required="true" styleClass="form-select">
                                        <f:selectItem itemLabel="-- Select type --" noSelectionOption="true" />
                                        <f:selectItem itemValue="percentage" itemLabel="Percentage (%)" />
                                        <f:selectItem itemValue="fixed" itemLabel="Fixed Amount (VND)" />
                                    </h:selectOneMenu>

                                    <h:outputLabel value="Discount Value *:" for="discountValue" />
                                    <h:inputText id="discountValue" value="#{promotionMBean.selected.discountValue}" required="true" styleClass="form-control">
                                        <f:passThroughAttribute name="type" value="number" />
                                        <f:passThroughAttribute name="step" value="0.01" />
                                        <f:passThroughAttribute name="min" value="0" />
                                        <f:passThroughAttribute name="placeholder" value="Enter discount value" />
                                    </h:inputText>

                                    <h:outputLabel value="Max Discount (VND):" for="maxDiscountAmount" />
                                    <h:inputText id="maxDiscountAmount" value="#{promotionMBean.selected.maxDiscountAmount}" styleClass="form-control">
                                        <f:passThroughAttribute name="type" value="number" />
                                        <f:passThroughAttribute name="step" value="0.01" />
                                        <f:passThroughAttribute name="min" value="0" />
                                        <f:passThroughAttribute name="placeholder" value="E.g: 50000 (optional)" />
                                    </h:inputText>

                                    <h:outputLabel value="Min Order Value (VND):" for="minOrderValue" />
                                    <h:inputText id="minOrderValue" value="#{promotionMBean.selected.minOrderValue}" styleClass="form-control">
                                        <f:passThroughAttribute name="type" value="number" />
                                        <f:passThroughAttribute name="step" value="0.01" />
                                        <f:passThroughAttribute name="min" value="0" />
                                        <f:passThroughAttribute name="placeholder" value="E.g: 100000 (optional)" />
                                    </h:inputText>

                                    <h:outputLabel value="Start Date *:" for="startDate" />
                                    <h:inputText id="startDate" value="#{promotionMBean.selected.startDate}" required="true" styleClass="form-control">
                                        <f:convertDateTime pattern="yyyy-MM-dd'T'HH:mm" />
                                        <f:passThroughAttribute name="type" value="datetime-local" />
                                    </h:inputText>

                                    <h:outputLabel value="End Date *:" for="endDate" />
                                    <h:inputText id="endDate" value="#{promotionMBean.selected.endDate}" required="true" styleClass="form-control">
                                        <f:convertDateTime pattern="yyyy-MM-dd'T'HH:mm" />
                                        <f:passThroughAttribute name="type" value="datetime-local" />
                                    </h:inputText>

                                    <h:outputLabel value="Usage Limit:" for="usageLimit" />
                                    <h:inputText id="usageLimit" value="#{promotionMBean.selected.usageLimit}" styleClass="form-control">
                                        <f:passThroughAttribute name="type" value="number" />
                                        <f:passThroughAttribute name="min" value="0" />
                                        <f:passThroughAttribute name="placeholder" value="Max usage (optional)" />
                                    </h:inputText>

                                    <h:outputLabel value="Limit Per User:" for="limitPerUser" />
                                    <h:inputText id="limitPerUser" value="#{promotionMBean.selected.limitPerUser}" styleClass="form-control">
                                        <f:passThroughAttribute name="type" value="number" />
                                        <f:passThroughAttribute name="min" value="0" />
                                        <f:passThroughAttribute name="placeholder" value="Per user limit (optional)" />
                                    </h:inputText>

                                    <h:outputLabel value="Status:" for="isActive" />
                                    <h:selectOneMenu id="isActive" value="#{promotionMBean.selected.isActive}" styleClass="form-select">
                                        <f:selectItem itemValue="true" itemLabel="‚úÖ Active" />
                                        <f:selectItem itemValue="false" itemLabel="‚ùå Inactive" />
                                    </h:selectOneMenu>

                                    <h:outputLabel value="Used Count:" />
                                    <h:outputText value="#{promotionMBean.selected.usageCount != null ? promotionMBean.selected.usageCount : 0}" 
                                               style="font-weight: 600; color: #3f72af;" />
                                </h:panelGrid>

                                <div style="margin-top: 30px; display: flex; gap: 12px; justify-content: flex-end;">
                                    <h:commandButton value="‚ùå Cancel" actionListener="#{promotionMBean.cancel()}" 
                                                   styleClass="btn btn-secondary"
                                                   onclick="closeModal('promotionFormModal');">
                                        <f:ajax render="promotionFormModal promotionTableForm" 
                                                onevent="function(data){if(data.status=='success'){closeModal('promotionFormModal');}}" />
                                    </h:commandButton>
                                    <h:commandButton value="üíæ Save" action="#{promotionMBean.save()}" 
                                                   styleClass="btn btn-primary">
                                        <f:ajax render="promotionFormModal promotionTableForm :messages" 
                                                onevent="function(data){if(data.status=='success' &amp;&amp; !data.responseXML.querySelector('messages')?.textContent.includes('‚ùå')){closeModal('promotionFormModal');}}" />
                                    </h:commandButton>
                                </div>
                            </h:form>
                        </div>
                    </div>
                </div>
            </h:panelGroup>
            
            <!-- ========== TABLE ========== -->
            <h:form id="promotionTableForm">
                <div id="promotionTable">
                    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                        <h:dataTable value="#{promotionMBean.pagedItems}" var="p" 
                                   styleClass="table table-striped table-hover"
                                   style="margin: 0;">
                            <h:column>
                                <f:facet name="header">
                                    <strong>ID</strong>
                                </f:facet>
                                <strong>##{p.promotionID}</strong>
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">
                                    <strong>Code</strong>
                                </f:facet>
                                <span style="font-family: 'Courier New', monospace; font-weight: 600; color: #3f72af;">
                                    #{p.code}
                                </span>
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">
                                    <strong>Description</strong>
                                </f:facet>
                                <span style="max-width: 200px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    #{p.description != null ? p.description : '-'}
                                </span>
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">
                                    <strong>Discount Type</strong>
                                </f:facet>
                                <span class="badge" style="background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 12px;">
                                    #{promotionMBean.getDiscountTypeText(p.discountType)}
                                </span>
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">
                                    <strong>Value</strong>
                                </f:facet>
                                <strong style="color: #28a745;">
                                    #{p.discountType != null and p.discountType.equalsIgnoreCase('percentage') ? 
                                      p.discountValue + '%' : 
                                      promotionMBean.formatAmount(p.discountValue)}
                                </strong>
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">
                                    <strong>Time</strong>
                                </f:facet>
                                <div style="font-size: 12px;">
                                    <div>üìÖ Start: #{promotionMBean.formatDate(p.startDate)}</div>
                                    <div>üìÖ End: #{promotionMBean.formatDate(p.endDate)}</div>
                                </div>
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">
                                    <strong>Status</strong>
                                </f:facet>
                                <span class="badge" style="background: #{promotionMBean.getStatusColor(p)}20; color: #{promotionMBean.getStatusColor(p)}; padding: 6px 12px; border-radius: 12px;">
                                    #{promotionMBean.getStatusText(p)}
                                </span>
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">
                                    <strong>Usage</strong>
                                </f:facet>
                                <div style="font-size: 12px;">
                                    <div>#{p.usageCount != null ? p.usageCount : 0} / #{p.usageLimit != null ? p.usageLimit : '‚àû'}</div>
                                    <div style="color: #666;">Per user: #{p.limitPerUser != null ? p.limitPerUser : '‚àû'}</div>
                                </div>
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">
                                    <strong>Actions</strong>
                                </f:facet>
                                <div style="display: flex; gap: 6px;">
                                    <h:commandButton value="‚úèÔ∏è" 
                                                   actionListener="#{promotionMBean.prepareEdit(p)}"
                                                   styleClass="btn btn-primary btn-sm"
                                                   title="Edit"
                                                   onclick="showModal('promotionFormModal');">
                                    <f:ajax render="promotionFormModal promotionTableForm" 
                                            onevent="function(data){if(data.status=='success'){showModal('promotionFormModal');}}" />
                                </h:commandButton>
                                <h:commandButton value="üóëÔ∏è" 
                                               actionListener="#{promotionMBean.delete(p)}"
                                               styleClass="btn btn-danger btn-sm"
                                               title="Delete"
                                               onclick="return confirm('Are you sure you want to delete this promotion?');">
                                    <f:ajax render="promotionTableForm :messages" />
                                    </h:commandButton>
                                </div>
                            </h:column>
                        </h:dataTable>
                        
                        <h:panelGroup rendered="#{empty promotionMBean.pagedItems}">
                            <div style="padding: 40px; text-align: center; color: #999;">
                                <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
                                <h3>No promotions yet</h3>
                                <p>Create a new promotion to get started</p>
                            </div>
                        </h:panelGroup>
                    </div>
                </div>
                
                <!-- ===== PH√ÇN TRANG ===== -->
                <div class="pagination-container" id="paginationInfo" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: block; width: 100%;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                        <h:outputText value="Page #{promotionMBean.currentPage} / #{promotionMBean.totalPages} (Total: #{promotionMBean.totalItems} promotions)" 
                                     styleClass="pagination-info" 
                                     style="font-weight: 500; color: #333; font-size: 14px;" />
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <h:commandButton value="‚èÆÔ∏è First" actionListener="#{promotionMBean.firstPage()}" 
                                           styleClass="btn btn-secondary" 
                                           disabled="#{promotionMBean.currentPage == 1 or promotionMBean.totalPages le 1}"
                                           style="min-width: 100px;">
                                <f:ajax render="promotionTableForm" />
                            </h:commandButton>
                            <h:commandButton value="‚óÄÔ∏è Prev" actionListener="#{promotionMBean.previousPage()}" 
                                           styleClass="btn btn-secondary" 
                                           disabled="#{promotionMBean.currentPage == 1 or promotionMBean.totalPages le 1}"
                                           style="min-width: 80px;">
                                <f:ajax render="promotionTableForm" />
                            </h:commandButton>
                            <h:commandButton value="Next ‚ñ∂Ô∏è" actionListener="#{promotionMBean.nextPage()}" 
                                           styleClass="btn btn-secondary" 
                                           disabled="#{promotionMBean.currentPage == promotionMBean.totalPages or promotionMBean.totalPages le 1}"
                                           style="min-width: 80px;">
                                <f:ajax render="promotionTableForm" />
                            </h:commandButton>
                            <h:commandButton value="Last ‚è≠Ô∏è" actionListener="#{promotionMBean.lastPage()}" 
                                           styleClass="btn btn-secondary" 
                                           disabled="#{promotionMBean.currentPage == promotionMBean.totalPages or promotionMBean.totalPages le 1}"
                                           style="min-width: 100px;">
                                <f:ajax render="promotionTableForm" />
                            </h:commandButton>
                        </div>
                    </div>
                </div>
            </h:form>
            
            <script>
                function showModal(modalId) {
                    document.getElementById(modalId + 'Overlay').style.display = 'block';
                }
                function closeModal(modalId) {
                    document.getElementById(modalId + 'Overlay').style.display = 'none';
                }
            </script>
        </ui:define>
    </ui:composition>
</html>
