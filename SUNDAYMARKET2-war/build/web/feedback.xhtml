<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:ui="jakarta.faces.facelets">

    <ui:composition template="/template.xhtml">

        <ui:define name="title">‚≠ê Feedback &amp; Reviews</ui:define>

        <ui:define name="content">
            <h:messages id="messages" globalOnly="true" />
            
            <!-- Check login status -->
            <h:panelGroup rendered="#{loginMBean.currentUser == null}">
                <div style="text-align: center; padding: 60px 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 16px; margin-bottom: 30px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">üîê</div>
                    <h2 style="color: #333; margin-bottom: 15px;">Please Login</h2>
                    <p style="color: #666; margin-bottom: 25px; font-size: 16px;">You need to login to view and rate products</p>
                    <h:link outcome="login" 
                           style="display: inline-block; padding: 14px 32px; background: linear-gradient(135deg, #3f72af 0%, #2b517f 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px; box-shadow: 0 4px 12px rgba(63, 114, 175, 0.3); transition: all 0.3s;"
                           onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(63, 114, 175, 0.4)';"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(63, 114, 175, 0.3)';">
                        üîì Login Now
                    </h:link>
                </div>
            </h:panelGroup>
            
            <!-- Content for Admin - Feedback Management -->
            <h:panelGroup rendered="#{loginMBean.currentUser != null and loginMBean.isAdmin()}">
                <div style="margin-bottom: 25px;">
                    <h1 style="margin: 0; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 36px; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">‚≠ê</span> 
                        <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 700;">Feedback Management</span>
                    </h1>
                    <p style="color: #666; margin-top: 10px; font-size: 16px;">View and analyze customer feedback for all products</p>
                </div>

                <!-- ========== STATISTICS CARDS ========== -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <!-- Total Feedbacks -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 25px; color: white; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üìù Total Feedbacks</div>
                    <div style="font-size: 36px; font-weight: 700;">#{feedbackMBean.totalFeedbackCount}</div>
                </div>
                
                <!-- Products with Feedback -->
                <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 16px; padding: 25px; color: white; box-shadow: 0 8px 25px rgba(17, 153, 142, 0.3);">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üì¶ Products with Feedback</div>
                    <div style="font-size: 36px; font-weight: 700;">#{feedbackMBean.totalProductsWithFeedback}</div>
                </div>
                
                <!-- Overall Rating -->
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 16px; padding: 25px; color: white; box-shadow: 0 8px 25px rgba(240, 147, 251, 0.3);">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">‚≠ê Average Rating</div>
                    <div style="font-size: 36px; font-weight: 700;">#{feedbackMBean.overallAverageRating}</div>
                </div>
                
                <!-- 5-Star Count -->
                <div style="background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%); border-radius: 16px; padding: 25px; color: white; box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üåü 5-Star Reviews</div>
                    <div style="font-size: 36px; font-weight: 700;">#{feedbackMBean.getFeedbackCountByRating(5)}</div>
                </div>
            </div>
            
            <!-- ========== RATING DISTRIBUTION ========== -->
            <div style="background: white; border-radius: 16px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                <h3 style="margin: 0 0 20px 0; color: #333;">üìä Rating Distribution</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <ui:repeat value="#{feedbackMBean.starsDesc}" var="r">
                        <div style="flex: 1; min-width: 150px; background: #f8f9fa; border-radius: 12px; padding: 15px; text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 5px;">
                                <ui:repeat value="#{feedbackMBean.stars}" var="s">
                                    <span style="color: #{s le r ? '#ffc107' : '#ddd'};">‚òÖ</span>
                                </ui:repeat>
                            </div>
                            <div style="font-size: 28px; font-weight: 700; color: #333;">#{feedbackMBean.getFeedbackCountByRating(r)}</div>
                            <div style="font-size: 12px; color: #666;">reviews</div>
                        </div>
                    </ui:repeat>
                </div>
            </div>
            
            <!-- ========== SEARCH BAR ========== -->
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #3f72af 0%, #2b517f 100%); border-radius: 16px;">
                <h:form id="searchForm">
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 280px; position: relative; background: white; border-radius: 12px; overflow: hidden;">
                            <h:inputText id="searchInput" 
                                       value="#{feedbackMBean.searchKeyword}" 
                                       styleClass="form-control"
                                       style="width: 100%; padding: 14px 50px 14px 14px; border: none; border-radius: 12px; font-size: 15px; outline: none;">
                                <f:passThroughAttribute name="placeholder" value="Search by product name, brand, category..." />
                                <f:ajax event="keyup" delay="300" listener="#{feedbackMBean.performSearch()}" render="productTable paginationInfo" />
                            </h:inputText>
                            <h:commandButton value="‚úï" 
                                           actionListener="#{feedbackMBean.clearSearch()}"
                                           rendered="#{not empty feedbackMBean.searchKeyword}"
                                           style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; padding: 0; background: #f0f0f0; border: none; color: #999; font-size: 16px; cursor: pointer; border-radius: 50%;"
                                           title="Clear search">
                                <f:ajax render="searchForm productTable paginationInfo" />
                            </h:commandButton>
                        </div>
                        <h:commandButton value="üîç Search" 
                                       actionListener="#{feedbackMBean.performSearch()}"
                                       style="padding: 14px 28px; font-size: 15px; font-weight: 600; border-radius: 12px; border: none; background: white; color: #3f72af; cursor: pointer;">
                            <f:ajax render="productTable paginationInfo" />
                        </h:commandButton>
                    </div>
                    <h:outputText value="üìä Found: #{feedbackMBean.totalItems} products" 
                                rendered="#{not empty feedbackMBean.searchKeyword}"
                                style="display: block; margin-top: 12px; color: white; font-size: 14px; text-align: center;" />
                </h:form>
            </div>

            <!-- ========== PRODUCT LIST WITH FEEDBACK ========== -->
            <h:form id="productTable">
                <h:outputText value="No products with feedback found" 
                             rendered="#{empty feedbackMBean.pagedProductsWithFeedback}" 
                             style="display: block; text-align: center; padding: 40px; color: #999; font-style: italic; background: #f5f5f5; border-radius: 12px;" />
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;"
                     rendered="#{not empty feedbackMBean.pagedProductsWithFeedback}">
                    <ui:repeat value="#{feedbackMBean.pagedProductsWithFeedback}" var="p">
                        <div style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: all 0.3s; cursor: pointer;"
                             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';"
                             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.08)';">
                            
                            <!-- Product Header -->
                            <div style="padding: 20px; border-bottom: 1px solid #eee; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
                                <div style="display: flex; gap: 20px; align-items: flex-start;">
                                    <!-- Product Images - Show all images with gallery -->
                                    <div style="flex-shrink: 0;">
                                        <div style="display: flex; flex-direction: column; gap: 8px;">
                                            <!-- Main Image -->
                                            <div style="width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid #e0e0e0; transition: all 0.3s; cursor: pointer;"
                                                 onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.15)';"
                                                 onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';"
                                                 onclick="openProductImageGallery(#{p.productID});">
                                                <img src="#{productMBean.getImageUrlForProduct(p)}"
                                                     alt="#{p.name}"
                                                     class="product-main-image-#{p.productID}"
                                                     data-product-id="#{p.productID}"
                                                     style="max-width: 100%; max-height: 100%; object-fit: cover; width: 100%; height: 100%;"
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                                <div style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center; color: #999; font-size: 48px; background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);">
                                                    üì¶
                                                </div>
                                            </div>
                                            <!-- Thumbnail images if more than 1 -->
                                            <div style="display: flex; gap: 4px; flex-wrap: wrap; max-width: 120px;"
                                                 rendered="#{productMBean.getImageUrlsForProduct(p).size() > 1}">
                                                <ui:repeat value="#{productMBean.getImageUrlsForProduct(p)}" var="imgUrl" varStatus="imgStatus">
                                                    <ui:fragment rendered="#{imgStatus.index > 0 and imgStatus.index lt 4}">
                                                        <img src="#{imgUrl}"
                                                             alt="#{p.name} #{imgStatus.index + 1}"
                                                             class="product-thumb-#{p.productID}"
                                                             data-product-id="#{p.productID}"
                                                             data-image-index="#{imgStatus.index}"
                                                             style="width: 35px; height: 35px; border-radius: 6px; object-fit: cover; border: 2px solid #ddd; cursor: pointer; transition: all 0.2s;"
                                                             onmouseover="this.style.transform='scale(1.1)'; this.style.borderColor='#3f72af';"
                                                             onmouseout="this.style.transform='scale(1)'; this.style.borderColor='#ddd';"
                                                             onclick="openProductImageGallery(#{p.productID}, #{imgStatus.index});"
                                                             onerror="this.style.display='none';" />
                                                    </ui:fragment>
                                                </ui:repeat>
                                                <ui:fragment rendered="#{productMBean.getImageUrlsForProduct(p).size() > 4}">
                                                    <div style="width: 35px; height: 35px; border-radius: 6px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; cursor: pointer;"
                                                         onclick="openProductImageGallery(#{p.productID});"
                                                         title="View all #{productMBean.getImageUrlsForProduct(p).size()} images">
                                                        +#{productMBean.getImageUrlsForProduct(p).size() - 4}
                                                    </div>
                                                </ui:fragment>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Product Info -->
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 10px 0; font-size: 18px; color: #333; line-height: 1.4; font-weight: 600;">#{p.name}</h4>
                                        <div style="font-size: 13px; color: #666; margin-bottom: 8px;">
                                            <span style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); color: #1976d2; padding: 4px 12px; border-radius: 6px; margin-right: 8px; font-weight: 500; box-shadow: 0 2px 4px rgba(25, 118, 210, 0.2);">#{p.brandID.brandName}</span>
                                            <span style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); color: #7b1fa2; padding: 4px 12px; border-radius: 6px; font-weight: 500; box-shadow: 0 2px 4px rgba(123, 31, 162, 0.2);">#{p.categoryID.categoryName}</span>
                                        </div>
                                        <div style="font-size: 14px; color: #666; font-weight: 500;">
                                            üí∞ #{productMBean.formatAmount(p.unitPrice)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Rating Summary -->
                            <div style="padding: 20px; background: #fafafa;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <div>
                                        <div style="font-size: 32px; font-weight: 700; color: #{feedbackMBean.getRatingColorDouble(feedbackMBean.getAverageRating(p))};">
                                            #{feedbackMBean.getFormattedAverageRating(p)}
                                        </div>
                                        <div style="color: #ffc107; font-size: 18px;">
                                            <ui:repeat value="#{feedbackMBean.stars}" var="s">
                                                <span style="color: #{s le feedbackMBean.getAverageRating(p) ? '#ffc107' : '#ddd'};">‚òÖ</span>
                                            </ui:repeat>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 24px; font-weight: 600; color: #333;">#{feedbackMBean.getFeedbackCountForProduct(p)}</div>
                                        <div style="font-size: 13px; color: #666;">reviews</div>
                                    </div>
                                </div>
                                
                                <!-- Rating Bars -->
                                <div style="space-y: 4px;">
                                    <ui:repeat value="#{feedbackMBean.starsDesc}" var="r">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                            <span style="font-size: 12px; color: #666; width: 15px;">#{r}</span>
                                            <span style="color: #ffc107; font-size: 12px;">‚òÖ</span>
                                            <div style="flex: 1; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                                                <div style="height: 100%; background: linear-gradient(90deg, #ffc107, #ff9800); border-radius: 4px; width: #{feedbackMBean.getRatingPercentageForProduct(p, r)}%;"></div>
                                            </div>
                                            <span style="font-size: 11px; color: #999; width: 30px; text-align: right;">#{feedbackMBean.getFeedbackCountByRatingForProduct(p, r)}</span>
                                        </div>
                                    </ui:repeat>
                                </div>
                            </div>
                            
                            <!-- View Button -->
                            <div style="padding: 15px 20px; border-top: 1px solid #eee;">
                                <h:commandButton value="üëÅÔ∏è View All Feedbacks" 
                                               actionListener="#{feedbackMBean.viewProductFeedbacks(p)}"
                                               style="width: 100%; padding: 12px; font-size: 14px; font-weight: 600; border-radius: 8px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer; transition: all 0.3s;"
                                               onmouseover="this.style.opacity='0.9';"
                                               onmouseout="this.style.opacity='1';">
                                    <f:ajax render=":feedbackModal" 
                                            onevent="function(data){if(data.status=='success'){showFeedbackModal();}}" />
                                </h:commandButton>
                            </div>
                        </div>
                    </ui:repeat>
                </div>
                
                <!-- ===== PAGINATION ===== -->
                <div id="paginationInfo" style="margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 12px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                        <h:outputText value="Page #{feedbackMBean.currentPage} / #{feedbackMBean.totalPages} (Total: #{feedbackMBean.totalItems} products)" 
                                     style="font-weight: 500; color: #333;" />
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <h:commandButton value="‚èÆÔ∏è First" actionListener="#{feedbackMBean.firstPage()}" 
                                           styleClass="btn btn-secondary" 
                                           disabled="#{feedbackMBean.currentPage == 1}">
                                <f:ajax render="productTable paginationInfo" />
                            </h:commandButton>
                            <h:commandButton value="‚óÄÔ∏è Prev" actionListener="#{feedbackMBean.previousPage()}" 
                                           styleClass="btn btn-secondary" 
                                           disabled="#{feedbackMBean.currentPage == 1}">
                                <f:ajax render="productTable paginationInfo" />
                            </h:commandButton>
                            <h:commandButton value="Next ‚ñ∂Ô∏è" actionListener="#{feedbackMBean.nextPage()}" 
                                           styleClass="btn btn-secondary" 
                                           disabled="#{feedbackMBean.currentPage == feedbackMBean.totalPages}">
                                <f:ajax render="productTable paginationInfo" />
                            </h:commandButton>
                            <h:commandButton value="Last ‚è≠Ô∏è" actionListener="#{feedbackMBean.lastPage()}" 
                                           styleClass="btn btn-secondary" 
                                           disabled="#{feedbackMBean.currentPage == feedbackMBean.totalPages}">
                                <f:ajax render="productTable paginationInfo" />
                            </h:commandButton>
                        </div>
                    </div>
                </div>
            </h:form>
            
            <!-- ========== FEEDBACK DETAIL MODAL ========== -->
            <h:panelGroup id="feedbackModal">
                <div id="feedbackModalOverlay" 
                     style="display: #{feedbackMBean.showProductFeedbacks ? 'block' : 'none'}; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto;"
                     onclick="if(event.target === this) { closeFeedbackModal(); }">
                    <div style="background: #f5f5f5; border-radius: 20px; margin: 30px auto; max-width: 900px; width: 95%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; animation: slideUp 0.3s ease-out;">
                        
                        <!-- Modal Header -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="margin: 0; font-size: 22px;">
                                    ‚≠ê Feedbacks for: #{feedbackMBean.selectedProductForView.name}
                                </h2>
                                <div style="margin-top: 8px; opacity: 0.9; font-size: 14px;">
                                    <span style="margin-right: 15px;">Rating: #{feedbackMBean.getFormattedAverageRating(feedbackMBean.selectedProductForView)}/5</span>
                                    <span>Total: #{feedbackMBean.getFeedbackCountForProduct(feedbackMBean.selectedProductForView)} reviews</span>
                                </div>
                            </div>
                            <h:form>
                                <h:commandButton value="‚úï" actionListener="#{feedbackMBean.closeProductFeedbacks()}"
                                               style="background: rgba(255,255,255,0.2); border: none; color: white; width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer;"
                                               onclick="closeFeedbackModal();">
                                    <f:ajax render=":feedbackModal" />
                                </h:commandButton>
                            </h:form>
                        </div>
                        
                        <!-- Rating Filter -->
                        <div style="background: white; padding: 15px 30px; border-bottom: 1px solid #eee;">
                            <h:form id="filterForm">
                                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                    <span style="font-weight: 500; color: #333;">Filter by rating:</span>
                                    <h:commandButton value="All" 
                                                   actionListener="#{feedbackMBean.clearRatingFilter()}"
                                                   style="padding: 8px 16px; border-radius: 20px; border: 2px solid #{feedbackMBean.ratingFilter == null ? '#667eea' : '#ddd'}; background: #{feedbackMBean.ratingFilter == null ? '#667eea' : 'white'}; color: #{feedbackMBean.ratingFilter == null ? 'white' : '#333'}; font-weight: 500; cursor: pointer;">
                                        <f:ajax render=":feedbackModal" />
                                    </h:commandButton>
                                    <ui:repeat value="#{feedbackMBean.starsDesc}" var="r">
                                        <h:commandButton value="#{r} ‚òÖ" 
                                                       actionListener="#{feedbackMBean.setRatingFilterAction}"
                                                       style="padding: 8px 16px; border-radius: 20px; border: 2px solid #{feedbackMBean.ratingFilter == r ? '#ffc107' : '#ddd'}; background: #{feedbackMBean.ratingFilter == r ? '#ffc107' : 'white'}; color: #{feedbackMBean.ratingFilter == r ? 'white' : '#333'}; font-weight: 500; cursor: pointer;">
                                            <f:param name="ratingValue" value="#{r}" />
                                            <f:ajax render=":feedbackModal" />
                                        </h:commandButton>
                                    </ui:repeat>
                                </div>
                            </h:form>
                        </div>
                        
                        <!-- Feedback List -->
                        <div style="flex: 1; overflow-y: auto; padding: 20px 30px;">
                            <h:outputText value="No feedbacks found for this filter" 
                                         rendered="#{empty feedbackMBean.selectedProductFeedbacks}"
                                         style="display: block; text-align: center; padding: 40px; color: #999; font-style: italic;" />
                            
                            <ui:repeat value="#{feedbackMBean.selectedProductFeedbacks}" var="fb">
                                <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                                    <!-- Feedback Header -->
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px;">
                                                #{fb.userID != null and fb.userID.fullName != null and fb.userID.fullName.length() gt 0 ? fb.userID.fullName.substring(0, 1).toUpperCase() : '?'}
                                            </div>
                                            <div>
                                                <div style="font-weight: 600; color: #333;">#{fb.userID.fullName}</div>
                                                <div style="font-size: 12px; color: #999;">@#{fb.userID.userName}</div>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="color: #ffc107; font-size: 16px; margin-bottom: 4px;">
                                                <ui:repeat value="#{feedbackMBean.stars}" var="s">
                                                    <span style="color: #{s le fb.rating ? '#ffc107' : '#ddd'};">‚òÖ</span>
                                                </ui:repeat>
                                            </div>
                                            <div style="font-size: 12px; color: #999;">#{feedbackMBean.formatDate(fb.createdAt)}</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Feedback Content -->
                                    <div style="color: #555; line-height: 1.6; padding: 12px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #{feedbackMBean.getRatingColor(fb.rating)};">
                                        "#{fb.content}"
                                    </div>
                                </div>
                            </ui:repeat>
                        </div>
                        
                        <!-- Modal Footer -->
                        <div style="padding: 15px 30px; background: white; border-top: 1px solid #eee; text-align: right;">
                            <h:form>
                                <h:commandButton value="Close" actionListener="#{feedbackMBean.closeProductFeedbacks()}"
                                               style="padding: 12px 30px; font-size: 14px; font-weight: 600; border-radius: 8px; border: 2px solid #667eea; background: white; color: #667eea; cursor: pointer;"
                                               onclick="closeFeedbackModal();">
                                    <f:ajax render=":feedbackModal" />
                                </h:commandButton>
                            </h:form>
                        </div>
                    </div>
                </div>
            </h:panelGroup>
            
            <h:outputScript>
                <![CDATA[
                    // Feedback View Modal (supports both Admin and Customer)
                    function showFeedbackModal() {
                        // Try Admin modal first
                        var modal = document.getElementById('feedbackModalOverlay');
                        if (!modal) {
                            // Try Customer modal
                            modal = document.getElementById('feedbackModalOverlayCustomer');
                        }
                        if (modal) {
                            modal.style.display = 'block';
                            document.body.style.overflow = 'hidden';
                        }
                    }
                    
                    function closeFeedbackModal() {
                        // Close Admin modal
                        var modal = document.getElementById('feedbackModalOverlay');
                        if (modal) {
                            modal.style.display = 'none';
                        }
                        // Close Customer modal
                        modal = document.getElementById('feedbackModalOverlayCustomer');
                        if (modal) {
                            modal.style.display = 'none';
                        }
                        document.body.style.overflow = '';
                    }
                    
                    // Feedback Submit Modal
                    function showFeedbackSubmitModal() {
                        var modal = document.getElementById('feedbackSubmitModalOverlay');
                        if (modal) {
                            modal.style.display = 'block';
                            document.body.style.overflow = 'hidden';
                        }
                    }
                    
                    function closeFeedbackSubmitModal() {
                        var modal = document.getElementById('feedbackSubmitModalOverlay');
                        if (modal) {
                            modal.style.display = 'none';
                            document.body.style.overflow = '';
                        }
                    }
                    
                    // Image Gallery
                    var currentProductImages = [];
                    var currentImageIndex = 0;
                    
                    function openProductImageGallery(productId, startIndex) {
                        startIndex = startIndex || 0;
                        var images = [];
                        
                        // Get all images for this product
                        var mainImg = document.querySelector('.product-main-image-' + productId);
                        var thumbnails = document.querySelectorAll('.product-thumb-' + productId);
                        
                        if (mainImg && mainImg.src) {
                            images.push(mainImg.src);
                        }
                        
                        if (thumbnails.length > 0) {
                            thumbnails.forEach(function(thumb) {
                                if (thumb.src && images.indexOf(thumb.src) === -1) {
                                    images.push(thumb.src);
                                }
                            });
                        }
                        
                        // Also try to get from all product images
                        var allThumbs = document.querySelectorAll('[data-product-id="' + productId + '"]');
                        allThumbs.forEach(function(img) {
                            if (img.src && images.indexOf(img.src) === -1) {
                                images.push(img.src);
                            }
                        });
                        
                        if (images.length === 0) {
                            console.log('No images found for product ' + productId);
                            return;
                        }
                        
                        currentProductImages = images;
                        currentImageIndex = startIndex >= 0 && startIndex < images.length ? startIndex : 0;
                        
                        showProductImageGallery();
                    }
                    
                    function showProductImageGallery() {
                        var gallery = document.getElementById('productImageGalleryOverlay');
                        if (!gallery) {
                            gallery = document.createElement('div');
                            gallery.id = 'productImageGalleryOverlay';
                            gallery.style.cssText = 'display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; overflow: hidden;';
                            gallery.innerHTML = '<div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;"><button id="galleryCloseBtn" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10001;">‚úï</button><button id="galleryPrevBtn" style="position: absolute; left: 20px; background: rgba(255,255,255,0.2); border: none; color: white; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10001;">‚óÄ</button><button id="galleryNextBtn" style="position: absolute; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10001;">‚ñ∂</button><img id="galleryMainImage" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);" /><div id="galleryImageInfo" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: white; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 20px; font-size: 14px;"></div></div>';
                            document.body.appendChild(gallery);
                            
                            document.getElementById('galleryCloseBtn').onclick = closeProductImageGallery;
                            document.getElementById('galleryPrevBtn').onclick = function() { navigateProductGallery(-1); };
                            document.getElementById('galleryNextBtn').onclick = function() { navigateProductGallery(1); };
                            
                            gallery.onclick = function(e) {
                                if (e.target === gallery || e.target.id === 'productImageGalleryOverlay') {
                                    closeProductImageGallery();
                                }
                            };
                        }
                        
                        updateProductGalleryImage();
                        gallery.style.display = 'block';
                        document.body.style.overflow = 'hidden';
                    }
                    
                    function updateProductGalleryImage() {
                        var img = document.getElementById('galleryMainImage');
                        var info = document.getElementById('galleryImageInfo');
                        if (img && currentProductImages.length > 0) {
                            img.src = currentProductImages[currentImageIndex];
                            if (info) {
                                info.textContent = (currentImageIndex + 1) + ' / ' + currentProductImages.length;
                            }
                        }
                    }
                    
                    function navigateProductGallery(direction) {
                        currentImageIndex += direction;
                        if (currentImageIndex < 0) {
                            currentImageIndex = currentProductImages.length - 1;
                        } else if (currentImageIndex >= currentProductImages.length) {
                            currentImageIndex = 0;
                        }
                        updateProductGalleryImage();
                    }
                    
                    function closeProductImageGallery() {
                        var gallery = document.getElementById('productImageGalleryOverlay');
                        if (gallery) {
                            gallery.style.display = 'none';
                            document.body.style.overflow = '';
                        }
                    }
                    
                    // Keyboard shortcuts
                    document.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape') {
                            closeFeedbackModal();
                            closeFeedbackSubmitModal();
                            closeProductImageGallery();
                        }
                        // Gallery navigation
                        var gallery = document.getElementById('productImageGalleryOverlay');
                        if (gallery && gallery.style.display === 'block') {
                            if (e.key === 'ArrowLeft') navigateProductGallery(-1);
                            if (e.key === 'ArrowRight') navigateProductGallery(1);
                        }
                    });
                ]]>
            </h:outputScript>
            
            <style>
                @keyframes slideUp {
                    from {
                        opacity: 0;
                        transform: translateY(30px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
                
                .rating-star-button:hover {
                    transform: scale(1.1);
                    box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
                }
            </style>
            </h:panelGroup>
            
            <!-- Content for Customer/User - View Product Feedback -->
            <h:panelGroup rendered="#{loginMBean.currentUser != null and (loginMBean.isCustomer() or (not loginMBean.isAdmin() and not loginMBean.isShipper()))}">
                <div style="margin-bottom: 25px;">
                    <h1 style="margin: 0; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 36px; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">‚≠ê</span> 
                        <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 700;">Feedback &amp; Reviews</span>
                    </h1>
                    <p style="color: #666; margin-top: 10px; font-size: 16px;">View customer reviews and ratings for products</p>
                </div>
                
                <!-- Search Bar for Customer -->
                <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #3f72af 0%, #2b517f 100%); border-radius: 16px;">
                    <h:form id="searchFormCustomer">
                        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 280px; position: relative; background: white; border-radius: 12px; overflow: hidden;">
                                <h:inputText id="searchInputCustomer" 
                                           value="#{feedbackMBean.searchKeyword}" 
                                           styleClass="form-control"
                                           style="width: 100%; padding: 14px 50px 14px 14px; border: none; border-radius: 12px; font-size: 15px; outline: none;">
                                    <f:passThroughAttribute name="placeholder" value="Search products..." />
                                    <f:ajax event="keyup" delay="300" listener="#{feedbackMBean.performSearch()}" render="productTableCustomer paginationInfoCustomer" />
                                </h:inputText>
                                <h:commandButton value="‚úï" 
                                               actionListener="#{feedbackMBean.clearSearch()}"
                                               rendered="#{not empty feedbackMBean.searchKeyword}"
                                               style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; padding: 0; background: #f0f0f0; border: none; color: #999; font-size: 16px; cursor: pointer; border-radius: 50%;"
                                               title="Clear search">
                                    <f:ajax render="searchFormCustomer productTableCustomer paginationInfoCustomer" />
                                </h:commandButton>
                            </div>
                            <h:commandButton value="üîç Search" 
                                           actionListener="#{feedbackMBean.performSearch()}"
                                           style="padding: 14px 28px; font-size: 15px; font-weight: 600; border-radius: 12px; border: none; background: white; color: #3f72af; cursor: pointer;">
                                <f:ajax render="productTableCustomer paginationInfoCustomer" />
                            </h:commandButton>
                        </div>
                        <h:outputText value="üìä Found: #{feedbackMBean.totalProductsForCustomer} products" 
                                    rendered="#{not empty feedbackMBean.searchKeyword}"
                                    style="display: block; margin-top: 12px; color: white; font-size: 14px; text-align: center;" />
                    </h:form>
                </div>
                
                <!-- Product List for Customer -->
                <h:form id="productTableCustomer">
                    <h:outputText value="No products found" 
                                 rendered="#{empty feedbackMBean.pagedAllProductsForCustomer}" 
                                 style="display: block; text-align: center; padding: 40px; color: #999; font-style: italic; background: #f5f5f5; border-radius: 12px;" />
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;"
                         rendered="#{not empty feedbackMBean.pagedAllProductsForCustomer}">
                        <ui:repeat value="#{feedbackMBean.pagedAllProductsForCustomer}" var="p">
                            <div style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: all 0.3s; cursor: pointer;"
                                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.08)';">
                                
                                <!-- Product Header -->
                                <div style="padding: 20px; border-bottom: 1px solid #eee; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
                                    <div style="display: flex; gap: 20px; align-items: flex-start;">
                                        <!-- Product Images - Show all images with gallery -->
                                        <div style="flex-shrink: 0;">
                                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                                <!-- Main Image -->
                                                <div style="width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid #e0e0e0; transition: all 0.3s; cursor: pointer;"
                                                     onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.15)';"
                                                     onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';"
                                                     onclick="openProductImageGallery(#{p.productID});">
                                                    <img src="#{productMBean.getImageUrlForProduct(p)}"
                                                         alt="#{p.name}"
                                                         class="product-main-image-#{p.productID}"
                                                         data-product-id="#{p.productID}"
                                                         style="max-width: 100%; max-height: 100%; object-fit: cover; width: 100%; height: 100%;"
                                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                                    <div style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center; color: #999; font-size: 48px; background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);">
                                                        üì¶
                                                    </div>
                                                </div>
                                                <!-- Thumbnail images if more than 1 -->
                                                <div style="display: flex; gap: 4px; flex-wrap: wrap; max-width: 120px;"
                                                     rendered="#{productMBean.getImageUrlsForProduct(p).size() > 1}">
                                                    <ui:repeat value="#{productMBean.getImageUrlsForProduct(p)}" var="imgUrl" varStatus="imgStatus">
                                                        <ui:fragment rendered="#{imgStatus.index > 0 and imgStatus.index lt 4}">
                                                            <img src="#{imgUrl}"
                                                                 alt="#{p.name} #{imgStatus.index + 1}"
                                                                 class="product-thumb-#{p.productID}"
                                                                 data-product-id="#{p.productID}"
                                                                 data-image-index="#{imgStatus.index}"
                                                                 style="width: 35px; height: 35px; border-radius: 6px; object-fit: cover; border: 2px solid #ddd; cursor: pointer; transition: all 0.2s;"
                                                                 onmouseover="this.style.transform='scale(1.1)'; this.style.borderColor='#3f72af';"
                                                                 onmouseout="this.style.transform='scale(1)'; this.style.borderColor='#ddd';"
                                                                 onclick="openProductImageGallery(#{p.productID}, #{imgStatus.index});"
                                                                 onerror="this.style.display='none';" />
                                                        </ui:fragment>
                                                    </ui:repeat>
                                                    <ui:fragment rendered="#{productMBean.getImageUrlsForProduct(p).size() > 4}">
                                                        <div style="width: 35px; height: 35px; border-radius: 6px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; cursor: pointer;"
                                                             onclick="openProductImageGallery(#{p.productID});"
                                                             title="View all #{productMBean.getImageUrlsForProduct(p).size()} images">
                                                            +#{productMBean.getImageUrlsForProduct(p).size() - 4}
                                                        </div>
                                                    </ui:fragment>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Product Info -->
                                        <div style="flex: 1;">
                                            <h4 style="margin: 0 0 10px 0; font-size: 18px; color: #333; line-height: 1.4; font-weight: 600;">#{p.name}</h4>
                                            <div style="font-size: 13px; color: #666; margin-bottom: 8px;">
                                                <span style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); color: #1976d2; padding: 4px 12px; border-radius: 6px; margin-right: 8px; font-weight: 500; box-shadow: 0 2px 4px rgba(25, 118, 210, 0.2);">#{p.brandID.brandName}</span>
                                                <span style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); color: #7b1fa2; padding: 4px 12px; border-radius: 6px; font-weight: 500; box-shadow: 0 2px 4px rgba(123, 31, 162, 0.2);">#{p.categoryID.categoryName}</span>
                                            </div>
                                            <div style="font-size: 16px; color: #2e7d32; font-weight: 700;">
                                                üí∞ #{productMBean.formatAmount(p.unitPrice)}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Rating Summary -->
                                <div style="padding: 20px; background: #fafafa;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <div>
                                            <div style="font-size: 32px; font-weight: 700; color: #{feedbackMBean.getRatingColorDouble(feedbackMBean.getAverageRating(p))};">
                                                #{feedbackMBean.getFormattedAverageRating(p)}
                                            </div>
                                            <div style="color: #ffc107; font-size: 18px;">
                                                <ui:repeat value="#{feedbackMBean.stars}" var="s">
                                                    <span style="color: #{s le feedbackMBean.getAverageRating(p) ? '#ffc107' : '#ddd'};">‚òÖ</span>
                                                </ui:repeat>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 24px; font-weight: 600; color: #333;">#{feedbackMBean.getFeedbackCountForProduct(p)}</div>
                                            <div style="font-size: 13px; color: #666;">reviews</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Rating Bars -->
                                    <div style="space-y: 4px;">
                                        <ui:repeat value="#{feedbackMBean.starsDesc}" var="r">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                                <span style="font-size: 12px; color: #666; width: 15px;">#{r}</span>
                                                <span style="color: #ffc107; font-size: 12px;">‚òÖ</span>
                                                <div style="flex: 1; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                                                    <div style="height: 100%; background: linear-gradient(90deg, #ffc107, #ff9800); border-radius: 4px; width: #{feedbackMBean.getRatingPercentageForProduct(p, r)}%;"></div>
                                                </div>
                                                <span style="font-size: 11px; color: #999; width: 30px; text-align: right;">#{feedbackMBean.getFeedbackCountByRatingForProduct(p, r)}</span>
                                            </div>
                                        </ui:repeat>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div style="padding: 15px 20px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                                    <h:commandButton value="üëÅÔ∏è View Reviews" 
                                                   actionListener="#{feedbackMBean.viewProductFeedbacks(p)}"
                                                   style="flex: 1; padding: 12px; font-size: 14px; font-weight: 600; border-radius: 8px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer; transition: all 0.3s;"
                                                   onmouseover="this.style.opacity='0.9';"
                                                   onmouseout="this.style.opacity='1';">
                                        <f:ajax render=":feedbackModalCustomer" 
                                                onevent="function(data){if(data.status=='success'){showFeedbackModal();}}" />
                                    </h:commandButton>
                                    <h:commandButton value="‚≠ê Rate Product" 
                                                   action="#{feedbackMBean.prepareFeedback(p)}"
                                                   style="flex: 1; padding: 12px; font-size: 14px; font-weight: 600; border-radius: 8px; border: none; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white; cursor: pointer; transition: all 0.3s;"
                                                   onmouseover="this.style.opacity='0.9';"
                                                   onmouseout="this.style.opacity='1';">
                                        <f:ajax execute="@this"
                                                render=":feedbackSubmitModal :feedbackSubmitForm"
                                                onevent="function(data){
                                                    if(data.status === 'success'){
                                                        showFeedbackSubmitModal();
                                                    }
                                                }"/>
                                    </h:commandButton>
                                </div>
                            </div>
                        </ui:repeat>
                    </div>
                    
                    <!-- Pagination for Customer -->
                    <div id="paginationInfoCustomer" style="margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 12px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                            <h:outputText value="Page #{feedbackMBean.currentPage} / #{feedbackMBean.totalPagesForCustomer} (Total: #{feedbackMBean.totalProductsForCustomer} products)" 
                                         style="font-weight: 500; color: #333;" />
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <h:commandButton value="‚èÆÔ∏è First" actionListener="#{feedbackMBean.firstPage()}" 
                                               styleClass="btn btn-secondary" 
                                               disabled="#{feedbackMBean.currentPage == 1}">
                                    <f:ajax render="productTableCustomer paginationInfoCustomer" />
                                </h:commandButton>
                                <h:commandButton value="‚óÄÔ∏è Prev" actionListener="#{feedbackMBean.previousPage()}" 
                                               styleClass="btn btn-secondary" 
                                               disabled="#{feedbackMBean.currentPage == 1}">
                                    <f:ajax render="productTableCustomer paginationInfoCustomer" />
                                </h:commandButton>
                                <h:commandButton value="Next ‚ñ∂Ô∏è" actionListener="#{feedbackMBean.nextPage()}" 
                                               styleClass="btn btn-secondary" 
                                               disabled="#{feedbackMBean.currentPage == feedbackMBean.totalPagesForCustomer}">
                                    <f:ajax render="productTableCustomer paginationInfoCustomer" />
                                </h:commandButton>
                                <h:commandButton value="Last ‚è≠Ô∏è" actionListener="#{feedbackMBean.lastPage()}" 
                                               styleClass="btn btn-secondary" 
                                               disabled="#{feedbackMBean.currentPage == feedbackMBean.totalPagesForCustomer}">
                                    <f:ajax render="productTableCustomer paginationInfoCustomer" />
                                </h:commandButton>
                            </div>
                        </div>
                    </div>
                </h:form>
                
                <!-- Feedback Detail Modal (same as admin) -->
                <h:panelGroup id="feedbackModalCustomer">
                    <div id="feedbackModalOverlayCustomer" 
                         style="display: #{feedbackMBean.showProductFeedbacks ? 'block' : 'none'}; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto;"
                         onclick="if(event.target === this) { closeFeedbackModal(); }">
                        <div style="background: #f5f5f5; border-radius: 20px; margin: 30px auto; max-width: 900px; width: 95%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; animation: slideUp 0.3s ease-out;">
                            
                            <!-- Modal Header -->
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h2 style="margin: 0; font-size: 22px;">
                                        ‚≠ê Reviews for: #{feedbackMBean.selectedProductForView.name}
                                    </h2>
                                    <div style="margin-top: 8px; opacity: 0.9; font-size: 14px;">
                                        <span style="margin-right: 15px;">Rating: #{feedbackMBean.getFormattedAverageRating(feedbackMBean.selectedProductForView)}/5</span>
                                        <span>Total: #{feedbackMBean.getFeedbackCountForProduct(feedbackMBean.selectedProductForView)} reviews</span>
                                    </div>
                                </div>
                                <h:form>
                                    <h:commandButton value="‚úï" actionListener="#{feedbackMBean.closeProductFeedbacks()}"
                                                   style="background: rgba(255,255,255,0.2); border: none; color: white; width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer;"
                                                   onclick="closeFeedbackModal();">
                                        <f:ajax render=":feedbackModalCustomer" />
                                    </h:commandButton>
                                </h:form>
                            </div>
                            
                            <!-- Rating Filter -->
                            <div style="background: white; padding: 15px 30px; border-bottom: 1px solid #eee;">
                                <h:form id="filterFormCustomer">
                                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                        <span style="font-weight: 500; color: #333;">Filter by rating:</span>
                                        <h:commandButton value="All" 
                                                       actionListener="#{feedbackMBean.clearRatingFilter()}"
                                                       style="padding: 8px 16px; border-radius: 20px; border: 2px solid #{feedbackMBean.ratingFilter == null ? '#667eea' : '#ddd'}; background: #{feedbackMBean.ratingFilter == null ? '#667eea' : 'white'}; color: #{feedbackMBean.ratingFilter == null ? 'white' : '#333'}; font-weight: 500; cursor: pointer;">
                                            <f:ajax render=":feedbackModalCustomer" />
                                        </h:commandButton>
                                        <ui:repeat value="#{feedbackMBean.starsDesc}" var="r">
                                            <h:commandButton value="#{r} ‚òÖ" 
                                                           actionListener="#{feedbackMBean.setRatingFilterAction}"
                                                           style="padding: 8px 16px; border-radius: 20px; border: 2px solid #{feedbackMBean.ratingFilter == r ? '#ffc107' : '#ddd'}; background: #{feedbackMBean.ratingFilter == r ? '#ffc107' : 'white'}; color: #{feedbackMBean.ratingFilter == r ? 'white' : '#333'}; font-weight: 500; cursor: pointer;">
                                                <f:param name="ratingValue" value="#{r}" />
                                                <f:ajax render=":feedbackModalCustomer" />
                                            </h:commandButton>
                                        </ui:repeat>
                                    </div>
                                </h:form>
                            </div>
                            
                            <!-- Feedback List -->
                            <div style="flex: 1; overflow-y: auto; padding: 20px 30px;">
                                <h:outputText value="No reviews found" 
                                             rendered="#{empty feedbackMBean.selectedProductFeedbacks}"
                                             style="display: block; text-align: center; padding: 40px; color: #999; font-style: italic;" />
                                
                                <ui:repeat value="#{feedbackMBean.selectedProductFeedbacks}" var="fb">
                                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                                        <!-- Feedback Header -->
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <div style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px;">
                                                    #{fb.userID != null and fb.userID.fullName != null and fb.userID.fullName.length() gt 0 ? fb.userID.fullName.substring(0, 1).toUpperCase() : '?'}
                                                </div>
                                                <div>
                                                    <div style="font-weight: 600; color: #333;">#{fb.userID.fullName}</div>
                                                    <div style="font-size: 12px; color: #999;">@#{fb.userID.userName}</div>
                                                </div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="color: #ffc107; font-size: 16px; margin-bottom: 4px;">
                                                    <ui:repeat value="#{feedbackMBean.stars}" var="s">
                                                        <span style="color: #{s le fb.rating ? '#ffc107' : '#ddd'};">‚òÖ</span>
                                                    </ui:repeat>
                                                </div>
                                                <div style="font-size: 12px; color: #999;">#{feedbackMBean.formatDate(fb.createdAt)}</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Feedback Content -->
                                        <div style="color: #555; line-height: 1.6; padding: 12px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #{feedbackMBean.getRatingColor(fb.rating)};">
                                            "#{fb.content}"
                                        </div>
                                    </div>
                                </ui:repeat>
                            </div>
                            
                            <!-- Modal Footer -->
                            <div style="padding: 15px 30px; background: white; border-top: 1px solid #eee; text-align: right;">
                                <h:form>
                                    <h:commandButton value="Close" actionListener="#{feedbackMBean.closeProductFeedbacks()}"
                                                   style="padding: 12px 30px; font-size: 14px; font-weight: 600; border-radius: 8px; border: 2px solid #667eea; background: white; color: #667eea; cursor: pointer;"
                                                   onclick="closeFeedbackModal();">
                                        <f:ajax render=":feedbackModalCustomer" />
                                    </h:commandButton>
                                </h:form>
                            </div>
                        </div>
                    </div>
                </h:panelGroup>
            </h:panelGroup>
            
            <!-- ========== FEEDBACK SUBMIT MODAL ========== -->
            <h:panelGroup id="feedbackSubmitModal">
                <div id="feedbackSubmitModalOverlay" 
                     style="display: #{feedbackMBean.showFeedbackModal ? 'block' : 'none'}; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1001; overflow-y: auto;"
                     onclick="if(event.target === this) { closeFeedbackSubmitModal(); }">
                    <div style="background: white; border-radius: 20px; margin: 30px auto; max-width: 600px; width: 95%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; animation: slideUp 0.3s ease-out;">
                        
                        <!-- Modal Header -->
                        <div style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white; padding: 25px 30px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="margin: 0; font-size: 22px;">‚≠ê Rate Product</h2>
                                <div style="margin-top: 8px; opacity: 0.9; font-size: 14px;" rendered="#{feedbackMBean.productForFeedback != null}">
                                    #{feedbackMBean.productForFeedback.name}
                                </div>
                            </div>
                            <h:form>
                                <h:commandButton value="‚úï" actionListener="#{feedbackMBean.closeFeedbackModal()}"
                                               style="background: rgba(255,255,255,0.2); border: none; color: white; width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer;"
                                               onclick="closeFeedbackSubmitModal();">
                                    <f:ajax render=":feedbackSubmitModal" />
                                </h:commandButton>
                            </h:form>
                        </div>
                        
                        <!-- Product Info -->
                        <div style="padding: 20px 30px; background: #f8f9fa; border-bottom: 1px solid #eee;" rendered="#{feedbackMBean.productForFeedback != null}">
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <div style="flex-shrink: 0;">
                                    <img src="#{productMBean.getImageUrlForProduct(feedbackMBean.productForFeedback)}"
                                         alt="#{feedbackMBean.productForFeedback.name}"
                                         style="width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 2px solid #ddd;"
                                         onerror="this.style.display='none';" />
                                </div>
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 5px 0; font-size: 16px; color: #333;">#{feedbackMBean.productForFeedback.name}</h4>
                                    <div style="font-size: 14px; color: #666;">
                                        <span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 4px; font-size: 12px;">#{feedbackMBean.productForFeedback.brandID.brandName}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Feedback Form -->
                        <h:form id="feedbackSubmitForm" style="flex: 1; overflow-y: auto; padding: 25px 30px;">
                            <!-- Rating Selection -->
                            <h:panelGroup id="ratingSelection" style="margin-bottom: 25px;">
                                <label style="display: block; font-weight: 600; color: #333; margin-bottom: 12px; font-size: 16px;">Your Rating <span style="color: #dc3545;">*</span></label>
                                <div style="display: flex; gap: 8px; justify-content: center;">
                                    <ui:repeat value="#{feedbackMBean.stars}" var="r">
                                        <h:commandButton value="‚òÖ" 
                                                       actionListener="#{feedbackMBean.setRatingAction}"
                                                       style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #{feedbackMBean.rating != null and feedbackMBean.rating >= r ? '#ffc107' : '#ddd'}; background: #{feedbackMBean.rating != null and feedbackMBean.rating >= r ? '#ffc107' : 'white'}; color: #{feedbackMBean.rating != null and feedbackMBean.rating >= r ? 'white' : '#999'}; font-size: 24px; cursor: pointer; transition: all 0.2s;"
                                                       styleClass="rating-star-button"
                                                       title="#{r} stars">
                                            <f:param name="ratingValue" value="#{r}" />
                                            <f:ajax execute="@this" render=":feedbackSubmitForm:ratingSelection :feedbackSubmitForm" />
                                        </h:commandButton>
                                    </ui:repeat>
                                </div>
                                <div style="text-align: center; margin-top: 8px; font-size: 14px; color: #666;">
                                    <h:outputText value="You selected: #{feedbackMBean.rating} / 5 stars" 
                                                 rendered="#{feedbackMBean.rating != null}" />
                                </div>
                            </h:panelGroup>
                            
                            <!-- Content -->
                            <div style="margin-bottom: 25px;">
                                <label style="display: block; font-weight: 600; color: #333; margin-bottom: 12px; font-size: 16px;">Your Comment <span style="color: #dc3545;">*</span></label>
                                <h:inputTextarea value="#{feedbackMBean.content}" 
                                               rows="5"
                                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; outline: none; transition: border-color 0.3s;"
                                               onfocus="this.style.borderColor='#3f72af';"
                                               onblur="this.style.borderColor='#ddd';">
                                    <f:passThroughAttribute name="placeholder" value="Please share your experience about this product..." />
                                </h:inputTextarea>
                            </div>
                            
                            <!-- Submit Button -->
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <h:commandButton value="Cancel" actionListener="#{feedbackMBean.closeFeedbackModal()}"
                                               style="padding: 12px 30px; font-size: 14px; font-weight: 600; border-radius: 8px; border: 2px solid #ddd; background: white; color: #666; cursor: pointer;"
                                               onclick="closeFeedbackSubmitModal();">
                                    <f:ajax render=":feedbackSubmitModal" />
                                </h:commandButton>
                                <h:commandButton value="Submit Review" actionListener="#{feedbackMBean.submitFeedback()}"
                                               style="padding: 12px 30px; font-size: 14px; font-weight: 600; border-radius: 8px; border: none; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white; cursor: pointer; transition: all 0.3s;"
                                               onmouseover="this.style.opacity='0.9';"
                                               onmouseout="this.style.opacity='1';">
                                    <f:ajax execute="@form" render=":feedbackSubmitModal :messages :productTableCustomer :paginationInfoCustomer" />
                                </h:commandButton>
                            </div>
                        </h:form>
                    </div>
                </div>
            </h:panelGroup>
            
            <br/>
        </ui:define>
    </ui:composition>
</html>
