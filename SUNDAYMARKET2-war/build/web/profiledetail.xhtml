<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:ui="jakarta.faces.facelets"
      xmlns:f="jakarta.faces.core">

    <ui:composition template="/template.xhtml">
        <ui:define name="title">üë§ Th√¥ng tin c√° nh√¢n</ui:define>

        <ui:define name="content">
            <h:outputStylesheet library="css" name="style.css" />
            
            <div class="page-container" style="max-width: 900px; margin: 0 auto; padding: 20px;">
                <div style="margin-bottom: 30px;">
                    <h1 style="margin: 0; font-size: 28px; font-weight: 700; color: #2f5061; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 32px;">üë§</span>
                        <span>H·ªì s∆° c√° nh√¢n</span>
                    </h1>
                    <p style="margin: 8px 0 0 0; color: #64748b; font-size: 14px;">Qu·∫£n l√Ω th√¥ng tin t√†i kho·∫£n c·ªßa b·∫°n</p>
                </div>

                <!-- Th√¥ng b√°o -->
                <h:messages globalOnly="true" styleClass="messages" />
            
            <!-- Profile Card -->
            <div style="background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 30px; margin-bottom: 20px;">
                <h:form rendered="#{loginMBean.currentUser != null}" enctype="multipart/form-data" id="profileForm">
                    
                    <!-- Avatar Section -->
                    <div style="text-align: center; margin-bottom: 30px; padding-bottom: 30px; border-bottom: 2px solid #f1f5f9;">
                        <h:panelGroup layout="block" id="avatarPanel" style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
                            <div class="avatar-container" style="position: relative; width: 140px; height: 140px; display: flex; align-items: center; justify-content: center;">
                                <img src="#{profileDetailMBean.currentUserAvatarUrl}"
                                     id="existingAvatar"
                                     alt="Avatar"
                                     style="display: #{not empty loginMBean.currentUser.avatar ? 'block' : 'none'}; width: 140px; height: 140px; object-fit: cover; border-radius: 50%; border: 4px solid #3f72af; box-shadow: 0 8px 24px rgba(63, 114, 175, 0.2); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"
                                     onerror="this.style.display='none'; var noAvatar = document.getElementById('noAvatarText'); if(noAvatar) noAvatar.style.display='flex';" />
                                
                                <img id="avatarPreview" 
                                     src="" 
                                     class="avatar-preview-hidden"
                                     style="display: none; width: 140px; height: 140px; object-fit: cover; border-radius: 50%; border: 4px solid #3f72af; box-shadow: 0 8px 24px rgba(63, 114, 175, 0.2); position: absolute; top: 0; left: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"
                                     alt="Preview" />

                                <div id="noAvatarText"
                                     style="display: #{empty loginMBean.currentUser.avatar and empty profileDetailMBean.previewImageBase64 ? 'flex' : 'none'}; width: 140px; height: 140px; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; border: 4px solid #3f72af; box-shadow: 0 8px 24px rgba(63, 114, 175, 0.2); color: white; font-size: 56px; font-weight: 600;">
                                    üë§
                                </div>
                            </div>
                            
                            <h:inputFile value="#{profileDetailMBean.uploadedFile}" 
                                         id="avatarFileInput"
                                         rendered="#{profileDetailMBean.editMode}"
                                         styleClass="avatar-input"
                                         style="padding: 8px 16px; background: #3f72af; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.3s;"
                                         onmouseover="this.style.background='#2b517f'; this.style.transform='translateY(-2px)';"
                                         onmouseout="this.style.background='#3f72af'; this.style.transform='translateY(0)';"
                                         onchange="previewAvatar(this, 'avatarPreview', 'existingAvatar', 'noAvatarText');" />
                            <div style="font-size: 12px; color: #64748b; margin-top: 5px;">
                                #{profileDetailMBean.editMode ? 'Ch·ªçn ·∫£nh m·ªõi' : ''}
                            </div>
                        </h:panelGroup>
                    </div>

                    <!-- Information Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">

                        <!-- Username -->
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <label style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">T√™n ƒëƒÉng nh·∫≠p</label>
                            <div style="padding: 12px 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; font-size: 15px; color: #2f5061; font-weight: 500;">
                                #{loginMBean.currentUser.userName}
                            </div>
                        </div>

                        <!-- Full Name -->
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <label style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">H·ªç v√† t√™n</label>
                            <h:panelGroup>
                                <h:inputText value="#{loginMBean.currentUser.fullName}" 
                                             rendered="#{profileDetailMBean.editMode}"
                                             styleClass="form-control"
                                             style="padding: 12px 16px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 15px; width: 100%; box-sizing: border-box; transition: all 0.3s;"
                                             onfocus="this.style.borderColor='#3f72af'; this.style.boxShadow='0 0 0 3px rgba(63, 114, 175, 0.1)';"
                                             onblur="this.style.borderColor='#cbd5e1'; this.style.boxShadow='none';" />
                                <h:outputText value="#{loginMBean.currentUser.fullName != null ? loginMBean.currentUser.fullName : '-'}" 
                                              rendered="#{!profileDetailMBean.editMode}"
                                              style="display: block; padding: 12px 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; font-size: 15px; color: #2f5061; font-weight: 500;" />
                            </h:panelGroup>
                        </div>

                        <!-- Email -->
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <label style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Email</label>
                            <h:panelGroup>
                                <h:inputText value="#{loginMBean.currentUser.email}" 
                                             rendered="#{profileDetailMBean.editMode}"
                                             styleClass="form-control"
                                             style="padding: 12px 16px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 15px; width: 100%; box-sizing: border-box; transition: all 0.3s;"
                                             onfocus="this.style.borderColor='#3f72af'; this.style.boxShadow='0 0 0 3px rgba(63, 114, 175, 0.1)';"
                                             onblur="this.style.borderColor='#cbd5e1'; this.style.boxShadow='none';" />
                                <h:outputText value="#{loginMBean.currentUser.email != null ? loginMBean.currentUser.email : '-'}" 
                                              rendered="#{!profileDetailMBean.editMode}"
                                              style="display: block; padding: 12px 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; font-size: 15px; color: #2f5061; font-weight: 500;" />
                            </h:panelGroup>
                        </div>

                        <!-- Phone -->
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <label style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">S·ªë ƒëi·ªán tho·∫°i</label>
                            <h:panelGroup>
                                <h:inputText value="#{loginMBean.currentUser.phone}" 
                                             rendered="#{profileDetailMBean.editMode}"
                                             styleClass="form-control"
                                             style="padding: 12px 16px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 15px; width: 100%; box-sizing: border-box; transition: all 0.3s;"
                                             onfocus="this.style.borderColor='#3f72af'; this.style.boxShadow='0 0 0 3px rgba(63, 114, 175, 0.1)';"
                                             onblur="this.style.borderColor='#cbd5e1'; this.style.boxShadow='none';" />
                                <h:outputText value="#{loginMBean.currentUser.phone != null ? loginMBean.currentUser.phone : '-'}" 
                                              rendered="#{!profileDetailMBean.editMode}"
                                              style="display: block; padding: 12px 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; font-size: 15px; color: #2f5061; font-weight: 500;" />
                            </h:panelGroup>
                        </div>

                        <!-- Address -->
                        <div style="display: flex; flex-direction: column; gap: 6px; grid-column: 1 / -1;">
                            <label style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">ƒê·ªãa ch·ªâ</label>
                            <h:panelGroup>
                                <h:inputText value="#{loginMBean.currentUser.address}" 
                                             rendered="#{profileDetailMBean.editMode}"
                                             styleClass="form-control"
                                             style="padding: 12px 16px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 15px; width: 100%; box-sizing: border-box; transition: all 0.3s;"
                                             onfocus="this.style.borderColor='#3f72af'; this.style.boxShadow='0 0 0 3px rgba(63, 114, 175, 0.1)';"
                                             onblur="this.style.borderColor='#cbd5e1'; this.style.boxShadow='none';">
                                    <f:passThroughAttribute name="placeholder" value="Nh·∫≠p ƒë·ªãa ch·ªâ" />
                                </h:inputText>
                                <h:outputText value="#{loginMBean.currentUser.address != null ? loginMBean.currentUser.address : '-'}" 
                                              rendered="#{!profileDetailMBean.editMode}"
                                              style="display: block; padding: 12px 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; font-size: 15px; color: #2f5061; font-weight: 500;" />
                            </h:panelGroup>
                        </div>

                        <!-- Password -->
                        <div style="display: flex; flex-direction: column; gap: 6px; grid-column: 1 / -1;">
                            <label style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">M·∫≠t kh·∫©u</label>
                            <h:panelGroup>
                                <h:panelGroup rendered="#{profileDetailMBean.editMode}">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 10px;">
                                        <div>
                                            <label for="oldPassword" style="font-size: 12px; color: #64748b; display: block; margin-bottom: 6px; font-weight: 500;">M·∫≠t kh·∫©u c≈©</label>
                                            <h:inputText id="oldPassword"
                                                         value="#{profileDetailMBean.oldPassword}" 
                                                         styleClass="form-control"
                                                         style="padding: 12px 16px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 15px; width: 100%; box-sizing: border-box; transition: all 0.3s; background: #f0f9ff;"
                                                         onfocus="this.style.borderColor='#3f72af'; this.style.boxShadow='0 0 0 3px rgba(63, 114, 175, 0.1)';"
                                                         onblur="this.style.borderColor='#cbd5e1'; this.style.boxShadow='none';">
                                                <f:passThroughAttribute name="placeholder" value="M·∫≠t kh·∫©u hi·ªán t·∫°i (ƒë√£ ƒëi·ªÅn s·∫µn)" />
                                            </h:inputText>
                                            <small style="display: block; margin-top: 4px; color: #10b981; font-size: 11px; font-weight: 500;">
                                                ‚úì M·∫≠t kh·∫©u hi·ªán t·∫°i ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn s·∫µn
                                            </small>
                                        </div>
                                        <div>
                                            <label for="newPassword" style="font-size: 12px; color: #64748b; display: block; margin-bottom: 6px; font-weight: 500;">M·∫≠t kh·∫©u m·ªõi</label>
                                            <h:inputSecret id="newPassword"
                                                         value="#{profileDetailMBean.newPassword}" 
                                                         styleClass="form-control"
                                                         style="padding: 12px 16px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 15px; width: 100%; box-sizing: border-box; transition: all 0.3s;"
                                                         onfocus="this.style.borderColor='#3f72af'; this.style.boxShadow='0 0 0 3px rgba(63, 114, 175, 0.1)';"
                                                         onblur="this.style.borderColor='#cbd5e1'; this.style.boxShadow='none';">
                                                <f:passThroughAttribute name="placeholder" value="T·ªëi thi·ªÉu 6 k√Ω t·ª±" />
                                            </h:inputSecret>
                                        </div>
                                        <div>
                                            <label for="confirmPassword" style="font-size: 12px; color: #64748b; display: block; margin-bottom: 6px; font-weight: 500;">X√°c nh·∫≠n</label>
                                            <h:inputSecret id="confirmPassword"
                                                         value="#{profileDetailMBean.confirmPassword}" 
                                                         styleClass="form-control"
                                                         style="padding: 12px 16px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 15px; width: 100%; box-sizing: border-box; transition: all 0.3s;"
                                                         onfocus="this.style.borderColor='#3f72af'; this.style.boxShadow='0 0 0 3px rgba(63, 114, 175, 0.1)';"
                                                         onblur="this.style.borderColor='#cbd5e1'; this.style.boxShadow='none';">
                                                <f:passThroughAttribute name="placeholder" value="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" />
                                            </h:inputSecret>
                                        </div>
                                    </div>
                                    <div style="padding: 10px 14px; background: #fef3c7; border-left: 3px solid #f59e0b; border-radius: 6px; font-size: 12px; color: #92400e;">
                                        üí° ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën ƒë·ªïi m·∫≠t kh·∫©u
                                    </div>
                                </h:panelGroup>
                                <h:panelGroup rendered="#{!profileDetailMBean.editMode}">
                                    <div style="padding: 12px 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; font-size: 15px; color: #2f5061; font-weight: 500; font-family: monospace; letter-spacing: 2px;">
                                        ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢
                                    </div>
                                    <small style="display: block; margin-top: 6px; color: #64748b; font-size: 12px; font-style: italic;">Nh·∫•n ch·ªânh s·ª≠a ƒë·ªÉ ƒë·ªïi m·∫≠t kh·∫©u</small>
                                </h:panelGroup>
                            </h:panelGroup>
                        </div>

                        <!-- Role -->
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <label style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Vai tr√≤</label>
                            <div style="padding: 12px 16px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 8px; border: 1px solid #3b82f6; font-size: 15px; color: #2563eb; font-weight: 600; display: inline-block; width: fit-content;">
                                #{loginMBean.currentUser.roleID != null ? loginMBean.currentUser.roleID.roleName : 'N/A'}
                            </div>
                            <small style="color: #94a3b8; font-size: 11px; margin-top: 4px;">Kh√¥ng th·ªÉ thay ƒë·ªïi</small>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 30px; padding-top: 30px; border-top: 2px solid #f1f5f9;">
                        <h:commandButton value="‚úèÔ∏è Ch·ªânh s·ª≠a"
                                         actionListener="#{profileDetailMBean.enableEdit}"
                                         rendered="#{!profileDetailMBean.editMode}"
                                         styleClass="btn"
                                         style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);"
                                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.4)';"
                                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)';">
                            <f:ajax execute="@this" render="@form avatarPanel" />
                        </h:commandButton>

                        <h:commandButton value="üíæ L∆∞u thay ƒë·ªïi"
                                         actionListener="#{profileDetailMBean.saveProfile}"
                                         rendered="#{profileDetailMBean.editMode}"
                                         styleClass="btn"
                                         style="padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);"
                                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.4)';"
                                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)';">
                            <f:ajax execute="@form" render="@form :messages avatarPanel" 
                                    onevent="function(data){if(data.status=='success'){hidePreview();}}" />
                        </h:commandButton>

                        <h:commandButton value="‚ùå H·ªßy"
                                         actionListener="#{profileDetailMBean.cancelEdit}"
                                         rendered="#{profileDetailMBean.editMode}"
                                         styleClass="btn"
                                         style="padding: 12px 24px; background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s;"
                                         onmouseover="this.style.background='#e2e8f0'; this.style.color='#475569';"
                                         onmouseout="this.style.background='#f1f5f9'; this.style.color='#64748b';">
                            <f:ajax execute="@this" render="@form avatarPanel" />
                        </h:commandButton>
                    </div>
                </h:form>
            </div>
            
                
                <h:panelGroup rendered="#{loginMBean.currentUser == null}">
                    <p>‚ö†Ô∏è B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p! H√£y <h:link outcome="login" value="ƒëƒÉng nh·∫≠p t·∫°i ƒë√¢y" />.</p>
                </h:panelGroup>
            </div>

            <!-- ‚úÖ FIXED SCRIPT: d√πng CDATA ƒë·ªÉ tr√°nh l·ªói "&" -->
            <h:outputScript>
                <![CDATA[
                    function previewAvatar(input, previewId, existingId, noAvatarId) {
                        if (input.files) {
                            if (input.files[0]) {
                            var reader = new FileReader();
                            reader.onload = function(e) {
                                var preview = document.getElementById(previewId);
                                var existing = document.getElementById(existingId);
                                var noAvatar = document.getElementById(noAvatarId);
                                
                                // Hi·ªÉn th·ªã preview v√† ·∫©n existing avatar
                                if (preview) {
                                    preview.src = e.target.result;
                                    preview.style.display = 'block';
                                    preview.style.width = '140px';
                                    preview.style.height = '140px';
                                    preview.style.objectFit = 'cover';
                                    preview.style.borderRadius = '50%';
                                    preview.style.border = '4px solid #3f72af';
                                    preview.style.boxShadow = '0 8px 24px rgba(63, 114, 175, 0.2)';
                                    preview.classList.remove('avatar-preview-hidden');
                                }
                                if (existing) {
                                    existing.style.display = 'none';
                                }
                                if (noAvatar) {
                                    noAvatar.style.display = 'none';
                                }
                            };
                            reader.readAsDataURL(input.files[0]);
                            }
                        } else {
                            // N·∫øu kh√¥ng ch·ªçn file, hi·ªÉn th·ªã l·∫°i avatar c≈©
                            var preview = document.getElementById(previewId);
                            var existing = document.getElementById(existingId);
                            if (preview) {
                                preview.style.display = 'none';
                                preview.classList.add('avatar-preview-hidden');
                            }
                            if (existing) {
                                if (existing.src) {
                                    existing.style.display = 'block';
                                }
                            }
                        }
                    }

                    function hidePreview() {
                        var preview = document.getElementById('avatarPreview');
                        var existing = document.getElementById('existingAvatar');
                        var noAvatar = document.getElementById('noAvatarText');
                        if (preview) {
                            preview.style.display = 'none';
                            preview.classList.add('avatar-preview-hidden');
                        }
                        if (existing) {
                            if (existing.src) {
                                existing.style.display = 'block';
                            }
                        }
                        // Hi·ªÉn th·ªã "Ch∆∞a c√≥ ·∫£nh" n·∫øu kh√¥ng c√≥ avatar
                        if (noAvatar) {
                            if (!existing) {
                                noAvatar.style.display = 'block';
                            } else {
                                if (!existing.src) {
                                    noAvatar.style.display = 'block';
                                } else {
                                    if (existing.style.display === 'none') {
                                        noAvatar.style.display = 'block';
                                    }
                                }
                            }
                        }
                    }
                ]]>
            </h:outputScript>
        </ui:define>
    </ui:composition>
</html>
