<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:ui="jakarta.faces.facelets">

    <ui:composition template="/template.xhtml">
        <ui:define name="title">üìú L·ªãch s·ª≠ giao h√†ng</ui:define>

        <ui:define name="content">
            <h:outputStylesheet library="css" name="shipper-style.css" />
            <h:messages globalOnly="true" id="messages" />
            
            <div class="shipper-page">
                    
                    <!-- Check login -->
                    <h:panelGroup rendered="#{loginMBean.currentUser == null or !loginMBean.isShipper()}">
                        <div class="empty-state" style="padding: 80px 20px;">
                            <div class="empty-state-icon">üîê</div>
                            <h2 class="empty-state-title">Truy c·∫≠p b·ªã t·ª´ ch·ªëi</h2>
                            <p class="empty-state-desc">Please login with Shipper account to access</p>
                            <h:link outcome="login" styleClass="btn btn-primary btn-lg" style="margin-top: 24px;">
                                üîì ƒêƒÉng nh·∫≠p
                            </h:link>
                        </div>
                    </h:panelGroup>
                    
                    <!-- History Content -->
                    <h:panelGroup rendered="#{loginMBean.currentUser != null and loginMBean.isShipper()}">
                        <h:form id="historyForm">
                            
                            <!-- Page Header -->
                            <div class="shipper-header">
                                <div>
                                    <h1 class="shipper-title">
                                        <span class="shipper-title-icon">üìú</span>
                                        L·ªãch s·ª≠ giao h√†ng
                                    </h1>
                                    <p class="shipper-subtitle">View delivered orders history</p>
                                </div>
                                <h:link outcome="shipper-dashboard" styleClass="btn btn-secondary">
                                    ‚Üê Quay l·∫°i Dashboard
                                </h:link>
                            </div>
                            
                            <!-- Filter Section -->
                            <div class="filter-section">
                                <div class="filter-row">
                                    <!-- L·ªçc theo tr·∫°ng th√°i giao h√†ng -->
                                    <div class="filter-group">
                                        <span class="filter-label">Status</span>
                                        <h:selectOneMenu value="#{shipperDashboardMBean.historyStatusFilter}" styleClass="form-control form-select" style="min-width: 160px;">
                                            <f:selectItem itemValue="all" itemLabel="üìã All" />
                                            <f:selectItem itemValue="delivered" itemLabel="‚úÖ Delivered" />
                                            <f:selectItem itemValue="failed" itemLabel="‚ùå Failed" />
                                            <f:selectItem itemValue="shipping" itemLabel="üöö Shipping" />
                                            <f:selectItem itemValue="picked_up" itemLabel="üì¶ Picked Up" />
                                            <f:ajax event="change" listener="#{shipperDashboardMBean.filterHistory()}" render="historyTable paginationInfo" />
                                        </h:selectOneMenu>
                                    </div>
                                    
                                    <div class="filter-group">
                                        <span class="filter-label">Month</span>
                                        <h:selectOneMenu value="#{shipperDashboardMBean.historyMonthFilter}" styleClass="form-control form-select" style="min-width: 120px;">
                                            <f:selectItem itemValue="1" itemLabel="January" />
                                            <f:selectItem itemValue="2" itemLabel="February" />
                                            <f:selectItem itemValue="3" itemLabel="March" />
                                            <f:selectItem itemValue="4" itemLabel="April" />
                                            <f:selectItem itemValue="5" itemLabel="May" />
                                            <f:selectItem itemValue="6" itemLabel="June" />
                                            <f:selectItem itemValue="7" itemLabel="July" />
                                            <f:selectItem itemValue="8" itemLabel="August" />
                                            <f:selectItem itemValue="9" itemLabel="September" />
                                            <f:selectItem itemValue="10" itemLabel="October" />
                                            <f:selectItem itemValue="11" itemLabel="November" />
                                            <f:selectItem itemValue="12" itemLabel="December" />
                                            <f:ajax event="change" listener="#{shipperDashboardMBean.filterHistory()}" render="historyTable paginationInfo" />
                                        </h:selectOneMenu>
                                    </div>
                                    
                                    <div class="filter-group">
                                        <span class="filter-label">NƒÉm</span>
                                        <h:inputText value="#{shipperDashboardMBean.historyYearFilter}" 
                                                   styleClass="form-control" 
                                                   style="min-width: 100px;"
                                                   type="number">
                                            <f:ajax event="blur" listener="#{shipperDashboardMBean.filterHistory()}" render="historyTable paginationInfo" />
                                        </h:inputText>
                                    </div>
                                    
                                    <div class="filter-group" style="margin-top: 24px;">
                                        <h:commandButton value="üîç L·ªçc" 
                                                       actionListener="#{shipperDashboardMBean.filterHistory()}"
                                                       styleClass="btn btn-primary">
                                            <f:ajax render="historyTable paginationInfo" />
                                        </h:commandButton>
                                    </div>
                                    
                                    <div class="filter-group" style="margin-top: 24px;">
                                        <h:commandButton value="‚úñ X√≥a l·ªçc" 
                                                       actionListener="#{shipperDashboardMBean.clearHistoryFilter()}"
                                                       styleClass="btn btn-secondary">
                                            <f:ajax render="historyForm" />
                                        </h:commandButton>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- History Table -->
                            <div class="orders-container" id="historyTable">
                                <div class="orders-header">
                                    <h3 style="margin: 0; font-weight: 700;">üìú L·ªãch s·ª≠ giao h√†ng</h3>
                                    <span style="font-size: 14px; color: var(--shipper-gray-600);">
                                        T·ªïng: #{shipperDashboardMBean.historyTotalItems} ƒë∆°n
                                    </span>
                                </div>
                                
                                <h:panelGroup rendered="#{empty shipperDashboardMBean.pagedHistory}">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">üì≠</div>
                                        <h3 class="empty-state-title">Ch∆∞a c√≥ l·ªãch s·ª≠ giao h√†ng</h3>
                                        <p class="empty-state-desc">Delivered orders will appear here</p>
                                    </div>
                                </h:panelGroup>
                                
                                <h:dataTable value="#{shipperDashboardMBean.pagedHistory}" var="d" 
                                           styleClass="shipper-table"
                                           rendered="#{not empty shipperDashboardMBean.pagedHistory}">
                                    <h:column>
                                        <f:facet name="header">üìã Delivery</f:facet>
                                        <strong style="font-family: 'JetBrains Mono', monospace;">##{d.deliveryID}</strong>
                                    </h:column>
                                    
                                    <h:column>
                                        <f:facet name="header">üõí Order</f:facet>
                                        <span style="color: var(--shipper-primary); font-weight: 600;">
                                            ##{d.orderID != null ? d.orderID.orderID : '-'}
                                        </span>
                                    </h:column>
                                    
                                    <h:column>
                                        <f:facet name="header">üë§ Customer</f:facet>
                                        <div>
                                            <strong>#{d.orderID != null and d.orderID.userID != null ? (d.orderID.userID.fullName != null ? d.orderID.userID.fullName : d.orderID.userID.userName) : '-'}</strong>
                                            <div style="font-size: 12px; color: var(--shipper-gray-500);">
                                                üìû #{d.orderID != null and d.orderID.userID != null and d.orderID.userID.phone != null ? d.orderID.userID.phone : 'N/A'}
                                            </div>
                                        </div>
                                    </h:column>
                                    
                                    <h:column>
                                        <f:facet name="header">üí∞ T·ªïng ti·ªÅn</f:facet>
                                        <strong style="color: var(--shipper-success); font-size: 15px;">
                                            #{d.orderID != null ? shipperDashboardMBean.formatAmount(d.orderID.totalAmount) : '-'}
                                        </strong>
                                    </h:column>
                                    
                                    <h:column>
                                        <f:facet name="header">üìä Tr·∫°ng th√°i</f:facet>
                                        <span class="badge" style="background: #{shipperDashboardMBean.getStatusColor(d.status)}20; color: #{shipperDashboardMBean.getStatusColor(d.status)};">
                                            #{shipperDashboardMBean.getStatusText(d.status)}
                                        </span>
                                    </h:column>
                                    
                                    <h:column>
                                        <f:facet name="header">üìÖ Ng√†y giao</f:facet>
                                        <div>
                                            #{shipperDashboardMBean.formatDate(d.deliveredAt != null ? d.deliveredAt : d.updatedAt)}
                                        </div>
                                    </h:column>
                                    
                                    <h:column>
                                        <f:facet name="header">‚ö° Thao t√°c</f:facet>
                                        <div style="display: flex; gap: 6px;">
                                            <h:commandButton value="üìã" 
                                                           title="Xem chi ti·∫øt"
                                                           actionListener="#{shipperDashboardMBean.openLogModal(d)}"
                                                           styleClass="btn btn-primary btn-sm btn-icon">
                                                <f:ajax render="logModal" />
                                            </h:commandButton>
                                        </div>
                                    </h:column>
                                </h:dataTable>
                            </div>
                            
                            <!-- Pagination -->
                            <div class="pagination" id="paginationInfo">
                                <span class="pagination-info">
                                    Trang #{shipperDashboardMBean.historyCurrentPage} / #{shipperDashboardMBean.historyTotalPages} 
                                    (#{shipperDashboardMBean.historyTotalItems} ƒë∆°n)
                                </span>
                                <div class="pagination-buttons">
                                    <h:commandButton value="‚èÆ" actionListener="#{shipperDashboardMBean.historyFirstPage()}" 
                                                   styleClass="pagination-btn" 
                                                   disabled="#{shipperDashboardMBean.historyCurrentPage == 1 or shipperDashboardMBean.historyTotalPages le 1}">
                                        <f:ajax render="historyTable paginationInfo" />
                                    </h:commandButton>
                                    <h:commandButton value="‚óÄ" actionListener="#{shipperDashboardMBean.historyPreviousPage()}" 
                                                   styleClass="pagination-btn" 
                                                   disabled="#{shipperDashboardMBean.historyCurrentPage == 1 or shipperDashboardMBean.historyTotalPages le 1}">
                                        <f:ajax render="historyTable paginationInfo" />
                                    </h:commandButton>
                                    <h:commandButton value="‚ñ∂" actionListener="#{shipperDashboardMBean.historyNextPage()}" 
                                                   styleClass="pagination-btn" 
                                                   disabled="#{shipperDashboardMBean.historyCurrentPage == shipperDashboardMBean.historyTotalPages or shipperDashboardMBean.historyTotalPages le 1}">
                                        <f:ajax render="historyTable paginationInfo" />
                                    </h:commandButton>
                                    <h:commandButton value="‚è≠" actionListener="#{shipperDashboardMBean.historyLastPage()}" 
                                                   styleClass="pagination-btn" 
                                                   disabled="#{shipperDashboardMBean.historyCurrentPage == shipperDashboardMBean.historyTotalPages or shipperDashboardMBean.historyTotalPages le 1}">
                                        <f:ajax render="historyTable paginationInfo" />
                                    </h:commandButton>
                                </div>
                            </div>
                            
                            <!-- Log Modal -->
                            <h:panelGroup id="logModal">
                                <ui:fragment rendered="#{shipperDashboardMBean.showLogModal and shipperDashboardMBean.selectedDelivery != null}">
                                    <div class="modal-overlay">
                                        <div class="modal-content animate-slide-up" style="max-width: 800px;">
                                            <div class="modal-header" style="background: var(--gradient-primary); color: white;">
                                                <h3 class="modal-title" style="color: white;">üìã Chi ti·∫øt giao h√†ng</h3>
                                                <h:commandButton value="‚úï" actionListener="#{shipperDashboardMBean.closeLogModal()}"
                                                               style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 8px; cursor: pointer;">
                                                    <f:ajax render="logModal" />
                                                </h:commandButton>
                                            </div>
                                            <div class="modal-body">
                                                <h4>Delivery ##{shipperDashboardMBean.selectedDelivery.deliveryID}</h4>
                                                <p><strong>Order:</strong> ##{shipperDashboardMBean.selectedDelivery.orderID.orderID}</p>
                                                <p><strong>Tr·∫°ng th√°i:</strong> #{shipperDashboardMBean.getStatusText(shipperDashboardMBean.selectedDelivery.status)}</p>
                                                
                                                <h5 style="margin-top: 20px;">üìú L·ªãch s·ª≠ ho·∫°t ƒë·ªông</h5>
                                                <h:dataTable value="#{shipperDashboardMBean.selectedDeliveryLogs}" var="log" 
                                                           styleClass="shipper-table"
                                                           rendered="#{not empty shipperDashboardMBean.selectedDeliveryLogs}">
                                                    <h:column>
                                                        <f:facet name="header">Th·ªùi gian</f:facet>
                                                        #{shipperDashboardMBean.formatDate(log.createdAt)}
                                                    </h:column>
                                                    <h:column>
                                                        <f:facet name="header">S·ª± ki·ªán</f:facet>
                                                        #{log.getEventTypeDisplay()}
                                                    </h:column>
                                                    <h:column>
                                                        <f:facet name="header">M√¥ t·∫£</f:facet>
                                                        #{log.description}
                                                    </h:column>
                                                </h:dataTable>
                                            </div>
                                            <div class="modal-footer">
                                                <h:commandButton value="ƒê√≥ng" actionListener="#{shipperDashboardMBean.closeLogModal()}"
                                                               styleClass="btn btn-secondary">
                                                    <f:ajax render="logModal" />
                                                </h:commandButton>
                                            </div>
                                        </div>
                                    </div>
                                </ui:fragment>
                            </h:panelGroup>
                            
                        </h:form>
                    </h:panelGroup>
            </div>
        </ui:define>
    </ui:composition>
</html>
