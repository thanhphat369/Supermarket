<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:ui="jakarta.faces.facelets">

    <ui:composition template="/template.xhtml">
        <ui:define name="title">üí≥ Payment</ui:define>

        <ui:define name="content">
            <h:messages globalOnly="true" />
            
            <div style="padding: 20px; max-width: 800px; margin: 0 auto;">
                <h1 style="color: #2f5061; margin-bottom: 20px; text-align: center;">üí≥ Payment</h1>
                
                <h:panelGroup rendered="#{paymentMBean.pendingOrder == null}">
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px;">
                        <p style="font-size: 18px; color: #64748b; margin-bottom: 20px;">No pending payment found</p>
                        <h:link outcome="index" value="‚Üê Back to Home" 
                                style="display: inline-block; padding: 12px 24px; background-color: #3f72af; color: white; text-decoration: none; border-radius: 6px; font-weight: 500;" />
                    </div>
                </h:panelGroup>
                
                <h:panelGroup rendered="#{paymentMBean.pendingOrder != null}">
                    <h:form id="paymentForm">
                        <!-- Order Summary -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h2 style="color: #2f5061; margin-bottom: 20px;">üìã Order Summary</h2>
                            <p style="margin-bottom: 20px;"><strong>Order ID:</strong> ##{paymentMBean.pendingOrder.orderID}</p>
                            
                            <!-- Product List -->
                            <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                <h3 style="color: #2f5061; margin-bottom: 15px; font-size: 16px;">üõçÔ∏è Products:</h3>
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid #ddd; padding-bottom: 10px;">
                                            <th style="text-align: left; padding: 10px; color: #64748b; font-weight: 600;">Product</th>
                                            <th style="text-align: center; padding: 10px; color: #64748b; font-weight: 600;">Quantity</th>
                                            <th style="text-align: right; padding: 10px; color: #64748b; font-weight: 600;">Price</th>
                                            <th style="text-align: right; padding: 10px; color: #64748b; font-weight: 600;">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <ui:repeat value="#{paymentMBean.getOrderDetails(paymentMBean.pendingOrder)}" var="detail">
                                            <tr style="border-bottom: 1px solid #eee;">
                                                <td style="padding: 12px 10px; color: #333;">
                                                    <strong>#{detail.productID.name}</strong>
                                                </td>
                                                <td style="text-align: center; padding: 12px 10px; color: #333;">
                                                    #{detail.quantity}
                                                </td>
                                                <td style="text-align: right; padding: 12px 10px; color: #64748b;">
                                                    #{paymentMBean.formatAmount(detail.unitPrice)}
                                                </td>
                                                <td style="text-align: right; padding: 12px 10px; color: #2f5061; font-weight: 600;">
                                                    #{paymentMBean.formatAmount(detail.unitPrice * detail.quantity)}
                                                </td>
                                            </tr>
                                        </ui:repeat>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Price Breakdown -->
                            <div style="background: white; padding: 15px; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                                    <span style="color: #64748b; font-weight: 500;">T·ªïng ti·ªÅn s·∫£n ph·∫©m:</span>
                                    <span style="color: #333; font-weight: 600;">#{paymentMBean.formatAmount(paymentMBean.getSubtotal(paymentMBean.pendingOrder))}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #ddd;">
                                    <span style="color: #64748b; font-weight: 500;">üöö Ph√≠ v·∫≠n chuy·ªÉn (ti·ªÅn ship):</span>
                                    <span style="color: #333; font-weight: 600;">#{paymentMBean.formatAmount(paymentMBean.getShippingFee(paymentMBean.pendingOrder))}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-top: 10px;">
                                    <span style="color: #2f5061; font-size: 18px; font-weight: 700;">T·ªïng ƒë∆°n h√†ng:</span>
                                    <span style="color: #3f72af; font-size: 24px; font-weight: bold;">#{paymentMBean.formatAmount(paymentMBean.calculateTotal(paymentMBean.pendingOrder))}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Method Selection -->
                        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #ddd;">
                            <h3 style="color: #2f5061; margin-bottom: 15px;">Select Payment Method</h3>
                            
                            <div style="background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                                <p style="margin: 0; color: #856404; font-size: 14px;">
                                    <strong>‚ö†Ô∏è Demo Mode:</strong> This is a demonstration for project purposes. No real payment will be processed.
                                </p>
                            </div>
                            
                            <h:selectOneRadio id="paymentMethodRadio" value="#{paymentMBean.paymentMethod}" layout="pageDirection" style="margin-bottom: 15px;">
                                <f:selectItem itemValue="cod" itemLabel="üí∞ COD - Thu ti·ªÅn khi nh·∫≠n h√†ng (Cash on Delivery)" />
                                <f:selectItem itemValue="online" itemLabel="üí≥ Thanh to√°n Online (VNPay / MoMo / Chuy·ªÉn kho·∫£n)" />
                                <f:ajax event="change" execute="@this" listener="#{paymentMBean.updatePaymentInfo()}" render="paymentSection @form" />
                            </h:selectOneRadio>
                        </div>
                        
                        <!-- Payment Section -->
                        <div id="paymentSection" style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <!-- COD Payment Info -->
                            <ui:fragment rendered="#{paymentMBean.paymentMethod == 'cod'}">
                                <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                                    <h3 style="color: #856404; margin-bottom: 15px;">üí∞ COD - Cash on Delivery</h3>
                                    <p style="color: #856404; font-size: 16px; margin-bottom: 10px;">
                                        <strong>B·∫°n s·∫Ω thanh to√°n khi nh·∫≠n h√†ng</strong>
                                    </p>
                                    <p style="color: #856404; font-size: 14px; margin: 0;">
                                        Shipper s·∫Ω thu ti·ªÅn khi giao h√†ng cho b·∫°n. Vui l√≤ng chu·∫©n b·ªã ƒë√∫ng s·ªë ti·ªÅn: 
                                        <strong style="font-size: 18px;">#{paymentMBean.formatAmount(paymentMBean.calculateTotal(paymentMBean.pendingOrder))}</strong>
                                    </p>
                                </div>
                                
                                <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                                    <p style="margin: 0; color: #1976D2; font-size: 14px;">
                                        ‚úÖ ƒê∆°n h√†ng c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω ngay. Shipper s·∫Ω li√™n h·ªá v·ªõi b·∫°n ƒë·ªÉ giao h√†ng.
                                    </p>
                                </div>
                                
                                <h:commandButton value="‚úÖ X√°c nh·∫≠n ƒë·∫∑t h√†ng COD" 
                                               action="#{paymentMBean.confirmPayment()}"
                                               styleClass="btn btn-success"
                                               style="padding: 15px 30px; font-size: 18px; font-weight: bold; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                                    <f:ajax render="@form :messages" />
                                </h:commandButton>
                            </ui:fragment>
                            
                            <!-- Online Payment Info -->
                            <ui:fragment rendered="#{paymentMBean.paymentMethod != 'cod'}">
                            <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                                <p style="margin: 0; color: #1976D2; font-size: 14px; font-weight: 500;">
                                    üì± <strong>Virtual Invoice QR Code</strong> - Scan with your phone to pay
                                </p>
                            </div>
                            
                            <h3 style="color: #2f5061; margin-bottom: 20px;">
                                üí≥ Thanh to√°n Online
                            </h3>
                            
                            <!-- QR Code -->
                            <ui:fragment rendered="#{not empty paymentMBean.qrCodeUrl}">
                                <div style="margin-bottom: 20px;">
                                    <div style="background: white; padding: 15px; border-radius: 8px; display: inline-block; border: 2px solid #3f72af; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                        <img src="#{paymentMBean.qrCodeUrl}" 
                                             alt="Payment QR Code"
                                             style="max-width: 300px; width: 100%; display: block;" />
                                    </div>
                                    <p style="color: #64748b; font-size: 14px; margin-top: 15px; font-weight: 500;">
                                        üì± Scan this QR code with your banking app or payment app
                                    </p>
                                    <p style="color: #999; font-size: 12px; margin-top: 5px;">
                                        Or click the payment link below
                                    </p>
                                </div>
                            </ui:fragment>
                            
                            <!-- Payment URL Button (for VNPay/MoMo) -->
                            <ui:fragment rendered="#{not empty paymentMBean.paymentUrl}">
                                <div style="margin-bottom: 20px;">
                                    <h:commandButton value="üí≥ Pay Online" 
                                                   onclick="window.open('#{paymentMBean.paymentUrl}', '_blank'); return false;"
                                                   styleClass="btn btn-primary"
                                                   style="padding: 12px 24px; font-size: 16px; font-weight: 500;" />
                                    <p style="color: #64748b; font-size: 14px; margin-top: 10px;">
                                        Or click to open payment page in new tab
                                    </p>
                                </div>
                            </ui:fragment>
                            
                            <!-- Online Payment Info -->
                            <ui:fragment rendered="#{paymentMBean.paymentMethod == 'online'}">
                                <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left; border-left: 4px solid #2196F3;">
                                    <h4 style="color: #1976D2; margin-bottom: 10px;">üí≥ Th√¥ng tin thanh to√°n Online:</h4>
                                    <p style="margin: 5px 0;"><strong>Ph∆∞∆°ng th·ª©c:</strong> VNPay / MoMo / Chuy·ªÉn kho·∫£n</p>
                                    <p style="margin: 5px 0;"><strong>S·ªë ti·ªÅn:</strong> <strong style="color: #3f72af; font-size: 16px;">#{paymentMBean.formatAmount(paymentMBean.calculateTotal(paymentMBean.pendingOrder))}</strong></p>
                                    <p style="margin: 5px 0;"><strong>M√£ ƒë∆°n:</strong> ##{paymentMBean.pendingOrder.orderID}</p>
                                    <p style="color: #1976D2; font-size: 13px; margin-top: 10px; font-style: italic;">
                                        üí° B·∫°n c√≥ th·ªÉ qu√©t QR code ho·∫∑c click v√†o n√∫t "Pay Online" ƒë·ªÉ thanh to√°n
                                    </p>
                                </div>
                            </ui:fragment>
                            
                            <!-- Virtual Payment Test (For Project Demo) -->
                            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
                                <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3; margin-bottom: 20px;">
                                    <h4 style="color: #1976D2; margin-bottom: 10px;">üß™ Virtual Payment Test (For Project Demo)</h4>
                                    <p style="color: #1565C0; margin: 0; font-size: 14px;">
                                        Click the button below to simulate a successful payment.
                                        <br/>This will automatically process your order without real payment.
                                    </p>
                                </div>
                                
                                <h:commandButton value="üí≥ Pay Now (Virtual Payment)" 
                                               action="#{paymentMBean.confirmPayment()}"
                                               styleClass="btn btn-success"
                                               style="padding: 15px 30px; font-size: 18px; font-weight: bold; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                                    <f:ajax render="@form :messages" />
                                </h:commandButton>
                                
                                <p style="color: #64748b; font-size: 12px; margin-top: 10px;">
                                    ‚ö†Ô∏è This is a virtual payment for testing purposes only
                                </p>
                            </div>
                            
                            <!-- Manual Payment Confirmation (Alternative) -->
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                                <h4 style="color: #2f5061; margin-bottom: 15px; font-size: 14px;">Or Manual Confirmation:</h4>
                                <p style="color: #64748b; margin-bottom: 15px; font-size: 13px;">
                                    If you have completed the payment via QR code or online, click below to confirm.
                                </p>
                                <h:commandButton value="‚úÖ I have completed payment" 
                                               action="#{paymentMBean.confirmPayment()}"
                                               styleClass="btn btn-outline-success"
                                               style="padding: 10px 20px; font-size: 14px;">
                                    <f:ajax render="@form :messages" />
                                </h:commandButton>
                            </div>
                            
                            <!-- Cancel Payment -->
                            <div style="margin-top: 20px;">
                                <h:commandButton value="‚úñ Cancel Payment" 
                                               action="#{paymentMBean.cancelPayment()}"
                                               styleClass="btn btn-secondary">
                                    <f:ajax render="@form :messages" />
                                </h:commandButton>
                            </div>
                            </ui:fragment>
                        </div>
                    </h:form>
                </h:panelGroup>
            </div>
        </ui:define>
    </ui:composition>
</html>

