<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
      xmlns:ui="jakarta.faces.facelets">

    <ui:composition template="/template.xhtml">

        <ui:define name="title">Qu·∫£n l√Ω T·ªìn kho</ui:define>

        <ui:define name="content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h1 style="margin: 0;">üìä Qu·∫£n l√Ω T·ªìn kho</h1>
                <h:form>
                    <h:commandButton value="‚ûï Qu·∫£n l√Ω T·ªìn kho" actionListener="#{inventoryMBean.prepareCreate}" 
                                    styleClass="btn btn-primary-modern"
                                    style="padding: 14px 35px; font-size: 16px; font-weight: 600; border-radius: 10px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); transition: all 0.3s; cursor: pointer;"
                                    onclick="showModal('inventoryFormModal');">
                        <f:ajax render="inventoryFormModal inventoryTable" 
                                onevent="function(data){if(data.status=='success'){showModal('inventoryFormModal');}}" />
                    </h:commandButton>
                </h:form>
            </div>

            <h:messages globalOnly="true" />
            
            <!-- ========== UNIFIED INVENTORY MODAL (K·∫øt h·ª£p T·∫°o m·ªõi + Nh·∫≠p/Xu·∫•t kho) ========== -->
            <h:panelGroup id="inventoryFormModal">
                <div id="inventoryModalOverlay" 
                     style="display: #{inventoryMBean.showForm ? 'block' : 'none'}; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto; animation: fadeIn 0.3s ease-out;"
                     onclick="if(event.target === this) { closeModal('inventoryFormModal'); }">
                    <div class="form-section" style="background: #ffffff; border-radius: 20px; box-shadow: 0 12px 48px rgba(0,0,0,0.25); padding: 0; margin: 30px auto; max-width: 900px; width: 95%; max-height: 95vh; overflow-y: auto; position: relative; animation: slideUp 0.3s ease-out;">
                        <div style="position: sticky; top: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 35px; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center; z-index: 10; box-shadow: 0 4px 15px rgba(0,0,0,0.15);">
                            <h2 style="margin: 0; font-size: 26px; font-weight: 700;">
                                <h:outputText value="#{inventoryMBean.editMode ? '‚úèÔ∏è C·∫≠p nh·∫≠t T·ªìn kho' : 'üì¶ Qu·∫£n l√Ω T·ªìn kho'}" />
                            </h2>
                            <h:form>
                                <h:commandButton id="closeInventoryFormBtn" value="‚úï" actionListener="#{inventoryMBean.cancelForm}" 
                                                styleClass="btn-close-modal"
                                                style="background: rgba(255,255,255,0.25); border: none; color: white; width: 42px; height: 42px; border-radius: 50%; font-size: 22px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; font-weight: bold;"
                                                title="ƒê√≥ng"
                                                onclick="closeModal('inventoryFormModal');">
                                    <f:ajax render="inventoryFormModal inventoryTable" 
                                            onevent="function(data){if(data.status=='success'){closeModal('inventoryFormModal');}}" />
                                </h:commandButton>
                            </h:form>
                        </div>
                        <div style="padding: 35px;">
                            <h:form styleClass="fu-form">
                                <!-- Section 1: Th√¥ng tin c∆° b·∫£n -->
                                <div style="margin-bottom: 30px; padding-bottom: 25px; border-bottom: 2px solid #e9ecef;">
                                    <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600; color: #495057; display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 24px;">üìã</span> Th√¥ng tin c∆° b·∫£n
                                    </h3>
                                    
                                    <!-- S·∫£n ph·∫©m - H√†ng ri√™ng -->
                                    <div style="margin-bottom: 20px;">
                                        <h:outputLabel value="S·∫£n ph·∫©m:" for="product" style="font-weight: 500; color: #495057; display: block; margin-bottom: 8px;" />
                                        <h:selectOneMenu id="product" value="#{inventoryMBean.selectedProductId}" required="true" styleClass="form-select" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ced4da;">
                                            <f:selectItem itemLabel="-- Ch·ªçn s·∫£n ph·∫©m --" noSelectionOption="true" />
                                            <f:selectItems value="#{inventoryMBean.allProducts}" var="p"
                                                           itemValue="#{p.productID}" itemLabel="#{p.name}" />
                                            <f:ajax event="change" execute="@this" listener="#{inventoryMBean.loadInventoryByProduct()}" render="basicInfoSection minStock" />
                                        </h:selectOneMenu>
                                    </div>

                                    <!-- Th√¥ng tin t·ªìn kho - Hi·ªÉn th·ªã khi ƒë√£ ch·ªçn s·∫£n ph·∫©m -->
                                    <h:panelGroup id="basicInfoSection" rendered="#{not empty inventoryMBean.selected}">
                                        <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; border-left: 4px solid #28a745; margin-bottom: 20px;">
                                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                                <span style="font-size: 20px;">üìä</span>
                                                <span style="font-weight: 600; color: #495057;">Th√¥ng tin t·ªìn kho hi·ªán t·∫°i</span>
                                            </div>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                                <div>
                                                    <span style="font-weight: 500; color: #666; font-size: 14px;">S·ªë l∆∞·ª£ng t·ªìn hi·ªán t·∫°i:</span>
                                                    <div style="font-weight: 700; color: #28a745; font-size: 20px; margin-top: 5px;">
                                                        <h:outputText value="#{inventoryMBean.selected.stock}">
                                                            <f:convertNumber pattern="#,###" />
                                                        </h:outputText>
                                                        <h:outputText value=" (Ch∆∞a c√≥ t·ªìn kho)" 
                                                                     rendered="#{inventoryMBean.selected.productID == null or inventoryMBean.selected.stock == 0}"
                                                                     style="color: #999; font-style: italic; font-size: 12px; margin-left: 8px;">
                                                        </h:outputText>
                                                    </div>
                                                </div>
                                                <div>
                                                    <span style="font-weight: 500; color: #666; font-size: 14px;">T·ªìn t·ªëi thi·ªÉu hi·ªán t·∫°i:</span>
                                                    <div style="font-weight: 700; color: #ff9800; font-size: 20px; margin-top: 5px;">
                                                        <h:outputText value="#{inventoryMBean.selected.minStock}">
                                                            <f:convertNumber pattern="#,###" />
                                                        </h:outputText>
                                                        <h:outputText value=" (Ch∆∞a c√≥ t·ªìn kho)" 
                                                                     rendered="#{inventoryMBean.selected.productID == null or inventoryMBean.selected.minStock == 0}"
                                                                     style="color: #999; font-style: italic; font-size: 12px; margin-left: 8px;">
                                                        </h:outputText>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </h:panelGroup>

                                    <!-- T·ªìn t·ªëi thi·ªÉu - Input ƒë·ªÉ ch·ªânh s·ª≠a -->
                                    <div>
                                        <h:outputLabel value="T·ªìn t·ªëi thi·ªÉu:" for="minStock" style="font-weight: 500; color: #495057; display: block; margin-bottom: 8px;" />
                                        <h:inputText id="minStock" value="#{inventoryMBean.selected.minStock}" required="true" styleClass="form-control" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ced4da;">
                                            <f:passThroughAttribute name="type" value="number" />
                                            <f:passThroughAttribute name="min" value="0" />
                                            <f:passThroughAttribute name="placeholder" value="Nh·∫≠p s·ªë l∆∞·ª£ng t·ªìn t·ªëi thi·ªÉu" />
                                        </h:inputText>
                                        <small style="color: #6c757d; font-size: 12px; margin-top: 5px; display: block;">
                                            üí° S·ªë l∆∞·ª£ng t·ªìn kho s·∫Ω c·∫£nh b√°o khi d∆∞·ªõi m·ª©c n√†y
                                        </small>
                                    </div>
                                </div>

                                <!-- Section 2: Nh·∫≠p/Xu·∫•t kho (T√πy ch·ªçn) -->
                                <div style="margin-bottom: 30px;">
                                    <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600; color: #495057; display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 24px;">üì¶</span> Nh·∫≠p/Xu·∫•t kho <span style="font-size: 14px; font-weight: 400; color: #6c757d;">(T√πy ch·ªçn)</span>
                                    </h3>
                                    <h:panelGroup id="transactionSection">
                                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border: 1px dashed #dee2e6;">
                                            <!-- Lo·∫°i giao d·ªãch -->
                                            <div style="margin-bottom: 15px;">
                                                <h:outputLabel value="Lo·∫°i giao d·ªãch:" for="transactionType" style="font-weight: 500; color: #495057; display: block; margin-bottom: 8px;" />
                                                <h:selectOneMenu id="transactionType" value="#{inventoryMBean.transactionType}" styleClass="form-select" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ced4da;">
                                                    <f:selectItem itemLabel="-- Kh√¥ng th·ª±c hi·ªán giao d·ªãch --" noSelectionOption="true" />
                                                    <f:selectItem itemLabel="üì• Nh·∫≠p kho" itemValue="Import" />
                                                    <f:selectItem itemLabel="üì§ Xu·∫•t kho" itemValue="Export" />
                                                    <f:ajax event="change" execute="@this" render="transactionSection" />
                                                </h:selectOneMenu>
                                            </div>
                                            
                                            <!-- S·ªë l∆∞·ª£ng - H√†ng ri√™ng bi·ªát -->
                                            <h:panelGroup rendered="#{not empty inventoryMBean.transactionType}">
                                                <div style="margin-top: 15px;">
                                                    <h:outputLabel value="S·ªë l∆∞·ª£ng:" for="transactionQuantity" style="font-weight: 500; color: #495057; display: block; margin-bottom: 8px;" />
                                                    <h:inputText id="transactionQuantity" value="#{inventoryMBean.transactionQuantity}" 
                                                                required="#{not empty inventoryMBean.transactionType}"
                                                                styleClass="form-control"
                                                                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ced4da;">
                                                        <f:passThroughAttribute name="type" value="number" />
                                                        <f:passThroughAttribute name="min" value="1" />
                                                        <f:passThroughAttribute name="placeholder" value="Nh·∫≠p s·ªë l∆∞·ª£ng" />
                                                    </h:inputText>
                                                </div>
                                            </h:panelGroup>

                                            <!-- Gi√° nh·∫≠p - H√†ng ri√™ng bi·ªát (ch·ªâ hi·ªán khi ch·ªçn Nh·∫≠p kho) -->
                                            <h:panelGroup rendered="#{inventoryMBean.isImportType()}">
                                                <div style="margin-top: 15px;">
                                                    <h:outputLabel value="Gi√° nh·∫≠p (VNƒê):" for="transactionUnitCost" style="font-weight: 500; color: #495057; display: block; margin-bottom: 8px;" />
                                                    <h:inputText id="transactionUnitCost" value="#{inventoryMBean.transactionUnitCost}" 
                                                                required="#{inventoryMBean.isImportType()}" 
                                                                styleClass="form-control"
                                                                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ced4da;">
                                                        <f:passThroughAttribute name="type" value="number" />
                                                        <f:passThroughAttribute name="min" value="0" />
                                                        <f:passThroughAttribute name="placeholder" value="Nh·∫≠p gi√° nh·∫≠p" />
                                                    </h:inputText>
                                                </div>
                                            </h:panelGroup>

                                            <!-- Nh√† cung c·∫•p -->
                                            <h:panelGroup rendered="#{not empty inventoryMBean.transactionType}">
                                                <div style="margin-top: 15px;">
                                                    <h:outputLabel value="Nh√† cung c·∫•p:" for="transactionSupplier" style="font-weight: 500; color: #495057; display: block; margin-bottom: 8px;" />
                                                    <h:selectOneMenu id="transactionSupplier" value="#{inventoryMBean.transactionSupplierId}" 
                                                                    styleClass="form-select"
                                                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ced4da;">
                                                        <f:selectItem itemLabel="-- Kh√¥ng ch·ªçn --" noSelectionOption="true" />
                                                        <f:selectItems value="#{inventoryMBean.allSuppliers}" var="s"
                                                                       itemValue="#{s.supplierID}" itemLabel="#{s.supplierName}" />
                                                    </h:selectOneMenu>
                                                </div>
                                            </h:panelGroup>

                                            <!-- Ghi ch√∫ -->
                                            <h:panelGroup rendered="#{not empty inventoryMBean.transactionType}">
                                                <div style="margin-top: 15px;">
                                                    <h:outputLabel value="Ghi ch√∫:" for="transactionNote" style="font-weight: 500; color: #495057; display: block; margin-bottom: 8px;" />
                                                    <h:inputTextarea id="transactionNote" value="#{inventoryMBean.transactionNote}" 
                                                                   styleClass="form-control" rows="3"
                                                                   style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ced4da; resize: vertical; font-family: inherit;">
                                                        <f:passThroughAttribute name="placeholder" value="Nh·∫≠p ghi ch√∫ (n·∫øu c√≥)" />
                                                    </h:inputTextarea>
                                                </div>
                                            </h:panelGroup>
                                        </div>
                                    </h:panelGroup>
                                </div>

                                <!-- Action Buttons -->
                                <div style="display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; padding-top: 25px; border-top: 2px solid #e9ecef;">
                                    <h:commandButton value="‚ùå H·ªßy" actionListener="#{inventoryMBean.cancelForm}" 
                                                    styleClass="btn btn-secondary-modern"
                                                    style="padding: 14px 35px; font-size: 15px; font-weight: 600; border-radius: 10px; border: 2px solid #6c757d; background: white; color: #6c757d; transition: all 0.3s; cursor: pointer;"
                                                    onclick="closeModal('inventoryFormModal');">
                                        <f:ajax render="inventoryFormModal inventoryTable" 
                                                onevent="function(data){if(data.status=='success'){closeModal('inventoryFormModal');}}" />
                                    </h:commandButton>
                                    <h:commandButton value="üíæ L∆∞u" actionListener="#{inventoryMBean.save}" 
                                                    styleClass="btn btn-primary-modern"
                                                    style="padding: 14px 35px; font-size: 15px; font-weight: 600; border-radius: 10px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); transition: all 0.3s; cursor: pointer;">
                                        <f:ajax execute="@form" render="inventoryFormModal inventoryTable :messages" 
                                                onevent="function(data){if(data.status=='success' &amp;&amp; !data.responseXML.querySelector('error')){closeModal('inventoryFormModal');}}" />
                                    </h:commandButton>
                                </div>
                            </h:form>
                        </div>
                    </div>
                </div>
            </h:panelGroup>

            <!-- ========== T√åM KI·∫æM - Design ƒë·∫πp h∆°n ========== -->
            <div class="search-section" style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px;">
                <h:form id="searchForm">
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 280px; position: relative; background: white; border-radius: 12px; overflow: hidden;">
                            <h:inputText id="searchInput" 
                                       value="#{inventoryMBean.searchKeyword}" 
                                       styleClass="form-control search-input"
                                       style="width: 100%; padding: 14px 50px 14px 14px; border: none; border-radius: 12px; font-size: 15px; outline: none; background: transparent;">
                                <f:passThroughAttribute name="placeholder" value="T√¨m ki·∫øm theo t√™n s·∫£n ph·∫©m, ID, s·ªë l∆∞·ª£ng t·ªìn, tr·∫°ng th√°i..." />
                                <f:ajax event="keyup" delay="300" listener="#{inventoryMBean.performSearch()}" render="inventoryTable paginationInfo" />
                            </h:inputText>
                            <h:commandButton value="‚úï" 
                                           actionListener="#{inventoryMBean.clearSearch()}"
                                           rendered="#{not empty inventoryMBean.searchKeyword}"
                                           styleClass="btn-clear-search"
                                           style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; padding: 0; background: #f0f0f0; border: none; color: #999; font-size: 16px; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s; font-weight: bold;"
                                           title="X√≥a t√¨m ki·∫øm">
                                <f:ajax render="searchForm inventoryTable paginationInfo" />
                            </h:commandButton>
                        </div>
                        <h:commandButton value="üîç T√¨m ki·∫øm" 
                                       actionListener="#{inventoryMBean.performSearch()}"
                                       styleClass="btn-search-modern"
                                       style="padding: 14px 28px; font-size: 15px; font-weight: 600; border-radius: 12px; border: none; background: white; color: #667eea; box-shadow: 0 4px 12px rgba(255,255,255,0.3); transition: all 0.3s; cursor: pointer; white-space: nowrap;">
                            <f:ajax render="inventoryTable paginationInfo" />
                        </h:commandButton>
                    </div>
                    <h:outputText value="üìä T√¨m th·∫•y: #{inventoryMBean.totalItems} s·∫£n ph·∫©m" 
                                rendered="#{not empty inventoryMBean.searchKeyword}"
                                style="display: block; margin-top: 12px; color: white; font-size: 14px; font-weight: 500; text-align: center; padding: 8px; background: rgba(255,255,255,0.2); border-radius: 8px;" />
                </h:form>
            </div>

            <!-- ========== DANH S√ÅCH INVENTORY ========== -->
            <h:form id="inventoryTable">
                <h:outputText value="Kh√¥ng c√≥ t·ªìn kho n√†o" 
                             rendered="#{empty inventoryMBean.pagedItems}" 
                             style="display: block; text-align: center; padding: 20px; color: #999; font-style: italic; background: #f5f5f5; border-radius: 8px; margin: 20px 0;" />
                <h:dataTable value="#{inventoryMBean.pagedItems}" var="inv" styleClass="table table-striped table-hover table-full-width table-margin-top"
                             border="0"
                             rendered="#{not empty inventoryMBean.pagedItems}">
                    <h:column>
                        <f:facet name="header">ID S·∫£n ph·∫©m</f:facet>
                        #{inv.productID}
                    </h:column>
                    <h:column>
                        <f:facet name="header">T√™n s·∫£n ph·∫©m</f:facet>
                        #{inv.product != null ? inv.product.name : '-'}
                    </h:column>
                    <h:column>
                        <f:facet name="header">S·ªë l∆∞·ª£ng t·ªìn</f:facet>
                        #{inv.stock}
                    </h:column>
                    <h:column>
                        <f:facet name="header">T·ªìn t·ªëi thi·ªÉu</f:facet>
                        #{inv.minStock}
                    </h:column>
                    <h:column>
                        <f:facet name="header">Tr·∫°ng th√°i</f:facet>
                        <h:outputText value="#{inventoryMBean.getStockStatus(inv)}" 
                                     style="color: #{inventoryMBean.getStockStatusColor(inv)}; font-weight: bold;" />
                    </h:column>
                    <h:column>
                        <f:facet name="header">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi</f:facet>
                        #{inv.lastUpdate != null ? inventoryMBean.formatDate(inv.lastUpdate) : '-'}
                    </h:column>
                    <h:column>
                        <f:facet name="header">H√†nh ƒë·ªông</f:facet>
                        <h:commandButton value="‚úèÔ∏è S·ª≠a" actionListener="#{inventoryMBean.prepareEdit(inv)}" 
                                        styleClass="btn btn-soft-primary"
                                        style="margin-right: 5px;"
                                        onclick="showModal('inventoryFormModal');">
                            <f:ajax render="inventoryFormModal inventoryTable" 
                                    onevent="function(data){if(data.status=='success'){showModal('inventoryFormModal');}}" />
                        </h:commandButton>
                        <h:commandButton value="üóëÔ∏è X√≥a" actionListener="#{inventoryMBean.delete(inv)}"
                                         styleClass="btn btn-soft-danger"
                                         onclick="return confirm('X√≥a t·ªìn kho n√†y?');">
                            <f:ajax render="inventoryTable paginationInfo" />
                        </h:commandButton>
                    </h:column>
                </h:dataTable>
                
                <!-- ===== PH√ÇN TRANG ===== -->
                <div class="pagination-container" id="paginationInfo" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: block; width: 100%;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                        <h:outputText value="Trang #{inventoryMBean.currentPage} / #{inventoryMBean.totalPages} (T·ªïng: #{inventoryMBean.totalItems} s·∫£n ph·∫©m)" 
                                     styleClass="pagination-info" 
                                     style="font-weight: 500; color: #333; font-size: 14px;" />
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <h:commandButton value="‚èÆÔ∏è Trang ƒë·∫ßu" actionListener="#{inventoryMBean.firstPage()}" 
                                           styleClass="btn btn-secondary" 
                                           disabled="#{inventoryMBean.currentPage == 1 or inventoryMBean.totalPages le 1}"
                                           style="min-width: 100px;">
                                <f:ajax render="inventoryTable paginationInfo" />
                            </h:commandButton>
                            <h:commandButton value="‚óÄÔ∏è Tr∆∞·ªõc" actionListener="#{inventoryMBean.previousPage()}" 
                                           styleClass="btn btn-secondary" 
                                           disabled="#{inventoryMBean.currentPage == 1 or inventoryMBean.totalPages le 1}"
                                           style="min-width: 80px;">
                                <f:ajax render="inventoryTable paginationInfo" />
                            </h:commandButton>
                            <h:commandButton value="Sau ‚ñ∂Ô∏è" actionListener="#{inventoryMBean.nextPage()}" 
                                           styleClass="btn btn-secondary" 
                                           disabled="#{inventoryMBean.currentPage == inventoryMBean.totalPages or inventoryMBean.totalPages le 1}"
                                           style="min-width: 80px;">
                                <f:ajax render="inventoryTable paginationInfo" />
                            </h:commandButton>
                            <h:commandButton value="Trang cu·ªëi ‚è≠Ô∏è" actionListener="#{inventoryMBean.lastPage()}" 
                                           styleClass="btn btn-secondary" 
                                           disabled="#{inventoryMBean.currentPage == inventoryMBean.totalPages or inventoryMBean.totalPages le 1}"
                                           style="min-width: 100px;">
                                <f:ajax render="inventoryTable paginationInfo" />
                            </h:commandButton>
                        </div>
                    </div>
                </div>
            </h:form>

            <!-- ========== L·ªäCH S·ª¨ GIAO D·ªäCH NH·∫¨P/XU·∫§T KHO ========== -->
            <div style="margin-top: 40px; padding-top: 30px; border-top: 3px solid #e9ecef;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="margin: 0; font-size: 22px; font-weight: 600; color: #495057; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 28px;">üìú</span> L·ªãch s·ª≠ Giao d·ªãch Nh·∫≠p/Xu·∫•t kho
                    </h2>
                </div>

                <!-- T√¨m ki·∫øm l·ªãch s·ª≠ - Design ƒë·∫πp h∆°n -->
                <div class="search-section" style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px;">
                    <h:form id="transactionSearchForm">
                        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 280px; position: relative; background: white; border-radius: 12px; overflow: hidden;">
                                <h:inputText id="transactionSearchInput" 
                                           value="#{inventoryMBean.transactionSearchKeyword}" 
                                           styleClass="form-control search-input"
                                           style="width: 100%; padding: 14px 50px 14px 14px; border: none; border-radius: 12px; font-size: 15px; outline: none; background: transparent;">
                                    <f:passThroughAttribute name="placeholder" value="T√¨m ki·∫øm theo s·∫£n ph·∫©m, lo·∫°i, nh√† cung c·∫•p..." />
                                    <f:ajax event="keyup" delay="300" listener="#{inventoryMBean.performTransactionSearch()}" render="transactionHistoryTable transactionPaginationInfo" />
                                </h:inputText>
                                <h:commandButton value="‚úï" 
                                               actionListener="#{inventoryMBean.clearTransactionSearch()}"
                                               rendered="#{not empty inventoryMBean.transactionSearchKeyword}"
                                               styleClass="btn-clear-search"
                                               style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; padding: 0; background: #f0f0f0; border: none; color: #999; font-size: 16px; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s; font-weight: bold;"
                                               title="X√≥a t√¨m ki·∫øm">
                                    <f:ajax render="transactionSearchForm transactionHistoryTable transactionPaginationInfo" />
                                </h:commandButton>
                            </div>
                            <h:commandButton value="üîç T√¨m ki·∫øm" 
                                           actionListener="#{inventoryMBean.performTransactionSearch()}"
                                           styleClass="btn-search-modern"
                                           style="padding: 14px 28px; font-size: 15px; font-weight: 600; border-radius: 12px; border: none; background: white; color: #667eea; box-shadow: 0 4px 12px rgba(255,255,255,0.3); transition: all 0.3s; cursor: pointer; white-space: nowrap;">
                                <f:ajax render="transactionHistoryTable transactionPaginationInfo" />
                            </h:commandButton>
                        </div>
                        <h:outputText value="üìä T√¨m th·∫•y: #{inventoryMBean.totalTransactions} giao d·ªãch" 
                                    rendered="#{not empty inventoryMBean.transactionSearchKeyword}"
                                    style="display: block; margin-top: 12px; color: white; font-size: 14px; font-weight: 500; text-align: center; padding: 8px; background: rgba(255,255,255,0.2); border-radius: 8px;" />
                    </h:form>
                </div>

                <!-- B·∫£ng l·ªãch s·ª≠ giao d·ªãch -->
                <h:form id="transactionHistoryTable">
                    <h:outputText value="Kh√¥ng c√≥ giao d·ªãch n√†o" 
                                 rendered="#{empty inventoryMBean.pagedTransactionHistory}" 
                                 style="display: block; text-align: center; padding: 30px; color: #999; font-style: italic; background: #f5f5f5; border-radius: 8px; margin: 20px 0;" />
                    <h:dataTable value="#{inventoryMBean.pagedTransactionHistory}" var="trans" 
                                 styleClass="table table-striped table-hover table-full-width"
                                 border="0"
                                 rendered="#{not empty inventoryMBean.pagedTransactionHistory}"
                                 style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h:column>
                            <f:facet name="header">
                                <span style="font-weight: 600; color: #495057;">ID</span>
                            </f:facet>
                            #{trans.transactionID}
                        </h:column>
                        <h:column>
                            <f:facet name="header">
                                <span style="font-weight: 600; color: #495057;">S·∫£n ph·∫©m</span>
                            </f:facet>
                            #{trans.productID != null ? trans.productID.name : '-'}
                        </h:column>
                        <h:column>
                            <f:facet name="header">
                                <span style="font-weight: 600; color: #495057;">Lo·∫°i</span>
                            </f:facet>
                            <h:outputText value="#{inventoryMBean.getTransactionTypeText(trans.type)}" 
                                         style="color: #{inventoryMBean.getTransactionTypeColor(trans.type)}; font-weight: bold;" />
                        </h:column>
                        <h:column>
                            <f:facet name="header">
                                <span style="font-weight: 600; color: #495057;">S·ªë l∆∞·ª£ng</span>
                            </f:facet>
                            <span style="font-weight: 600;">#{trans.quantity}</span>
                        </h:column>
                        <h:column>
                            <f:facet name="header">
                                <span style="font-weight: 600; color: #495057;">Gi√° nh·∫≠p</span>
                            </f:facet>
                            <h:panelGroup>
                                <h:outputText value="#{inventoryMBean.formatCurrency(trans.unitCost)}" 
                                             style="color: #28a745; font-weight: 500;"
                                             rendered="#{trans.unitCost != null and trans.unitCost > 0}" />
                                <h:outputText value="-" 
                                             style="color: #999;"
                                             rendered="#{trans.unitCost == null or trans.unitCost == 0}" />
                            </h:panelGroup>
                        </h:column>
                        <h:column>
                            <f:facet name="header">
                                <span style="font-weight: 600; color: #495057;">Nh√† cung c·∫•p</span>
                            </f:facet>
                            #{trans.supplierID != null ? trans.supplierID.supplierName : '-'}
                        </h:column>
                        <h:column>
                            <f:facet name="header">
                                <span style="font-weight: 600; color: #495057;">Ghi ch√∫</span>
                            </f:facet>
                            <span style="max-width: 200px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                                  title="#{trans.note}">
                                #{trans.note != null and not empty trans.note ? trans.note : '-'}
                            </span>
                        </h:column>
                        <h:column>
                            <f:facet name="header">
                                <span style="font-weight: 600; color: #495057;">Th·ªùi gian</span>
                            </f:facet>
                            #{trans.createdAt != null ? inventoryMBean.formatDate(trans.createdAt) : '-'}
                        </h:column>
                    </h:dataTable>
                    
                    <!-- Ph√¢n trang l·ªãch s·ª≠ -->
                    <div class="pagination-container" id="transactionPaginationInfo" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: block; width: 100%;">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                            <h:outputText value="Trang #{inventoryMBean.transactionCurrentPage} / #{inventoryMBean.totalTransactionPages} (T·ªïng: #{inventoryMBean.totalTransactions} giao d·ªãch)" 
                                         styleClass="pagination-info" 
                                         style="font-weight: 500; color: #333; font-size: 14px;" />
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <h:commandButton value="‚èÆÔ∏è Trang ƒë·∫ßu" actionListener="#{inventoryMBean.transactionFirstPage()}" 
                                               styleClass="btn btn-secondary" 
                                               disabled="#{inventoryMBean.transactionCurrentPage == 1 or inventoryMBean.totalTransactionPages le 1}"
                                               style="min-width: 100px;">
                                    <f:ajax render="transactionHistoryTable transactionPaginationInfo" />
                                </h:commandButton>
                                <h:commandButton value="‚óÄÔ∏è Tr∆∞·ªõc" actionListener="#{inventoryMBean.transactionPreviousPage()}" 
                                               styleClass="btn btn-secondary" 
                                               disabled="#{inventoryMBean.transactionCurrentPage == 1 or inventoryMBean.totalTransactionPages le 1}"
                                               style="min-width: 80px;">
                                    <f:ajax render="transactionHistoryTable transactionPaginationInfo" />
                                </h:commandButton>
                                <h:commandButton value="Sau ‚ñ∂Ô∏è" actionListener="#{inventoryMBean.transactionNextPage()}" 
                                               styleClass="btn btn-secondary" 
                                               disabled="#{inventoryMBean.transactionCurrentPage == inventoryMBean.totalTransactionPages or inventoryMBean.totalTransactionPages le 1}"
                                               style="min-width: 80px;">
                                    <f:ajax render="transactionHistoryTable transactionPaginationInfo" />
                                </h:commandButton>
                                <h:commandButton value="Trang cu·ªëi ‚è≠Ô∏è" actionListener="#{inventoryMBean.transactionLastPage()}" 
                                               styleClass="btn btn-secondary" 
                                               disabled="#{inventoryMBean.transactionCurrentPage == inventoryMBean.totalTransactionPages or inventoryMBean.totalTransactionPages le 1}"
                                               style="min-width: 100px;">
                                    <f:ajax render="transactionHistoryTable transactionPaginationInfo" />
                                </h:commandButton>
                            </div>
                        </div>
                    </div>
                </h:form>
            </div>

            <br/>
        </ui:define>
    </ui:composition>
    
    <h:outputScript>
        <![CDATA[
            function showModal(modalId) {
                var overlayId = modalId.replace('FormModal', 'ModalOverlay');
                var modal = document.getElementById(overlayId);
                if (modal) {
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                    document.body.classList.add('modal-open');
                }
            }
            
            function closeModal(modalId) {
                var overlayId = modalId.replace('FormModal', 'ModalOverlay');
                var modal = document.getElementById(overlayId);
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    document.body.classList.remove('modal-open');
                }
            }
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    var modals = document.querySelectorAll('[id$="ModalOverlay"]');
                    modals.forEach(function(modal) {
                        if (modal.style.display === 'block') {
                            closeModal(modal.id.replace('ModalOverlay', 'FormModal'));
                        }
                    });
                }
            });
        ]]>
    </h:outputScript>
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .btn-close-modal:hover {
            background: rgba(255,255,255,0.3) !important;
            transform: rotate(90deg);
        }
        
        body.modal-open {
            overflow: hidden;
        }
        
        .btn-clear-search:hover {
            background: #e0e0e0 !important;
            color: #667eea !important;
            transform: translateY(-50%) rotate(90deg) !important;
        }
        
        .btn-search-modern:hover {
            background: #f8f9fa !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255,255,255,0.4) !important;
        }
        
        .search-input:focus {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
    </style>
</html>

