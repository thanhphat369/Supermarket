<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
      xmlns:ui="jakarta.faces.facelets">

    <ui:composition template="/template.xhtml">

        <ui:define name="title">Qu·∫£n l√Ω ƒê∆°n h√†ng</ui:define>

        <ui:define name="content">
            <h1>üìã Qu·∫£n l√Ω ƒê∆°n h√†ng</h1>

            <h:messages globalOnly="true" />
            
            <!-- ========== T√åM KI·∫æM V√Ä L·ªåC - Design ƒë·∫πp h∆°n ========== -->
            <div class="search-section" style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px;">
                <h:form id="searchForm">
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 280px; position: relative; background: white; border-radius: 12px; overflow: hidden;">
                            <h:inputText id="searchInput" 
                                       value="#{orderMBean.searchKeyword}" 
                                       styleClass="form-control search-input"
                                       style="width: 100%; padding: 14px 50px 14px 14px; border: none; border-radius: 12px; font-size: 15px; outline: none; background: transparent;">
                                <f:passThroughAttribute name="placeholder" value="T√¨m ki·∫øm theo ID, t√™n kh√°ch h√†ng..." />
                                <f:ajax event="keyup" delay="300" listener="#{orderMBean.performSearch()}" render="orderTable paginationInfo" />
                            </h:inputText>
                            <h:commandButton value="‚úï" 
                                           actionListener="#{orderMBean.clearSearch()}"
                                           rendered="#{not empty orderMBean.searchKeyword}"
                                           styleClass="btn-clear-search"
                                           style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; padding: 0; background: #f0f0f0; border: none; color: #999; font-size: 16px; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s; font-weight: bold;"
                                           title="X√≥a t√¨m ki·∫øm">
                                <f:ajax render="searchForm orderTable paginationInfo" />
                            </h:commandButton>
                        </div>
                        <h:selectOneMenu value="#{orderMBean.statusFilter}" 
                                       styleClass="form-select" 
                                       style="min-width: 150px; padding: 14px; border-radius: 12px; border: none; background: white; font-size: 15px; outline: none;">
                            <f:selectItem itemValue="all" itemLabel="T·∫•t c·∫£ tr·∫°ng th√°i" />
                            <f:selectItem itemValue="pending" itemLabel="ƒêang ch·ªù" />
                            <f:selectItem itemValue="processing" itemLabel="ƒêang x·ª≠ l√Ω" />
                            <f:selectItem itemValue="completed" itemLabel="Ho√†n th√†nh" />
                            <f:selectItem itemValue="cancelled" itemLabel="ƒê√£ h·ªßy" />
                            <f:ajax event="change" listener="#{orderMBean.performSearch()}" render="orderTable paginationInfo" />
                        </h:selectOneMenu>
                        <h:commandButton value="üîç T√¨m ki·∫øm" 
                                       actionListener="#{orderMBean.performSearch()}"
                                       styleClass="btn-search-modern"
                                       style="padding: 14px 28px; font-size: 15px; font-weight: 600; border-radius: 12px; border: none; background: white; color: #667eea; box-shadow: 0 4px 12px rgba(255,255,255,0.3); transition: all 0.3s; cursor: pointer; white-space: nowrap;">
                            <f:ajax render="orderTable paginationInfo" />
                        </h:commandButton>
                        <h:commandButton value="‚úï X√≥a" 
                                       actionListener="#{orderMBean.clearSearch()}"
                                       styleClass="btn-search-modern"
                                       rendered="#{not empty orderMBean.searchKeyword or (not empty orderMBean.statusFilter and orderMBean.statusFilter != 'all')}"
                                       style="padding: 14px 28px; font-size: 15px; font-weight: 600; border-radius: 12px; border: none; background: rgba(255,255,255,0.9); color: #dc3545; box-shadow: 0 4px 12px rgba(255,255,255,0.3); transition: all 0.3s; cursor: pointer; white-space: nowrap;">
                            <f:ajax render="searchForm orderTable paginationInfo" />
                        </h:commandButton>
                    </div>
                    <h:outputText value="üìä T√¨m th·∫•y: #{orderMBean.totalItems} ƒë∆°n h√†ng" 
                                rendered="#{not empty orderMBean.searchKeyword or (not empty orderMBean.statusFilter and orderMBean.statusFilter != 'all')}"
                                style="display: block; margin-top: 12px; color: white; font-size: 14px; font-weight: 500; text-align: center; padding: 8px; background: rgba(255,255,255,0.2); border-radius: 8px;" />
                </h:form>
            </div>

            <!-- ========== DANH S√ÅCH ORDER ========== -->
            <h:form id="orderTable">
                <h:outputText value="Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o" 
                             rendered="#{empty orderMBean.pagedItems}" 
                             style="display: block; text-align: center; padding: 20px; color: #999; font-style: italic; background: #f5f5f5; border-radius: 8px; margin: 20px 0;" />
                <h:dataTable value="#{orderMBean.pagedItems}" var="o" styleClass="table table-striped table-hover table-full-width table-margin-top"
                             border="0"
                             rendered="#{not empty orderMBean.pagedItems}">
                    <h:column>
                        <f:facet name="header">ID</f:facet>
                        #{o.orderID}
                    </h:column>
                    <h:column>
                        <f:facet name="header">Ng√†y ƒë·∫∑t</f:facet>
                        #{orderMBean.formatDate(o.orderDate)}
                    </h:column>
                    <h:column>
                        <f:facet name="header">Kh√°ch h√†ng</f:facet>
                        #{o.userID != null ? (o.userID.fullName != null ? o.userID.fullName : o.userID.userName) : '-'}
                    </h:column>
                    <h:column>
                        <f:facet name="header">T·ªïng ti·ªÅn</f:facet>
                        #{orderMBean.formatAmount(o.totalAmount)}
                    </h:column>
                    <h:column>
                        <f:facet name="header">Tr·∫°ng th√°i</f:facet>
                        <h:outputText value="#{o.status}" 
                                     style="color: #{orderMBean.getStatusColor(o.status)}; font-weight: bold;" />
                    </h:column>
                    <h:column>
                        <f:facet name="header">H√†nh ƒë·ªông</f:facet>
                        <h:commandButton value="üìã Detail" actionListener="#{orderMBean.viewDetails(o)}" styleClass="btn btn-soft-primary">
                            <f:ajax render="orderDetailsSection" />
                        </h:commandButton>
                        <h:selectOneMenu value="#{o.status}" styleClass="form-select" style="min-width: 120px; display: inline-block;">
                            <f:selectItem itemValue="pending" itemLabel="Pending" />
                            <f:selectItem itemValue="processing" itemLabel="Processing" />
                            <f:selectItem itemValue="completed" itemLabel="Completed" />
                            <f:selectItem itemValue="cancelled" itemLabel="Cancelled" />
                            <f:ajax event="change" listener="#{orderMBean.updateStatus(o)}" render="orderTable :messages" />
                        </h:selectOneMenu>
                    </h:column>
                </h:dataTable>
                
                <!-- ===== PH√ÇN TRANG ===== -->
                <div class="pagination-container" id="paginationInfo" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: block; width: 100%;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                        <h:outputText value="Trang #{orderMBean.currentPage} / #{orderMBean.totalPages} (T·ªïng: #{orderMBean.totalItems} ƒë∆°n h√†ng)" 
                                     styleClass="pagination-info" 
                                     style="font-weight: 500; color: #333; font-size: 14px;" />
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <h:commandButton value="‚èÆÔ∏è Trang ƒë·∫ßu" actionListener="#{orderMBean.firstPage()}" 
                                           styleClass="btn btn-secondary" 
                                           disabled="#{orderMBean.currentPage == 1 or orderMBean.totalPages le 1}"
                                           style="min-width: 100px;">
                                <f:ajax render="orderTable paginationInfo" />
                            </h:commandButton>
                            <h:commandButton value="‚óÄÔ∏è Tr∆∞·ªõc" actionListener="#{orderMBean.previousPage()}" 
                                           styleClass="btn btn-secondary" 
                                           disabled="#{orderMBean.currentPage == 1 or orderMBean.totalPages le 1}"
                                           style="min-width: 80px;">
                                <f:ajax render="orderTable paginationInfo" />
                            </h:commandButton>
                            <h:commandButton value="Sau ‚ñ∂Ô∏è" actionListener="#{orderMBean.nextPage()}" 
                                           styleClass="btn btn-secondary" 
                                           disabled="#{orderMBean.currentPage == orderMBean.totalPages or orderMBean.totalPages le 1}"
                                           style="min-width: 80px;">
                                <f:ajax render="orderTable paginationInfo" />
                            </h:commandButton>
                            <h:commandButton value="Trang cu·ªëi ‚è≠Ô∏è" actionListener="#{orderMBean.lastPage()}" 
                                           styleClass="btn btn-secondary" 
                                           disabled="#{orderMBean.currentPage == orderMBean.totalPages or orderMBean.totalPages le 1}"
                                           style="min-width: 100px;">
                                <f:ajax render="orderTable paginationInfo" />
                            </h:commandButton>
                        </div>
                    </div>
                </div>
            </h:form>

            <!-- ========== CHI TI·∫æT ƒê∆†N H√ÄNG ========== -->
            <div id="orderDetailsSection" style="margin-top: 30px;">
                <h:panelGroup rendered="#{orderMBean.selected != null}">
                    <div class="form-section" style="background: #fff; border: 2px solid #3f72af;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; color: #3f72af;">üìã Chi ti·∫øt ƒê∆°n h√†ng ##{orderMBean.selected.orderID}</h2>
                            <h:commandButton value="‚úñ ƒê√≥ng" actionListener="#{orderMBean.closeDetails}" styleClass="btn btn-secondary">
                                <f:ajax render="orderDetailsSection" />
                            </h:commandButton>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <p><strong>Kh√°ch h√†ng:</strong> #{orderMBean.selected.userID != null ? (orderMBean.selected.userID.fullName != null ? orderMBean.selected.userID.fullName : orderMBean.selected.userID.userName) : '-'}</p>
                            <p><strong>Ng√†y ƒë·∫∑t:</strong> #{orderMBean.formatDate(orderMBean.selected.orderDate)}</p>
                            <p><strong>T·ªïng ti·ªÅn:</strong> #{orderMBean.formatAmount(orderMBean.selected.totalAmount)}</p>
                            <p><strong>Tr·∫°ng th√°i:</strong> 
                                <span style="color: #{orderMBean.getStatusColor(orderMBean.selected.status)}; font-weight: bold;">
                                    #{orderMBean.selected.status}
                                </span>
                            </p>
                        </div>
                        
                        <h3 style="color: #3f72af; margin-bottom: 15px;">Danh s√°ch s·∫£n ph·∫©m:</h3>
                        <h:dataTable value="#{orderMBean.selected.orderDetailsCollection}" var="od" 
                                     styleClass="table table-striped table-hover"
                                     rendered="#{not empty orderMBean.selected.orderDetailsCollection}">
                            <h:column>
                                <f:facet name="header">ID</f:facet>
                                #{od.oDetailID}
                            </h:column>
                            <h:column>
                                <f:facet name="header">S·∫£n ph·∫©m</f:facet>
                                #{od.productID != null ? od.productID.name : '-'}
                            </h:column>
                            <h:column>
                                <f:facet name="header">S·ªë l∆∞·ª£ng</f:facet>
                                #{od.quantity}
                            </h:column>
                            <h:column>
                                <f:facet name="header">ƒê∆°n gi√°</f:facet>
                                #{orderMBean.formatAmount(od.unitPrice)}
                            </h:column>
                            <h:column>
                                <f:facet name="header">Th√†nh ti·ªÅn</f:facet>
                                #{orderMBean.formatAmount(od.quantity * od.unitPrice)}
                            </h:column>
                            <h:column>
                                <f:facet name="header">ƒê·ªãa ch·ªâ giao h√†ng</f:facet>
                                #{od.shipAddress != null ? od.shipAddress : '-'}
                            </h:column>
                        </h:dataTable>
                        <h:outputText value="Kh√¥ng c√≥ chi ti·∫øt n√†o" 
                                     rendered="#{empty orderMBean.selected.orderDetailsCollection}" 
                                     style="display: block; text-align: center; padding: 20px; color: #999; font-style: italic;" />
                    </div>
                </h:panelGroup>
            </div>

            <br/>
        </ui:define>
    </ui:composition>
    
    <style>
        .btn-clear-search:hover {
            background: #e0e0e0 !important;
            color: #667eea !important;
            transform: translateY(-50%) rotate(90deg) !important;
        }
        
        .btn-search-modern:hover {
            background: #f8f9fa !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255,255,255,0.4) !important;
        }
        
        .search-input:focus {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
    </style>
</html>

