<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:ui="jakarta.faces.facelets"
      xmlns:f="jakarta.faces.core">

    <ui:composition template="/template.xhtml">
        <ui:define name="title">üë§ Th√¥ng tin c√° nh√¢n</ui:define>

        <ui:define name="content">
            <h:outputStylesheet library="css" name="style.css" />
            
            <div class="page-container">
                <h1 class="page-title">üë§ H·ªì s∆° c√° nh√¢n</h1>

                <!-- Th√¥ng b√°o -->
                <h:messages globalOnly="true" styleClass="messages" />
            
            <!-- Form section - nh·ªè g·ªçn ·ªü gi·ªØa -->
            <div class="form-section">
                <h2>Th√¥ng tin c√° nh√¢n</h2>
                
                <h:form rendered="#{loginMBean.currentUser != null}" enctype="multipart/form-data" styleClass="fu-form">

                    <h:panelGrid columns="2" columnClasses="label,value" cellpadding="6">

                    <h:outputLabel value="T√™n ƒëƒÉng nh·∫≠p:" />
                    <h:outputText value="#{loginMBean.currentUser.userName}" />

                    <h:outputLabel value="H·ªç v√† t√™n:" />
                    <h:panelGroup>
                        <h:inputText value="#{loginMBean.currentUser.fullName}" 
                                     rendered="#{profileDetailMBean.editMode}"
                                     styleClass="form-control" />
                        <h:outputText value="#{loginMBean.currentUser.fullName}" 
                                      rendered="#{!profileDetailMBean.editMode}" />
                    </h:panelGroup>

                    <h:outputLabel value="Email:" />
                    <h:panelGroup>
                        <h:inputText value="#{loginMBean.currentUser.email}" 
                                     rendered="#{profileDetailMBean.editMode}"
                                     styleClass="form-control" />
                        <h:outputText value="#{loginMBean.currentUser.email}" 
                                      rendered="#{!profileDetailMBean.editMode}" />
                    </h:panelGroup>

                    <h:outputLabel value="S·ªë ƒëi·ªán tho·∫°i:" />
                    <h:panelGroup>
                        <h:inputText value="#{loginMBean.currentUser.phone}" 
                                     rendered="#{profileDetailMBean.editMode}"
                                     styleClass="form-control" />
                        <h:outputText value="#{loginMBean.currentUser.phone}" 
                                      rendered="#{!profileDetailMBean.editMode}" />
                    </h:panelGroup>

                    <h:outputLabel value="ƒê·ªãa ch·ªâ:" />
                    <h:panelGroup>
                        <h:inputText value="#{loginMBean.currentUser.address}" 
                                     rendered="#{profileDetailMBean.editMode}"
                                     styleClass="form-control">
                            <f:passThroughAttribute name="placeholder" value="Nh·∫≠p ƒë·ªãa ch·ªâ" />
                        </h:inputText>
                        <h:outputText value="#{loginMBean.currentUser.address}" 
                                      rendered="#{!profileDetailMBean.editMode}" />
                    </h:panelGroup>

                    <h:outputLabel value="M·∫≠t kh·∫©u:" />
                    <h:panelGroup>
                        <h:panelGroup rendered="#{profileDetailMBean.editMode}">
                            <div style="margin-bottom: 10px;">
                                <h:outputLabel value="M·∫≠t kh·∫©u c≈©:" for="oldPassword" style="font-size: 0.9em; display: block; margin-bottom: 3px;" />
                                <h:inputSecret id="oldPassword"
                                             value="#{profileDetailMBean.oldPassword}" 
                                             styleClass="form-control">
                                    <f:passThroughAttribute name="placeholder" value="Nh·∫≠p m·∫≠t kh·∫©u c≈© (n·∫øu mu·ªën ƒë·ªïi)" />
                                </h:inputSecret>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <h:outputLabel value="M·∫≠t kh·∫©u m·ªõi:" for="newPassword" style="font-size: 0.9em; display: block; margin-bottom: 3px;" />
                                <h:inputSecret id="newPassword"
                                             value="#{profileDetailMBean.newPassword}" 
                                             styleClass="form-control">
                                    <f:passThroughAttribute name="placeholder" value="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (t·ªëi thi·ªÉu 6 k√Ω t·ª±)" />
                                </h:inputSecret>
                            </div>
                            <div>
                                <h:outputLabel value="X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi:" for="confirmPassword" style="font-size: 0.9em; display: block; margin-bottom: 3px;" />
                                <h:inputSecret id="confirmPassword"
                                             value="#{profileDetailMBean.confirmPassword}" 
                                             styleClass="form-control">
                                    <f:passThroughAttribute name="placeholder" value="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" />
                                </h:inputSecret>
                            </div>
                            <small class="form-text text-muted" style="display: block; margin-top: 8px; font-style: italic;">
                                üí° ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën ƒë·ªïi m·∫≠t kh·∫©u
                            </small>
                        </h:panelGroup>
                        <h:panelGroup rendered="#{!profileDetailMBean.editMode}">
                            <h:outputText value="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                          style="font-family: monospace; font-size: 1em;" />
                            <br/>
                            <small class="text-muted" style="font-style: italic;">(Nh·∫•n ch·ªânh s·ª≠a ƒë·ªÉ ƒë·ªïi m·∫≠t kh·∫©u)</small>
                        </h:panelGroup>
                    </h:panelGroup>

                    <h:outputLabel value="Vai tr√≤ (Role):" />
                    <h:panelGroup>
                        <h:outputText value="#{loginMBean.currentUser.roleID.roleName}"
                                      styleClass="profile-role-text" />
                        <br/>
                        <h:outputText value="(Kh√¥ng th·ªÉ thay ƒë·ªïi)" 
                                      style="font-size: 0.9em; color: #999; font-style: italic;" />
                    </h:panelGroup>

                    <h:outputLabel value="·∫¢nh ƒë·∫°i di·ªán:" />
                    <h:panelGroup layout="block" id="avatarPanel" style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                        <!-- Container cho avatar - lu√¥n c√≥ trong DOM ƒë·ªÉ JavaScript ho·∫°t ƒë·ªông -->
                        <div class="avatar-container" style="position: relative; width: 150px; height: 150px; display: flex; align-items: center; justify-content: center;">
                            <!-- Avatar hi·ªán c√≥ trong DB - lu√¥n c√≥ trong DOM, hi·ªÉn th·ªã khi c√≥ avatar v√† kh√¥ng c√≥ preview -->
                            <img src="#{profileDetailMBean.currentUserAvatarUrl}"
                                 id="existingAvatar"
                                 alt="Avatar"
                                 style="display: #{not empty loginMBean.currentUser.avatar ? 'block' : 'none'}; max-width: 150px; max-height: 150px; width: auto; height: auto; object-fit: contain; border-radius: 50%; border: 3px solid #3f72af; box-shadow: 0 4px 12px rgba(0,0,0,0.15); background-color: #f5f5f5;"
                                 onerror="console.error('Avatar load error:', this.src); this.style.display='none'; var noAvatar = document.getElementById('noAvatarText'); if(noAvatar) noAvatar.style.display='block';" />
                            
                            <!-- Preview avatar khi ch·ªçn file m·ªõi - lu√¥n c√≥ trong DOM -->
                            <img id="avatarPreview" 
                                 src="" 
                                 class="avatar-preview-hidden"
                                 style="display: none; max-width: 150px; max-height: 150px; width: auto; height: auto; object-fit: contain; border-radius: 50%; border: 3px solid #3f72af; box-shadow: 0 4px 12px rgba(0,0,0,0.15); position: absolute; top: 0; left: 0; background-color: #f5f5f5;"
                                 alt="Preview" />

                            <!-- Text "Ch∆∞a c√≥ ·∫£nh" - lu√¥n c√≥ trong DOM -->
                            <h:outputText value="Ch∆∞a c√≥ ·∫£nh" 
                                          id="noAvatarText"
                                          style="display: #{empty loginMBean.currentUser.avatar and empty profileDetailMBean.previewImageBase64 ? 'block' : 'none'}; color: #999; font-style: italic; text-align: center;" />
                        </div>

                        <!-- Input file ƒë·ªÉ ch·ªçn h√¨nh - ch·ªâ hi·ªán khi edit mode -->
                        <h:inputFile value="#{profileDetailMBean.uploadedFile}" 
                                     id="avatarFileInput"
                                     rendered="#{profileDetailMBean.editMode}"
                                     styleClass="avatar-input"
                                     onchange="previewAvatar(this, 'avatarPreview', 'existingAvatar', 'noAvatarText');" />
                    </h:panelGroup>
                </h:panelGrid>

                <!-- Buttons -->
                <div class="text-center" style="margin-top: 20px;">
                    <h:commandButton value="‚úèÔ∏è Ch·ªânh s·ª≠a"
                                     actionListener="#{profileDetailMBean.enableEdit}"
                                     rendered="#{!profileDetailMBean.editMode}"
                                     styleClass="btn btn-edit">
                        <f:ajax execute="@this" render="@form avatarPanel" />
                    </h:commandButton>

                    <h:commandButton value="üíæ L∆∞u"
                                     actionListener="#{profileDetailMBean.saveProfile}"
                                     rendered="#{profileDetailMBean.editMode}"
                                     styleClass="btn btn-save">
                        <f:ajax execute="@form" render="@form :messages avatarPanel" 
                                onevent="function(data){if(data.status=='success'){hidePreview();}}" />
                    </h:commandButton>

                    <h:commandButton value="‚ùå H·ªßy"
                                     actionListener="#{profileDetailMBean.cancelEdit}"
                                     rendered="#{profileDetailMBean.editMode}"
                                     styleClass="btn btn-cancel">
                        <f:ajax execute="@this" render="@form avatarPanel" />
                    </h:commandButton>
                </div>
            </h:form>
            </div>
            
                
                <h:panelGroup rendered="#{loginMBean.currentUser == null}">
                    <p>‚ö†Ô∏è B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p! H√£y <h:link outcome="login" value="ƒëƒÉng nh·∫≠p t·∫°i ƒë√¢y" />.</p>
                </h:panelGroup>
            </div>

            <!-- ‚úÖ FIXED SCRIPT: d√πng CDATA ƒë·ªÉ tr√°nh l·ªói "&" -->
            <h:outputScript>
                <![CDATA[
                    function previewAvatar(input, previewId, existingId, noAvatarId) {
                        if (input.files) {
                            if (input.files[0]) {
                            var reader = new FileReader();
                            reader.onload = function(e) {
                                var preview = document.getElementById(previewId);
                                var existing = document.getElementById(existingId);
                                var noAvatar = document.getElementById(noAvatarId);
                                
                                // Hi·ªÉn th·ªã preview v√† ·∫©n existing avatar
                                if (preview) {
                                    preview.src = e.target.result;
                                    preview.style.display = 'block';
                                    preview.style.maxWidth = '150px';
                                    preview.style.maxHeight = '150px';
                                    preview.style.width = 'auto';
                                    preview.style.height = 'auto';
                                    preview.style.objectFit = 'contain';
                                    preview.style.borderRadius = '50%';
                                    preview.style.border = '3px solid #3f72af';
                                    preview.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                                    preview.classList.remove('avatar-preview-hidden');
                                }
                                if (existing) {
                                    existing.style.display = 'none';
                                }
                                if (noAvatar) {
                                    noAvatar.style.display = 'none';
                                }
                            };
                            reader.readAsDataURL(input.files[0]);
                            }
                        } else {
                            // N·∫øu kh√¥ng ch·ªçn file, hi·ªÉn th·ªã l·∫°i avatar c≈©
                            var preview = document.getElementById(previewId);
                            var existing = document.getElementById(existingId);
                            if (preview) {
                                preview.style.display = 'none';
                                preview.classList.add('avatar-preview-hidden');
                            }
                            if (existing) {
                                if (existing.src) {
                                    existing.style.display = 'block';
                                }
                            }
                        }
                    }

                    function hidePreview() {
                        var preview = document.getElementById('avatarPreview');
                        var existing = document.getElementById('existingAvatar');
                        var noAvatar = document.getElementById('noAvatarText');
                        if (preview) {
                            preview.style.display = 'none';
                            preview.classList.add('avatar-preview-hidden');
                        }
                        if (existing) {
                            if (existing.src) {
                                existing.style.display = 'block';
                            }
                        }
                        // Hi·ªÉn th·ªã "Ch∆∞a c√≥ ·∫£nh" n·∫øu kh√¥ng c√≥ avatar
                        if (noAvatar) {
                            if (!existing) {
                                noAvatar.style.display = 'block';
                            } else {
                                if (!existing.src) {
                                    noAvatar.style.display = 'block';
                                } else {
                                    if (existing.style.display === 'none') {
                                        noAvatar.style.display = 'block';
                                    }
                                }
                            }
                        }
                    }
                ]]>
            </h:outputScript>
        </ui:define>
    </ui:composition>
</html>
