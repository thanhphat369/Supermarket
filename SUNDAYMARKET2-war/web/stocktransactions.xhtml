<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:ui="jakarta.faces.facelets"
      xmlns:pt="jakarta.faces.passthrough">
    
    <ui:composition template="/template/template.xhtml">
        <ui:define name="title">üì¶ Qu·∫£n l√Ω Kho</ui:define>
        
        <ui:define name="content">
            <h:messages id="messages" globalOnly="true" styleClass="alert alert-info" />
            
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; color: #2c3e50;">üì¶ Qu·∫£n l√Ω Kho</h2>
                <h:form id="headerForm">
                    <h:commandButton value="‚ûï Nh·∫≠p/Xu·∫•t kho" actionListener="#{stockTransactionsMBean.prepareCreate}"
                                    style="background: linear-gradient(135deg, #28a745, #20c997); border: none; padding: 12px 24px; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                        <f:ajax render=":transactionForm:transactionFormModal :stockForm :historyForm"
                                onevent="function(data){if(data.status=='success'){showModal('transactionModalOverlay');}}" />
                    </h:commandButton>
                </h:form>
            </div>
            
            <!-- TH·ªêNG K√ä T·ªíN KHO -->
            <h:form id="statsForm">
                <h:panelGroup id="statsWrapper">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #3f72af, #5a95cf); padding: 20px; border-radius: 12px; color: white;">
                            <div style="font-size: 14px; opacity: 0.9;">üìä T·ªïng s·ªë l∆∞·ª£ng t·ªìn</div>
                            <div style="font-size: 28px; font-weight: 700; margin-top: 5px;">#{stockTransactionsMBean.totalStockQuantity}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #28a745, #20c997); padding: 20px; border-radius: 12px; color: white;">
                            <div style="font-size: 14px; opacity: 0.9;">üì¶ T·ªïng s·∫£n ph·∫©m</div>
                            <div style="font-size: 28px; font-weight: 700; margin-top: 5px;">#{stockTransactionsMBean.totalProducts}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ffc107, #ffca2c); padding: 20px; border-radius: 12px; color: #333;">
                            <div style="font-size: 14px; opacity: 0.9;">‚ö†Ô∏è S·∫Øp h·∫øt h√†ng</div>
                            <div style="font-size: 28px; font-weight: 700; margin-top: 5px;">#{stockTransactionsMBean.lowStockCount}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #dc3545, #e4606d); padding: 20px; border-radius: 12px; color: white;">
                            <div style="font-size: 14px; opacity: 0.9;">‚ùå H·∫øt h√†ng</div>
                            <div style="font-size: 28px; font-weight: 700; margin-top: 5px;">#{stockTransactionsMBean.outOfStockCount}</div>
                        </div>
                    </div>
                </h:panelGroup>
            </h:form>
            
            <!-- B·∫¢NG T·ªíN KHO S·∫¢N PH·∫®M -->
            <h:form id="stockForm">
                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
                    <h3 style="margin: 0 0 20px 0; color: #2c3e50; border-bottom: 2px solid #3f72af; padding-bottom: 10px;">
                        üìã T·ªìn kho s·∫£n ph·∫©m
                    </h3>
                    
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                        <h:inputText id="stockSearch" value="#{stockTransactionsMBean.stockSearchKeyword}"
                                    pt:placeholder="üîç T√¨m theo t√™n s·∫£n ph·∫©m..."
                                    style="flex: 1; min-width: 250px; max-width: 400px; padding: 12px 16px; border-radius: 8px; border: 1px solid #ced4da; font-size: 14px;">
                            <f:ajax event="keyup" delay="300" listener="#{stockTransactionsMBean.searchStock}" render="stockWrapper" />
                        </h:inputText>
                        <h:commandButton value="‚öôÔ∏è Set m·∫∑c ƒë·ªãnh t·ªìn t·ªëi thi·ªÉu" 
                                        actionListener="#{stockTransactionsMBean.initAllMinStock}"
                                        style="padding: 10px 15px; border: none; background: #6c757d; color: white; border-radius: 8px; cursor: pointer; font-size: 13px;">
                            <f:ajax execute="@form" render="stockWrapper :statsForm:statsWrapper :messages" />
                        </h:commandButton>
                    </div>
                    
                    <h:panelGroup id="stockWrapper">
                        <h:dataTable value="#{stockTransactionsMBean.pagedProductsWithStock}" var="product" 
                                    styleClass="table table-striped" style="width: 100%;"
                                    rendered="#{not empty stockTransactionsMBean.pagedProductsWithStock}">
                            
                            <h:column>
                                <f:facet name="header">ID</f:facet>
                                #{product.productID}
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">S·∫£n ph·∫©m</f:facet>
                                #{product.name}
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">Th∆∞∆°ng hi·ªáu</f:facet>
                                #{product.brandID.brandName}
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">Danh m·ª•c</f:facet>
                                #{product.categoryID.categoryName}
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">S·ªë l∆∞·ª£ng t·ªìn</f:facet>
                                <h:outputText value="#{product.quantity}" style="font-weight: 700; font-size: 16px; color: #{stockTransactionsMBean.getStockStatusColor(product)};" />
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">T·ªìn t·ªëi thi·ªÉu</f:facet>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <h:inputText value="#{product.minStock}" 
                                                pt:placeholder="10"
                                                style="width: 60px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px;" />
                                    <h:commandButton value="üíæ" title="L∆∞u t·ªìn t·ªëi thi·ªÉu"
                                                    style="padding: 5px 8px; border: none; background: #28a745; color: white; border-radius: 4px; cursor: pointer;"
                                                    actionListener="#{stockTransactionsMBean.saveMinStock(product)}">
                                        <f:ajax execute="@form" render=":stockForm:stockWrapper :statsForm:statsWrapper :messages" />
                                    </h:commandButton>
                                </div>
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">Tr·∫°ng th√°i</f:facet>
                                <h:outputText value="#{stockTransactionsMBean.getStockStatus(product)}" 
                                             style="color: #{stockTransactionsMBean.getStockStatusColor(product)}; font-weight: 600;" />
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">Gi√° b√°n</f:facet>
                                #{stockTransactionsMBean.formatCurrency(product.unitPrice)}
                            </h:column>
                        </h:dataTable>
                        
                        <h:outputText value="üì≠ Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o" rendered="#{empty stockTransactionsMBean.pagedProductsWithStock}"
                                     style="display: block; text-align: center; padding: 30px; color: #666;" />
                        
                        <h:panelGroup rendered="#{not empty stockTransactionsMBean.pagedProductsWithStock}" layout="block" 
                                     style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                            <h:outputText value="Trang #{stockTransactionsMBean.stockCurrentPage} / #{stockTransactionsMBean.stockTotalPages}" style="color: #666;" />
                            <h:panelGroup>
                                <h:commandButton value="‚óÄÔ∏è" actionListener="#{stockTransactionsMBean.stockPreviousPage()}"
                                               disabled="#{stockTransactionsMBean.stockCurrentPage == 1}"
                                               style="padding: 6px 10px; border-radius: 4px; border: 1px solid #ddd; background: white; cursor: pointer; margin-right: 5px;">
                                    <f:ajax render="stockWrapper" />
                                </h:commandButton>
                                <h:commandButton value="‚ñ∂Ô∏è" actionListener="#{stockTransactionsMBean.stockNextPage()}"
                                               disabled="#{stockTransactionsMBean.stockCurrentPage == stockTransactionsMBean.stockTotalPages}"
                                               style="padding: 6px 10px; border-radius: 4px; border: 1px solid #ddd; background: white; cursor: pointer;">
                                    <f:ajax render="stockWrapper" />
                                </h:commandButton>
                            </h:panelGroup>
                        </h:panelGroup>
                    </h:panelGroup>
                </div>
            </h:form>
            
            <!-- L·ªäCH S·ª¨ NH·∫¨P/XU·∫§T KHO -->
            <h:form id="historyForm">
                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 20px 0; color: #2c3e50; border-bottom: 2px solid #3f72af; padding-bottom: 10px;">
                        üìú L·ªãch s·ª≠ nh·∫≠p/xu·∫•t kho
                    </h3>
                    
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                        <h:inputText id="historySearch" value="#{stockTransactionsMBean.historySearchKeyword}"
                                    pt:placeholder="üîç T√¨m theo s·∫£n ph·∫©m..."
                                    style="flex: 1; min-width: 200px; padding: 12px 16px; border-radius: 8px; border: 1px solid #ced4da;">
                            <f:ajax event="keyup" delay="300" listener="#{stockTransactionsMBean.searchHistory()}" render="historyWrapper" />
                        </h:inputText>
                        
                        <h:selectOneMenu id="historyFilter" value="#{stockTransactionsMBean.historyFilterType}"
                                        style="min-width: 150px; padding: 12px; border-radius: 8px; border: 1px solid #ced4da;">
                            <f:selectItem itemLabel="üìã T·∫•t c·∫£" itemValue="" />
                            <f:selectItem itemLabel="üì• Nh·∫≠p kho" itemValue="Import" />
                            <f:selectItem itemLabel="üì§ Xu·∫•t kho" itemValue="Export" />
                            <f:ajax event="change" listener="#{stockTransactionsMBean.searchHistory()}" render="historyWrapper" />
                        </h:selectOneMenu>
                    </div>
                    
                    <h:panelGroup id="historyWrapper">
                        <h:dataTable value="#{stockTransactionsMBean.pagedTransactionHistory}" var="trans" 
                                    styleClass="table table-striped" style="width: 100%;"
                                    rendered="#{not empty stockTransactionsMBean.pagedTransactionHistory}">
                            
                            <h:column>
                                <f:facet name="header">ID</f:facet>
                                #{trans.transactionID}
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">Lo·∫°i</f:facet>
                                <h:outputText value="#{stockTransactionsMBean.getTypeText(trans.type)}"
                                             style="color: #{stockTransactionsMBean.getTypeColor(trans.type)}; font-weight: 600;" />
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">S·∫£n ph·∫©m</f:facet>
                                #{trans.productID.name}
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">S·ªë l∆∞·ª£ng</f:facet>
                                <h:outputText value="#{trans.type == 'Import' ? '+' : '-'}#{trans.quantity}"
                                             style="font-weight: 700; color: #{trans.type == 'Import' ? '#28a745' : '#dc3545'};" />
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">Gi√° nh·∫≠p</f:facet>
                                <h:outputText value="#{stockTransactionsMBean.formatCurrency(trans.unitCost)}"
                                             rendered="#{trans.unitCost != null}" />
                                <h:outputText value="-" rendered="#{trans.unitCost == null}" />
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">Nh√† cung c·∫•p</f:facet>
                                #{trans.supplierID != null ? trans.supplierID.supplierName : '-'}
                            </h:column>
                            
                            <h:column>
                                <f:facet name="header">Ng√†y</f:facet>
                                #{stockTransactionsMBean.formatDate(trans.createdAt)}
                            </h:column>
                        </h:dataTable>
                        
                        <h:outputText value="üì≠ Ch∆∞a c√≥ giao d·ªãch n√†o" rendered="#{empty stockTransactionsMBean.pagedTransactionHistory}"
                                     style="display: block; text-align: center; padding: 30px; color: #666;" />
                        
                        <h:panelGroup rendered="#{not empty stockTransactionsMBean.pagedTransactionHistory}" layout="block"
                                     style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                            <h:outputText value="Trang #{stockTransactionsMBean.historyCurrentPage} / #{stockTransactionsMBean.historyTotalPages}" style="color: #666;" />
                            <h:panelGroup>
                                <h:commandButton value="‚óÄÔ∏è" actionListener="#{stockTransactionsMBean.historyPreviousPage()}"
                                               disabled="#{stockTransactionsMBean.historyCurrentPage == 1}"
                                               style="padding: 6px 10px; border-radius: 4px; border: 1px solid #ddd; background: white; cursor: pointer; margin-right: 5px;">
                                    <f:ajax render="historyWrapper" />
                                </h:commandButton>
                                <h:commandButton value="‚ñ∂Ô∏è" actionListener="#{stockTransactionsMBean.historyNextPage()}"
                                               disabled="#{stockTransactionsMBean.historyCurrentPage == stockTransactionsMBean.historyTotalPages}"
                                               style="padding: 6px 10px; border-radius: 4px; border: 1px solid #ddd; background: white; cursor: pointer;">
                                    <f:ajax render="historyWrapper" />
                                </h:commandButton>
                            </h:panelGroup>
                        </h:panelGroup>
                    </h:panelGroup>
                </div>
            </h:form>
            
            <!-- MODAL TH√äM GIAO D·ªäCH -->
            <h:form id="transactionForm">
                <h:panelGroup id="transactionFormModal">
                    <div id="transactionModalOverlay"
                         style="display: #{stockTransactionsMBean.showForm ? 'block' : 'none'}; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto;"
                         onclick="if(event.target === this) { hideModal(); }">
                        <div style="background: white; max-width: 550px; margin: 50px auto; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden;">
                            <div style="background: linear-gradient(135deg, #3f72af, #5a95cf); padding: 20px 25px; display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; color: white;">‚ûï Th√™m giao d·ªãch nh·∫≠p/xu·∫•t kho</h3>
                                <h:commandButton value="‚úï" actionListener="#{stockTransactionsMBean.cancelForm}"
                                                style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer;">
                                    <f:ajax render="transactionFormModal" onevent="function(data){if(data.status=='success'){hideModal();}}" />
                                </h:commandButton>
                            </div>
                            
                            <div style="padding: 25px;">
                                <div style="margin-bottom: 18px;">
                                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">üìã Lo·∫°i giao d·ªãch *</label>
                                    <h:selectOneMenu id="transactionType" value="#{stockTransactionsMBean.selected.type}" required="true"
                                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ced4da;">
                                        <f:selectItem itemLabel="üì• Nh·∫≠p kho (Import)" itemValue="Import" />
                                        <f:selectItem itemLabel="üì§ Xu·∫•t kho (Export)" itemValue="Export" />
                                        <f:ajax event="change" render="unitCostSection supplierSection" />
                                    </h:selectOneMenu>
                                </div>
                                
                                <div style="margin-bottom: 18px;">
                                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">üì¶ S·∫£n ph·∫©m *</label>
                                    <h:selectOneMenu id="product" value="#{stockTransactionsMBean.selectedProductId}" required="true"
                                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ced4da;">
                                        <f:selectItem itemLabel="-- Ch·ªçn s·∫£n ph·∫©m --" itemValue="" />
                                        <f:selectItems value="#{stockTransactionsMBean.allProducts}" var="p"
                                                      itemLabel="#{p.name}" itemValue="#{p.productID}" />
                                        <f:ajax event="change" listener="#{stockTransactionsMBean.loadSelectedProduct}" render="productInfoPanel minStockSection unitCostSection supplierSection" />
                                    </h:selectOneMenu>
                                    
                                    <h:panelGroup id="productInfoPanel">
                                        <h:panelGroup rendered="#{stockTransactionsMBean.selectedProduct != null}" layout="block"
                                                     style="margin-top: 10px; padding: 12px; background: #e8f4fd; border-radius: 8px; border-left: 4px solid #3f72af;">
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                                                <div>üìä T·ªìn kho: <strong style="color: #3f72af;">#{stockTransactionsMBean.selectedProduct.quantity}</strong></div>
                                                <div>üí∞ Gi√° b√°n: <strong style="color: #28a745;">#{stockTransactionsMBean.formatCurrency(stockTransactionsMBean.selectedProduct.unitPrice)}</strong></div>
                                                <div>üìã Tr·∫°ng th√°i: <strong style="color: #{stockTransactionsMBean.getStockStatusColor(stockTransactionsMBean.selectedProduct)};">#{stockTransactionsMBean.getStockStatus(stockTransactionsMBean.selectedProduct)}</strong></div>
                                            </div>
                                        </h:panelGroup>
                                    </h:panelGroup>
                                </div>
                                
                                <div style="margin-bottom: 18px;">
                                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">üî¢ S·ªë l∆∞·ª£ng *</label>
                                    <h:inputText id="quantity" value="#{stockTransactionsMBean.selected.quantity}" required="true"
                                                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ced4da;">
                                        <f:validateLongRange minimum="1" />
                                    </h:inputText>
                                    <div style="font-size: 11px; color: #666; margin-top: 4px;">S·ªë l∆∞·ª£ng nh·∫≠p/xu·∫•t</div>
                                </div>
                                
                                <h:panelGroup id="minStockSection">
                                    <h:panelGroup rendered="#{stockTransactionsMBean.selectedProduct != null}">
                                        <div style="margin-bottom: 18px;">
                                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">‚ö†Ô∏è T·ªìn t·ªëi thi·ªÉu</label>
                                            <h:inputText id="minStock" value="#{stockTransactionsMBean.selectedProduct.minStock}"
                                                        pt:placeholder="M·∫∑c ƒë·ªãnh: 10"
                                                        style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ced4da;">
                                                <f:validateLongRange minimum="0" />
                                            </h:inputText>
                                            <div style="font-size: 11px; color: #666; margin-top: 4px;">C·∫£nh b√°o khi t·ªìn kho th·∫•p h∆°n m·ª©c n√†y</div>
                                        </div>
                                    </h:panelGroup>
                                </h:panelGroup>
                                
                                <h:panelGroup id="unitCostSection">
                                    <h:panelGroup rendered="#{stockTransactionsMBean.selected.type == 'Import'}">
                                        <div style="margin-bottom: 18px;">
                                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">üí∞ Gi√° nh·∫≠p (VNƒê)</label>
                                            <h:inputText id="unitCost" value="#{stockTransactionsMBean.selected.unitCost}"
                                                        pt:placeholder="T·ª± ƒë·ªông l·∫•y t·ª´ l·∫ßn nh·∫≠p g·∫ßn nh·∫•t"
                                                        style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ced4da;">
                                                <f:validateLongRange minimum="0" />
                                            </h:inputText>
                                        </div>
                                    </h:panelGroup>
                                </h:panelGroup>
                                
                                <h:panelGroup id="supplierSection">
                                    <h:panelGroup rendered="#{stockTransactionsMBean.selected.type == 'Import'}">
                                        <div style="margin-bottom: 18px;">
                                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">üè¢ Nh√† cung c·∫•p</label>
                                            <h:selectOneMenu id="supplier" value="#{stockTransactionsMBean.selectedSupplierId}"
                                                            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ced4da;">
                                                <f:selectItem itemLabel="-- Ch·ªçn nh√† cung c·∫•p --" itemValue="" />
                                                <f:selectItems value="#{stockTransactionsMBean.allSuppliers}" var="s"
                                                              itemLabel="#{s.supplierName}" itemValue="#{s.supplierID}" />
                                            </h:selectOneMenu>
                                        </div>
                                    </h:panelGroup>
                                </h:panelGroup>
                                
                                <div style="margin-bottom: 18px;">
                                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">üìù Ghi ch√∫</label>
                                    <h:inputTextarea id="note" value="#{stockTransactionsMBean.selected.note}" rows="2"
                                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ced4da;" />
                                </div>
                                
                                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                                    <h:commandButton value="‚ùå H·ªßy" actionListener="#{stockTransactionsMBean.cancelForm}"
                                                    style="background: #6c757d; border: none; padding: 10px 20px; border-radius: 8px; color: white; cursor: pointer;">
                                        <f:ajax render="transactionFormModal" onevent="function(data){if(data.status=='success'){hideModal();}}" />
                                    </h:commandButton>
                                    <h:commandButton value="üíæ L∆∞u" actionListener="#{stockTransactionsMBean.save}"
                                                    style="background: linear-gradient(135deg, #28a745, #20c997); border: none; padding: 10px 20px; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                                        <f:ajax execute="@form" render="transactionFormModal :stockForm :historyForm :statsForm :messages"
                                                onevent="function(data){if(data.status=='success'){hideModal();}}" />
                                    </h:commandButton>
                                </div>
                            </div>
                        </div>
                    </div>
                </h:panelGroup>
            </h:form>
            
            <script type="text/javascript">
                function showModal(id) {
                    var el = document.getElementById(id);
                    if (el) { el.style.display = 'block'; document.body.style.overflow = 'hidden'; }
                }
                function hideModal() {
                    var el = document.getElementById('transactionModalOverlay');
                    if (el) { el.style.display = 'none'; document.body.style.overflow = 'auto'; }
                }
            </script>
            
            <style>
                .table { border-collapse: collapse; width: 100%; }
                .table th, .table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
                .table th { background: #3f72af; color: white; font-weight: 600; }
                .table tr:hover { background: #f8f9fa; }
            </style>
        </ui:define>
    </ui:composition>
</html>
